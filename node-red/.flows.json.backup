[{"id":"40eb88f7.f2b0c8","type":"tab","label":"Alexa","disabled":false,"info":""},{"id":"9bed5193.e06f9","type":"tab","label":"Office","disabled":false,"info":""},{"id":"d2cb442102b53dce","type":"tab","label":"Volvo XC60","disabled":false,"info":"","env":[]},{"id":"b0f7c8eb6f5588da","type":"tab","label":"Actionalable Notifcation Template","disabled":false,"info":"","env":[]},{"id":"47422e7d400b50f5","type":"tab","label":"Finance","disabled":false,"info":"","env":[]},{"id":"f887527c.ee532","type":"tab","label":"Switches","disabled":false,"info":""},{"id":"6a88055e.a0ae5c","type":"tab","label":"Climate","disabled":false,"info":""},{"id":"a8a94d13.5469f","type":"tab","label":"Lights","disabled":false,"info":""},{"id":"a0f75c9.32211a","type":"tab","label":"APIs","disabled":false,"info":""},{"id":"7e610978.1ec528","type":"tab","label":"Todoist","disabled":false,"info":""},{"id":"6bb54913.4b8c08","type":"tab","label":"Motion","disabled":false,"info":""},{"id":"7232e01d.add9e","type":"tab","label":"Devices","disabled":false,"info":""},{"id":"53c8d8b3.d233f8","type":"tab","label":"Time","disabled":false,"info":""},{"id":"78619586.97010c","type":"tab","label":"Doors and windows","disabled":false,"info":""},{"id":"89eaed19.74745","type":"tab","label":"Backup","disabled":false,"info":""},{"id":"fad5e040.09f7a","type":"tab","label":"Test","disabled":false,"info":""},{"id":"f2ad30b932f27004","type":"tab","label":"RescueTime","disabled":false,"info":"","env":[]},{"id":"a72488be11dba7f9","type":"tab","label":"Flow 2","disabled":false,"info":"","env":[]},{"id":"96dd39fdae667f20","type":"tab","label":"Actionalable Notifcation Template","disabled":false,"info":"","env":[]},{"id":"fc03161a.88a1f8","type":"subflow","name":"Low battery notification","info":"","category":"","in":[{"x":60,"y":180,"wires":[{"id":"351cbea6.bd9052"}]}],"out":[],"env":[{"name":"firehd","type":"json","value":"{\"power\":\"switch.power_3\"}"}],"color":"#DDAA99"},{"id":"3134fb52.d06d64","type":"subflow","name":"Alexa notification","info":"","category":"alexa","in":[{"x":40,"y":80,"wires":[{"id":"fb1b3a55.76c268"}]}],"out":[{"x":1040,"y":380,"wires":[{"id":"53b46935.d71e68","port":0},{"id":"a1005c6f.5ae15","port":0}]},{"x":480,"y":160,"wires":[{"id":"d75a513f.56eb3","port":1}]}],"env":[{"name":"shouldWhisper","type":"bool","value":"false","ui":{"icon":"font-awesome/fa-bell-slash-o","label":{"en-US":"Whisper"},"type":"checkbox"}},{"name":"broadcast","type":"bool","value":"false","ui":{"icon":"font-awesome/fa-bullhorn","label":{"en-US":"Broadcast"},"type":"checkbox"}},{"name":"message","type":"str","value":""},{"name":"volumeLevel","type":"num","value":"5","ui":{"type":"spinner","opts":{"min":1,"max":10}}},{"name":"only_on_occupied_rooms","type":"bool","value":"false","ui":{"label":{"en-US":"On occupied rooms"},"type":"checkbox"}},{"name":"office_echo_dot","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-dot-circle-o","label":{"en-US":"Office Echo Dot"},"type":"checkbox"}},{"name":"kitchen_echo_dot","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-dot-circle-o","label":{"en-US":"Kitchen Echo Dot"},"type":"checkbox"}},{"name":"hallway_echo_dot","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-dot-circle-o","label":{"en-US":"Hallway Echo Dot"},"type":"checkbox"}},{"name":"living_room_echo_dot","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-dot-circle-o","label":{"en-US":"Living Room Echo Dot"},"type":"checkbox"}},{"name":"bedroom_echo_dot","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-bed","label":{"en-US":"Bedroom Echo Dot"},"type":"checkbox"}},{"name":"bathroom_echo_dot","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-bath","label":{"en-US":"Bathroom Echo Dot"},"type":"checkbox"}},{"name":"sound","type":"str","value":"","ui":{"icon":"font-awesome/fa-bell-o","label":{"en-US":"bell"},"type":"select","opts":{"opts":[{"l":{"en-US":"N/A"},"v":""},{"l":{"en-US":"Bell"},"v":"bell_02"},{"l":{"en-US":"Buzzer"},"v":"buzzers_pistols_01"},{"l":{"en-US":"Church bell"},"v":"amzn_sfx_church_bell_1x_02"},{"l":{"en-US":"Doorbell 1"},"v":"amzn_sfx_doorbell_01"},{"l":{"en-US":"Doorbell 2"},"v":"amzn_sfx_doorbell_chime_01"},{"l":{"en-US":"Doorbell 3"},"v":"amzn_sfx_doorbell_chime_02"},{"l":{"en-US":"Christmas bells"},"v":"christmas_05"},{"l":{"en-US":"Halloween door"},"v":"horror_10"},{"l":{"en-US":"Air horn"},"v":"air_horn_03"},{"l":{"en-US":"Squeaky door"},"v":"squeaky_12"},{"l":{"en-US":"Clock"},"v":"clock_01"},{"l":{"en-US":"Trumpet"},"v":"amzn_sfx_trumpet_bugle_04"},{"l":{"en-US":"Cat"},"v":"amzn_sfx_cat_meow_1x_01"},{"l":{"en-US":"Dog"},"v":"amzn_sfx_dog_med_bark_1x_02"},{"l":{"en-US":"Lion"},"v":"amzn_sfx_lion_roar_02"},{"l":{"en-US":"Rooster"},"v":"amzn_sfx_rooster_crow_01"},{"l":{"en-US":"Wolf"},"v":"amzn_sfx_wolf_howl_02"},{"l":{"en-US":"Aircraft"},"v":"futuristic_10"},{"l":{"en-US":"Engines"},"v":"amzn_sfx_scifi_engines_on_02"},{"l":{"en-US":"Red Alert"},"v":"amzn_sfx_scifi_alarm_04"},{"l":{"en-US":"Shields"},"v":"amzn_sfx_scifi_sheilds_up_01"},{"l":{"en-US":"Sirens"},"v":"amzn_sfx_scifi_alarm_01"},{"l":{"en-US":"Zap"},"v":"zap_01"},{"l":{"en-US":"Applause"},"v":"amzn_sfx_crowd_applause_01"},{"l":{"en-US":"Cheer"},"v":"amzn_sfx_large_crowd_cheer_01"},{"l":{"en-US":"Spotify"},"v":"SPOTIFY"}]}}},{"name":"notify_laptop_browser","type":"bool","value":"false","ui":{"label":{"en-US":"Notify laptop browser"},"type":"checkbox"}},{"name":"notify_bogdan_phone","type":"bool","value":"false","ui":{"label":{"en-US":"Notify Bogdan's phone"},"type":"checkbox"}},{"name":"ignore_sleep_mode","type":"bool","value":"false","ui":{"label":{"en-US":"Ignore sleep mode"},"type":"checkbox"}}],"meta":{},"color":"#FFFFFF","icon":"node-red-contrib-alexa-home-skill/alexa.png"},{"id":"3251ae8.f170952","type":"subflow","name":"Turn on AC","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"6b29c71a.6893e8"}]}],"out":[{"x":420,"y":400,"wires":[{"id":"bfae08c2.6d4398","port":0}]}],"env":[{"name":"fan_mode","type":"str","value":"Turbo"},{"name":"hvac_mode","type":"str","value":"cool"},{"name":"swing_mode","type":"str","value":"Swing in full range"},{"name":"AC unit","type":"str","value":"","ui":{"icon":"font-awesome/fa-thermometer-4","label":{"en-US":"ac_entity"},"type":"select","opts":{"opts":[{"l":{"en-US":"Bedroom AC"},"v":"climate.bedroom_ac"},{"l":{"en-US":"Living room AC"},"v":"climate.living_room_ac"}]}}},{"name":"State","type":"bool","value":"true","ui":{"label":{"en-US":"On"},"type":"checkbox"}}],"color":"#DDAA99"},{"id":"89424b4c.e0c868","type":"subflow","name":"Restart AC","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"ea551a05.0d56e8"}]}],"out":[{"x":1300,"y":180,"wires":[]}],"env":[],"color":"#DDAA99"},{"id":"b6e164fe.1d31e8","type":"subflow","name":"Bogdan mobile notification","info":"","category":"","in":[{"x":100,"y":80,"wires":[{"id":"af896d84.97285"}]}],"out":[{"x":600,"y":80,"wires":[{"id":"fe75d18.e659d3","port":0}]}],"env":[{"name":"message","type":"str","value":""},{"name":"title","type":"str","value":""},{"name":"notificationUrl","type":"str","value":""},{"name":"notificationActions","type":"str","value":""}],"meta":{},"color":"#A5C13D","icon":"font-awesome/fa-mobile-phone"},{"id":"c28ba6b7.4557d8","type":"subflow","name":"Logbook","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"5593757e.842a8c"}]}],"out":[{"x":320,"y":80,"wires":[{"id":"5593757e.842a8c","port":0}]}],"env":[{"name":"name","type":"str","value":""},{"name":"message","type":"str","value":""},{"name":"domain","type":"str","value":""},{"name":"entity_id","type":"str","value":""}],"color":"#8A84FF","icon":"font-awesome/fa-book"},{"id":"d7bbbb62.ece328","type":"subflow","name":"Set family status","info":"","category":"","in":[{"x":0,"y":80,"wires":[{"id":"e4837567.050e38"}]}],"out":[],"env":[{"name":"status","type":"str","value":"","ui":{"icon":"font-awesome/fa-home","label":{"en-US":"Status"},"type":"select","opts":{"opts":[{"l":{"en-US":"Home"},"v":"Home"},{"l":{"en-US":"Away"},"v":"Away"},{"l":{"en-US":"Sleeping"},"v":"Sleeping"},{"l":{"en-US":"Vacation"},"v":"Vacation"}]}}}],"color":"#DDAA99"},{"id":"c1aa7598.d50e08","type":"subflow","name":"Notify on family status change","info":"","category":"","in":[{"x":40,"y":180,"wires":[{"id":"1075f16c.94a35f"}]}],"out":[],"env":[],"color":"#DDAA99"},{"id":"45600ca3.e7f3f4","type":"subflow","name":"Vacuum cleaner","info":"","category":"","in":[{"x":20,"y":100,"wires":[{"id":"20f662c3.cd648e"}]}],"out":[{"x":560,"y":160,"wires":[{"id":"5acc447a.f729ec","port":0}]}],"env":[{"name":"room","type":"str","value":"kids","ui":{"label":{"en-US":"Room"},"type":"select","opts":{"opts":[{"l":{"en-US":"Bedroom"},"v":"script.1584735991442"},{"l":{"en-US":"Kids room"},"v":"script.1584736170010"},{"l":{"en-US":"Hallway"},"v":"script.1584735527658"},{"l":{"en-US":"Kitchen"},"v":"script.1584737101724"},{"l":{"en-US":"Living room"},"v":"script.1584736860542"},{"l":{"en-US":"Bathroom"},"v":"script.1584737056612"},{"l":{"en-US":"Office"},"v":"script.office_cleanup"},{"l":{"en-US":"Apartment"},"v":"script.1584623199887"}]}}},{"name":"speed","type":"str","value":"Turbo","ui":{"label":{"en-US":"Speed"},"type":"select","opts":{"opts":[{"l":{"en-US":"Low"},"v":"Low"},{"l":{"en-US":"Turbo"},"v":"Turbo"},{"l":{"en-US":"Mop"},"v":"Gentle"}]}}}],"color":"#3FADFF","icon":"font-awesome/fa-binoculars"},{"id":"3c8ad50a.81cbba","type":"subflow","name":"Subflow 1","info":"","category":"","in":[{"x":-20,"y":80,"wires":[{"id":"6d65619b.8360a"}]}],"out":[],"env":[{"name":"message","type":"str","value":"Hello","ui":{"label":{"en-US":"Message"}}},{"name":"title","type":"str","value":"","ui":{"label":{"en-US":"Notification title"}}}],"color":"#DDAA99"},{"id":"7dcf56e8.1fad28","type":"subflow","name":"Standing up notification","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"9ae349a0.d3f3e8"},{"id":"6cb4f8ca.d30eb8"}]}],"out":[{"x":980,"y":60,"wires":[{"id":"6f3d816c.ebd4e","port":0}]}],"env":[],"color":"#3FADB5","icon":"font-awesome/fa-desktop","status":{"x":1000,"y":20,"wires":[{"id":"6f3d816c.ebd4e","port":0}]}},{"id":"e352e71e.cc0298","type":"subflow","name":"Handle productivity score change","info":"","category":"","in":[{"x":20,"y":200,"wires":[{"id":"e9e0e622.0d46b8"},{"id":"af9f6ef5.75e0c"}]}],"out":[{"x":1180,"y":180,"wires":[{"id":"c469ded7.924e7","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"7da5c521.7abcbc","type":"subflow","name":"Elena notification","info":"","category":"","in":[{"x":100,"y":120,"wires":[{"id":"e2c87b2e.88eb18"}]}],"out":[],"env":[],"color":"#DDAA99"},{"id":"fc1eaeb9.f5e16","type":"subflow","name":"Heating select","info":"","category":"","in":[{"x":40,"y":140,"wires":[{"id":"b829bc2.c56d44"},{"id":"a9b189bf.636638"}]}],"out":[{"x":1140,"y":160,"wires":[{"id":"719a26fa.c1a788","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"defed711.e14778","type":"subflow","name":"Uncomplete Todoist Task","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"d4c8169d.b09418"}]}],"out":[{"x":1000,"y":80,"wires":[{"id":"38f5cd3.4570132","port":0}]}],"env":[{"name":"taskId","type":"str","value":"","ui":{"label":{"en-US":"Task ID"}}}],"color":"#E24137","inputLabels":["Task ID"],"icon":"node-red/file-in.svg"},{"id":"7f445a94.cd19d4","type":"subflow","name":"Office monitor switch","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"93149fa2.69dea"},{"id":"665214be.0087bc"},{"id":"3c6da1f2.24622e"}]}],"out":[{"x":600,"y":40,"wires":[{"id":"3484275b.d398a8","port":0}]}],"env":[],"color":"#3FADB5","icon":"font-awesome/fa-camera-retro"},{"id":"6c1e9884.3e70a8","type":"subflow","name":"Update focus mode","info":"","category":"","in":[{"x":-20,"y":80,"wires":[{"id":"214803f9.c7d2cc"}]}],"out":[],"env":[],"color":"#DDAA99"},{"id":"1366240e.7be4ac","type":"subflow","name":"Start focus session","info":"","category":"","in":[{"x":-40,"y":80,"wires":[{"id":"91c2866f.1fe588"}]}],"out":[{"x":780,"y":20,"wires":[{"id":"55db41bb.efe0d","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"dc813b26.76fc98","type":"subflow","name":"Identify office person","info":"","category":"","in":[{"x":20,"y":160,"wires":[{"id":"9ac7f4c6.687b18"}]}],"out":[{"x":860,"y":140,"wires":[{"id":"5c452e3.e8d49d","port":0}]},{"x":860,"y":200,"wires":[{"id":"5c452e3.e8d49d","port":1}]}],"env":[],"color":"#DDAA99"},{"id":"49c5443a.0ad96c","type":"subflow","name":"Flash lights","info":"","category":"","in":[{"x":60,"y":100,"wires":[{"id":"4525fea0.6668c"},{"id":"3da311b8.7a447e"}]}],"out":[{"x":840,"y":80,"wires":[{"id":"f5a3d992.45c1d8","port":0}]}],"env":[{"name":"entity_id","type":"str","value":"","ui":{"label":{"en-US":"Light"},"type":"input","opts":{"types":["str"]}}},{"name":"color_name","type":"str","value":"","ui":{"label":{"en-US":"Color"},"type":"input","opts":{"types":["str"]}}}],"color":"#DDAA99"},{"id":"8501408e.93b69","type":"server","name":"Home Assistant","legacy":false,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true},{"id":"833384cc.3863e8","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#333333","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"1f7574fc.bef66b","type":"graphql-server","endpoint":"https://api.hashnode.com","name":"Hashnode API"},{"id":"f2c4d347.ff9bb","type":"tls-config","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"","verifyservercert":false},{"id":"2e31528c.f3973e","type":"server","name":"Home Assistant","addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true},{"id":"96e93471.18e0f8","type":"debug","z":"fc03161a.88a1f8","name":"Input SF","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":180,"y":80,"wires":[]},{"id":"351cbea6.bd9052","type":"switch","z":"fc03161a.88a1f8","name":"Check which device","property":"data.entity_id","propertyType":"msg","rules":[{"t":"eq","v":"sensor.s22ultra_battery_level","vt":"str"},{"t":"eq","v":"sensor.firehd_battery_level","vt":"str"},{"t":"eq","v":"sensor.elenas_iphone_battery_level","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":160,"y":300,"wires":[["efdfaa5.e69f958"],["6a12aeb0.1b978"],["1c05f3ce.8c7c3c"]]},{"id":"efdfaa5.e69f958","type":"switch","z":"fc03161a.88a1f8","name":"Set phone action","property":"payload","propertyType":"msg","rules":[{"t":"gte","v":"95","vt":"str"},{"t":"lte","v":"70","vt":"str"},{"t":"lte","v":"50","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":410,"y":140,"wires":[["3efd2d36.6c5e62"],["7e43ae9d.087e5"],["a68e4fbe.3c6cd"]]},{"id":"3efd2d36.6c5e62","type":"api-call-service","z":"fc03161a.88a1f8","name":"Turn off charging","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.office_desk_phone_charger","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":650,"y":40,"wires":[["bea73d36.fdc8e"]]},{"id":"7e43ae9d.087e5","type":"api-call-service","z":"fc03161a.88a1f8","name":"Turn on charging","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.office_desk_phone_charger","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":650,"y":120,"wires":[[]]},{"id":"a68e4fbe.3c6cd","type":"switch","z":"fc03161a.88a1f8","name":"","property":"discharge_notification_sent","propertyType":"flow","rules":[{"t":"neq","v":"true","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":610,"y":200,"wires":[["98f440b8.8d63f"]]},{"id":"83775848.0856a8","type":"change","z":"fc03161a.88a1f8","name":"","rules":[{"t":"set","p":"discharge_notification_sent","pt":"flow","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":120,"wires":[[]]},{"id":"bea73d36.fdc8e","type":"change","z":"fc03161a.88a1f8","name":"","rules":[{"t":"set","p":"discharge_notification_sent","pt":"flow","to":"false","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":20,"wires":[[]]},{"id":"6a12aeb0.1b978","type":"switch","z":"fc03161a.88a1f8","name":"Set tablet action","property":"payload","propertyType":"msg","rules":[{"t":"gte","v":"90","vt":"str"},{"t":"lte","v":"60","vt":"str"},{"t":"lte","v":"30","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":400,"y":300,"wires":[["7e08f755.fc1418"],["5566ec83.a417e4"],["57470327.9c9ecc"]]},{"id":"7e08f755.fc1418","type":"api-call-service","z":"fc03161a.88a1f8","name":"Turn off charging","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.tellur_plug","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":650,"y":260,"wires":[["4791e15b.e5e16"]]},{"id":"5566ec83.a417e4","type":"api-call-service","z":"fc03161a.88a1f8","name":"Turn on charging","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.tellur_plug","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":650,"y":320,"wires":[[]]},{"id":"57470327.9c9ecc","type":"switch","z":"fc03161a.88a1f8","name":"","property":"tablet_discharge_notification_sent","propertyType":"flow","rules":[{"t":"neq","v":"true","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":610,"y":380,"wires":[["5b03e09c.242ea"]]},{"id":"bd402ef7.01234","type":"change","z":"fc03161a.88a1f8","name":"","rules":[{"t":"set","p":"tablet_discharge_notification_sent","pt":"flow","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":340,"wires":[[]]},{"id":"4791e15b.e5e16","type":"change","z":"fc03161a.88a1f8","name":"","rules":[{"t":"set","p":"tablet_discharge_notification_sent","pt":"flow","to":"false","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":260,"wires":[[]]},{"id":"1c05f3ce.8c7c3c","type":"switch","z":"fc03161a.88a1f8","name":"Set iPhone action","property":"payload","propertyType":"msg","rules":[{"t":"gte","v":"90","vt":"str"},{"t":"lte","v":"30","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":540,"wires":[["19c74246.d69cbe"],["48774366.694e2c"]]},{"id":"e6aa2f7a.95761","type":"api-call-service","z":"fc03161a.88a1f8","name":"iPhone battery notification","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"notify","service":"mobile_app_elenas_iphone","entityId":"","data":"{\"message\":\"The battery is getting low\", \"title\":\"Incarca-ti telefonul...\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":790,"y":580,"wires":[["23f81267.81269e"]]},{"id":"48774366.694e2c","type":"switch","z":"fc03161a.88a1f8","name":"","property":"discharge_notification_sent","propertyType":"flow","rules":[{"t":"neq","v":"true","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":580,"wires":[["e6aa2f7a.95761"]]},{"id":"23f81267.81269e","type":"change","z":"fc03161a.88a1f8","name":"","rules":[{"t":"set","p":"iphone_discharge_notification_sent","pt":"flow","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":660,"wires":[[]]},{"id":"19c74246.d69cbe","type":"change","z":"fc03161a.88a1f8","name":"","rules":[{"t":"set","p":"iphone_discharge_notification_sent","pt":"flow","to":"false","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":520,"wires":[[]]},{"id":"98f440b8.8d63f","type":"subflow:b6e164fe.1d31e8","z":"fc03161a.88a1f8","name":"Bogdan's phone battery notification","env":[{"name":"message","value":"The battery for Bogdan's phone is getting low","type":"str"},{"name":"title","value":"Charge your phone","type":"str"}],"x":860,"y":200,"wires":[["83775848.0856a8"]]},{"id":"5b03e09c.242ea","type":"subflow:b6e164fe.1d31e8","z":"fc03161a.88a1f8","name":"Tablet battery notification","env":[{"name":"message","value":"The Fire HD battery is getting low","type":"str"},{"name":"title","value":"Charge your tablet","type":"str"}],"x":790,"y":420,"wires":[["bd402ef7.01234"]]},{"id":"53b46935.d71e68","type":"api-call-service","z":"3134fb52.d06d64","name":"Notify Alexa","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"notify","service":"alexa_media","entityId":"","data":"msg.body","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":910,"y":420,"wires":[["c982c3559fbb9820"]]},{"id":"fb1b3a55.76c268","type":"function","z":"3134fb52.d06d64","name":"Parse data","func":"const globalHomeAssistant = global.get('homeassistant');\nvar whisperModeOn = globalHomeAssistant.homeAssistant.states[\"input_boolean.alexa_global_whisper\"].state == \"true\";\nvar sleepModeOn = globalHomeAssistant.homeAssistant.states[\"input_boolean.sleep_mode\"].state == \"true\";\nvar ignoreSleepMode = env.get(\"broadcast\");\nsleepModeOn == sleepModeOn && globalHomeAssistant.homeAssistant.states[\"binary_sensor.bedroom_door\"].state == \"off\" && ignoreSleepMode == false;\n\nvar broadcast = env.get(\"broadcast\");\nvar shouldWhisper = env.get(\"shouldWhisper\");\nvar volumeLevel = env.get(\"volumeLevel\")/10;\n\nvar message = env.get(\"message\");\nif(!message){\n    message = msg.message || global.get('AlexaMessage');\n    if(!message){\n        return msg;\n    }\n    global.set(\"AlexaMessage\", \"\");\n}\nvar officeEchoDot = env.get(\"office_echo_dot\");\nvar bedroomEchoDot = env.get(\"bedroom_echo_dot\");\nvar livingRoomEchoDot = env.get(\"living_room_echo_dot\");\nvar hallwayEchoDot = env.get(\"hallway_echo_dot\");\nvar kitchenEchoDot = env.get(\"kitchen_echo_dot\");\nvar bathroomEchoDot = env.get(\"bathroom_echo_dot\");\nvar target = [];\nvar onlyOnOccupiedRooms = env.get(\"only_on_occupied_rooms\");\nif(onlyOnOccupiedRooms){\n    target.push(global.get(\"roomMotion1\"));\n    target.push(global.get(\"roomMotion2\"));\n    target.push(global.get(\"roomMotion3\"));\n    \n    node.warn(global.get(\"roomMotion1\"));\n    node.warn(global.get(\"roomMotion2\"));\n    node.warn(global.get(\"roomMotion3\"));\n}\nelse{\n    if(officeEchoDot){\n        target.push(\"media_player.office_echo_dot\");\n    }\n    if(bedroomEchoDot){\n        target.push(\"media_player.bedroom_echo_dot\");\n    }\n    if(livingRoomEchoDot){\n        target.push(\"media_player.living_room_echo_dot\");\n    }\n    if(hallwayEchoDot){\n        target.push(\"media_player.hallway_echo_dot\");\n    }\n    if(kitchenEchoDot){\n        target.push(\"media_player.kitchen_echo_dot\");\n    }\n    if(bathroomEchoDot){\n        target.push(\"media_player.bathroom_echo_dot\");\n    }\n}\nmsg.type = 'message';\nmsg.shouldWhisper = shouldWhisper || sleepModeOn;\nmsg.whisperModeOn = whisperModeOn;\n\nif(!volumeLevel)\n    volumeLevel = 0.5;\n\nmsg.volume_level = volumeLevel;\nmsg.entities = target.toString();\n\nif(env.get('sound')){\n    \n    msg.body = {\n        media_content_type: \"sound\",\n        media_content_id: env.get('sound'),\n        entity_id: msg.entities\n    };\n    msg.type = 'sound';\n    if(env.get('sound') == 'SPOTIFY'){\n        msg.body.media_content_type = \"SPOTIFY\";\n        msg.body.media_content_id = message;\n    }\n    return msg;\n}\nmsg.sound = null;\nmsg.body = {\n    message: message,\n    data: {\n        method: \"speak\"\n    }\n};\nmsg.clear_message = message;\nif(sleepModeOn){\n    msg.whisperModeOn = true;\n    msg.body.target = msg.body.target.filter(function(deviceName, index, arr){\n        return deviceName != \"media_player.bedroom_echo_dot\";});\n}\nif(whisperModeOn || shouldWhisper){\n    msg.body.message = \n    \"<amazon:effect name='whispered'>\" + message + \"</amazon:effect>\";\n}\nif(broadcast){\n    msg.body.data.type = \"announce\";\n}\nelse {\n    msg.body.data.type = \"tts\";\n}\n\nmsg.body.target = target;// env.get('target');\n\n\nmsg.notify_laptop_browser = env.get(\"notify_laptop_browser\");\nmsg.notify_bogdan_phone = env.get(\"notify_bogdan_phone\");\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":80,"wires":[["d75a513f.56eb3","b7b5ecde80f4c2bc"]]},{"id":"5706d812.7f7fe8","type":"api-current-state","z":"3134fb52.d06d64","name":"Alexa notifications","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":true,"entity_id":"input_boolean.alexa_notifications","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":610,"y":60,"wires":[["6b78bbb9.c45fc4"],[]]},{"id":"bcf435c2.c16718","type":"api-call-service","z":"3134fb52.d06d64","name":"Set volume","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"media_player","service":"volume_set","entityId":"","data":"{\"entity_id\": msg.entities,\t\"volume_level\": msg.volume_level}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":710,"y":280,"wires":[["7af3a656.b4cf98"]]},{"id":"a1005c6f.5ae15","type":"api-call-service","z":"3134fb52.d06d64","name":"Play sound","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"media_player","service":"play_media","entityId":"","data":"msg.body","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":910,"y":340,"wires":[["e211571808b2f932"]]},{"id":"7af3a656.b4cf98","type":"switch","z":"3134fb52.d06d64","name":"Play sound or message?","property":"type","propertyType":"msg","rules":[{"t":"eq","v":"sound","vt":"str"},{"t":"eq","v":"message","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":380,"wires":[["a1005c6f.5ae15"],["53b46935.d71e68"]]},{"id":"59cd2093.ef769","type":"function","z":"3134fb52.d06d64","name":"Get volume for each Alexa device","func":"const globalHomeAssistant = global.get('homeassistant');\n\nmsg.shouldChangeVolume = false;\nvar entities = msg.entities.split(\",\");\nfor (var i = 0; i < entities.length; i++) {\n    var volume = globalHomeAssistant.homeAssistant.states[entities[i]].attributes.volume_level;\n    if(volume != msg.volume_level){\n        msg.shouldChangeVolume = true;\n        return msg;\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":280,"wires":[["3e224e3a.9f4e42"]]},{"id":"3e224e3a.9f4e42","type":"switch","z":"3134fb52.d06d64","name":"Volume should be changed","property":"shouldChangeVolume","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":280,"wires":[["bcf435c2.c16718"],["7af3a656.b4cf98"]]},{"id":"d75a513f.56eb3","type":"switch","z":"3134fb52.d06d64","name":"Alexa message is valid","property":"body","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":60,"wires":[["5706d812.7f7fe8","fa7a1eb6.2fe58","6e1e814.3d83e8"],["b7b5ecde80f4c2bc"]]},{"id":"6b78bbb9.c45fc4","type":"api-current-state","z":"3134fb52.d06d64","name":"Sleep mode off","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"false","halt_if_type":"bool","halt_if_compare":"is","override_topic":true,"entity_id":"input_boolean.sleep_mode","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":820,"y":40,"wires":[["628c485b.28d6a8"],["5785342b2823fc41"]]},{"id":"628c485b.28d6a8","type":"api-current-state","z":"3134fb52.d06d64","name":"Guest mode off","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"false","halt_if_type":"bool","halt_if_compare":"is","override_topic":true,"entity_id":"input_boolean.guest_mode","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1000,"y":100,"wires":[["59cd2093.ef769"],["562d46a738a2458f"]]},{"id":"4303f007.d398d","type":"api-call-service","z":"3134fb52.d06d64","name":"Notify laptop","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"tts","service":"google_translate_say","entityId":"media_player.msi_browser","data":"{\"message\": msg.clear_message, \"language\":\"en\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":830,"y":140,"wires":[[]]},{"id":"fa7a1eb6.2fe58","type":"switch","z":"3134fb52.d06d64","name":"Notify laptop browser?","property":"notify_laptop_browser","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":120,"wires":[["4303f007.d398d"]]},{"id":"abc7e3e5.81d9f","type":"subflow:b6e164fe.1d31e8","z":"3134fb52.d06d64","name":"","env":[],"x":1260,"y":200,"wires":[[]]},{"id":"6e1e814.3d83e8","type":"switch","z":"3134fb52.d06d64","name":"Notify phone?","property":"notify_bogdan_phone","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":820,"y":200,"wires":[["fc2ae92e.233768"]]},{"id":"fc2ae92e.233768","type":"function","z":"3134fb52.d06d64","name":"Set notification data","func":"msg.message = msg.clear_message;\nmsg.title = 'Alexa notification';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1030,"y":200,"wires":[["abc7e3e5.81d9f"]]},{"id":"5785342b2823fc41","type":"debug","z":"3134fb52.d06d64","name":"Sleep mode","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1120,"y":20,"wires":[]},{"id":"562d46a738a2458f","type":"debug","z":"3134fb52.d06d64","name":"Guest mode","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1210,"y":120,"wires":[]},{"id":"e211571808b2f932","type":"debug","z":"3134fb52.d06d64","name":"Playing sound","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":1140,"y":320,"wires":[]},{"id":"c982c3559fbb9820","type":"debug","z":"3134fb52.d06d64","name":"Playing message","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1130,"y":480,"wires":[]},{"id":"b7b5ecde80f4c2bc","type":"debug","z":"3134fb52.d06d64","name":"Invalid message","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":290,"y":160,"wires":[]},{"id":"a29c048d.eabfa8","type":"api-call-service","z":"3251ae8.f170952","name":"Turn on AC","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"climate","service":"turn_on","entityId":"","data":"{\"entity_id\":$env('ac_entity')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":270,"y":180,"wires":[["8a770c7.6cb7ff"]]},{"id":"8a770c7.6cb7ff","type":"api-call-service","z":"3251ae8.f170952","name":"Set climate mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"climate","service":"set_hvac_mode","entityId":"","data":"{\"hvac_mode\":$env('hvac_mode'), \"entity_id\":$env('ac_entity')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":250,"y":280,"wires":[["78018ff3.e6241"]]},{"id":"78018ff3.e6241","type":"api-call-service","z":"3251ae8.f170952","name":"Set speed","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"climate","service":"set_fan_mode","entityId":"","data":"{\"fan_mode\":$env('fan_mode'), \"entity_id\":$env('ac_entity')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":280,"y":340,"wires":[["bfae08c2.6d4398"]]},{"id":"bfae08c2.6d4398","type":"api-call-service","z":"3251ae8.f170952","name":"Set swing mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"climate","service":"set_swing_mode","entityId":"","data":"{\"swing_mode\":$env('swing_mode'), \"entity_id\":$env('ac_entity')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":240,"y":420,"wires":[[]]},{"id":"d80ac34e.a821b","type":"subflow:89424b4c.e0c868","z":"3251ae8.f170952","name":"","env":[],"x":330,"y":40,"wires":[[]]},{"id":"6b29c71a.6893e8","type":"switch","z":"3251ae8.f170952","name":"Turn on?","property":"State","propertyType":"env","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":120,"y":100,"wires":[["a29c048d.eabfa8","99520de9.5f5ef"],["f1f325eb.f7f858","6e8b39a.40ec3c8"]]},{"id":"f1f325eb.f7f858","type":"api-call-service","z":"3251ae8.f170952","name":"Turn off AC","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"climate","service":"turn_off","entityId":"","data":"{\"entity_id\":$env('ac_entity')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":390,"y":80,"wires":[["6e8b39a.40ec3c8"]]},{"id":"99520de9.5f5ef","type":"debug","z":"3251ae8.f170952","name":"on","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":710,"y":160,"wires":[]},{"id":"6e8b39a.40ec3c8","type":"debug","z":"3251ae8.f170952","name":"off","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":710,"y":220,"wires":[]},{"id":"46ac6d88.8734c4","type":"api-call-service","z":"89424b4c.e0c868","name":"Switch AC power off","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.power_1","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":440,"y":340,"wires":[[]]},{"id":"d990678b.0b8978","type":"api-call-service","z":"89424b4c.e0c868","name":"Switch AC power on","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.power_1","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":960,"y":340,"wires":[["d633dc9e.9bdc6"]]},{"id":"d633dc9e.9bdc6","type":"debug","z":"89424b4c.e0c868","name":"Restarted AC","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1170,"y":480,"wires":[]},{"id":"ea551a05.0d56e8","type":"api-call-service","z":"89424b4c.e0c868","name":"Set fan mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"climate","service":"set_fan_mode","entityId":"climate.living_room_ac","data":"{\"fan_mode\":\"Auto\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":230,"y":40,"wires":[[]]},{"id":"fcb4da80.299688","type":"api-current-state","z":"89424b4c.e0c868","name":"Check fan mode","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.living_room_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":660,"y":60,"wires":[["17f5597c.4ee5c7"]]},{"id":"17f5597c.4ee5c7","type":"switch","z":"89424b4c.e0c868","name":"","property":"data.attributes.fan_mode","propertyType":"msg","rules":[{"t":"neq","v":"Auto","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":190,"y":340,"wires":[["46ac6d88.8734c4","89fb42c5.eb6df"]]},{"id":"89fb42c5.eb6df","type":"debug","z":"89424b4c.e0c868","name":"Switching AC power off","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":200,"y":480,"wires":[]},{"id":"fe75d18.e659d3","type":"api-call-service","z":"b6e164fe.1d31e8","name":"Send notification","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"notify","service":"mobile_app_s22ultra","entityId":"","data":"msg.data","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":430,"y":80,"wires":[[]]},{"id":"af896d84.97285","type":"function","z":"b6e164fe.1d31e8","name":"","func":"var message = env.get(\"message\") || msg.message || global.get('BogdanPhoneNotificationMessage');\nvar title = env.get(\"title\") || msg.title || global.get('BogdanPhoneNotificationTitle');\nvar notificationUrl = env.get(\"notificationUrl\") || msg.notificationUrl || global.get('BogdanPhoneNotificationUrl');\nvar actions = env.get(\"notificationActions\") || msg.notificationActions || global.get('BogdanPhoneNotificationActions');\n\nmsg.data = {\n    message,\n    title\n};\nif(notificationUrl){\n    msg.data.data = {\n        clickAction: notificationUrl\n    };\n}\nnode.warn(actions);\nif (actions){\n    msg.data.data = {\n        actions: actions\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":80,"wires":[["fe75d18.e659d3","67780e1d.47e76"]]},{"id":"67780e1d.47e76","type":"debug","z":"b6e164fe.1d31e8","name":"Notification data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":450,"y":140,"wires":[]},{"id":"5593757e.842a8c","type":"api-call-service","z":"c28ba6b7.4557d8","name":"Logbook","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"logbook","service":"log","entityId":"","data":"{\t    \"name\":$env('name'),\t    \"domain\":\"switch\",\t    \"message\":$env('message'),\t    \"entity_id\": $env('entity_id')\t}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":200,"y":80,"wires":[[]]},{"id":"e4837567.050e38","type":"api-call-service","z":"d7bbbb62.ece328","name":"Set family status","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.bujdea_family","data":"{\"option\": $env('status')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":240,"y":80,"wires":[[]]},{"id":"96cd7e30.f0404","type":"switch","z":"c1aa7598.d50e08","name":"Check status","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Home","vt":"str"},{"t":"eq","v":"Away","vt":"str"},{"t":"eq","v":"Sleeping","vt":"str"},{"t":"eq","v":"Vacation","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":610,"y":80,"wires":[["abe5b3c7.4cdeb"],["d623b861.b4dbf8"],["de709912.81fa08"],["d42ae7b9.1f5ab8"]]},{"id":"abe5b3c7.4cdeb","type":"subflow:b6e164fe.1d31e8","z":"c1aa7598.d50e08","name":"Home notification","env":[{"name":"message","value":"Family is home","type":"str"},{"name":"title","value":"Family status changed","type":"str"}],"x":930,"y":80,"wires":[[]]},{"id":"d623b861.b4dbf8","type":"subflow:b6e164fe.1d31e8","z":"c1aa7598.d50e08","name":"Away notification","env":[{"name":"message","value":"Family is away","type":"str"},{"name":"title","value":"Family status changed","type":"str"}],"x":930,"y":180,"wires":[[]]},{"id":"de709912.81fa08","type":"subflow:b6e164fe.1d31e8","z":"c1aa7598.d50e08","name":"Sleeping notification","env":[{"name":"message","value":"Family is sleeping ","type":"str"},{"name":"title","value":"Family status changed","type":"str"}],"x":960,"y":260,"wires":[[]]},{"id":"d42ae7b9.1f5ab8","type":"subflow:b6e164fe.1d31e8","z":"c1aa7598.d50e08","name":"Vacation notification","env":[{"name":"message","value":"Family is on vacation","type":"str"},{"name":"title","value":"Family status changed","type":"str"}],"x":920,"y":340,"wires":[[]]},{"id":"1075f16c.94a35f","type":"api-current-state","z":"c1aa7598.d50e08","name":"If notifications for family status are enabled","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.notify_family_status","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":190,"y":140,"wires":[["861090b4.80c69"],[]]},{"id":"861090b4.80c69","type":"api-current-state","z":"c1aa7598.d50e08","name":"Family status","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.bujdea_family","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":430,"y":80,"wires":[["96cd7e30.f0404"]]},{"id":"20f662c3.cd648e","type":"api-call-service","z":"45600ca3.e7f3f4","name":"Call the vacuum cleaner","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"homeassistant","service":"turn_on","entityId":"","data":"{\"entity_id\":$env('room')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":270,"y":180,"wires":[["5acc447a.f729ec"]]},{"id":"5acc447a.f729ec","type":"api-call-service","z":"45600ca3.e7f3f4","name":"Set speed","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"vacuum","service":"set_fan_speed","entityId":"vacuum.xiaomi_vacuum_cleaner","data":"{\"fan_speed\": $env('speed')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":420,"y":80,"wires":[["f80f9891.e69ce8"]]},{"id":"c212ee37.a0cb4","type":"function","z":"45600ca3.e7f3f4","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":210,"y":140,"wires":[[]]},{"id":"f80f9891.e69ce8","type":"debug","z":"45600ca3.e7f3f4","name":"speed","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"$env('speed')","targetType":"jsonata","statusVal":"","statusType":"auto","x":580,"y":60,"wires":[]},{"id":"8f27018e.a9918","type":"api-call-service","z":"3c8ad50a.81cbba","name":"Send notification","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"notify","service":"mobile_app_galaxy_s9","entityId":"","data":"{\"message\": $env('message'), \"title\": $env('title')}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":290,"y":320,"wires":[["3f0d3a2d.828456"]]},{"id":"6d65619b.8360a","type":"time-range-switch","z":"3c8ad50a.81cbba","name":"Is it between 10 PM and 8 AM?","lat":"","lon":"","startTime":"22:00","endTime":"08:00","startOffset":0,"endOffset":0,"x":210,"y":80,"wires":[["8f27018e.a9918","e8e555dc.a231e8"],[]]},{"id":"d710e0e9.281d9","type":"api-current-state","z":"3c8ad50a.81cbba","name":"Notifications are allowed","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":true,"entity_id":"input_boolean.","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":150,"y":160,"wires":[["8f27018e.a9918"],[]]},{"id":"e8e555dc.a231e8","type":"debug","z":"3c8ad50a.81cbba","name":"notification door","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":550,"y":100,"wires":[]},{"id":"3f0d3a2d.828456","type":"debug","z":"3c8ad50a.81cbba","name":"notification","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":530,"y":160,"wires":[]},{"id":"8020550b.a20e08","type":"subflow:3134fb52.d06d64","z":"7dcf56e8.1fad28","name":"Notify that stayed on the chair too long","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"Please get up, you've been standing in your chair for too long.","type":"str"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":390,"y":120,"wires":[["6f3d816c.ebd4e"],[]]},{"id":"9ae349a0.d3f3e8","type":"api-call-service","z":"7dcf56e8.1fad28","name":"Toggle the office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"flash\": \"short\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":230,"y":260,"wires":[[]]},{"id":"6f3d816c.ebd4e","type":"ha-wait-until","z":"7dcf56e8.1fad28","name":"Wait to go up for 5 minutes","server":"8501408e.93b69","outputs":2,"entityId":"binary_sensor.office_chair","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"5","timeoutType":"num","timeoutUnits":"minutes","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":640,"y":60,"wires":[[],["8add9111.84765","104947d1.cdc0e8"]]},{"id":"2898f35.739330c","type":"subflow:3134fb52.d06d64","z":"7dcf56e8.1fad28","name":"Remind me to stand up!","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"Please stand up!","type":"str"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":830,"y":320,"wires":[["6f3d816c.ebd4e"],[]]},{"id":"8add9111.84765","type":"subflow:c28ba6b7.4557d8","z":"7dcf56e8.1fad28","name":"Log Alexa message","env":[{"name":"name","value":"Notified to get up","type":"str"},{"name":"message","value":"Notified to get up","type":"str"},{"name":"domain","value":"sensor","type":"str"},{"name":"entity_id","value":"sensor.office_position","type":"str"}],"x":890,"y":20,"wires":[[]]},{"id":"104947d1.cdc0e8","type":"api-current-state","z":"7dcf56e8.1fad28","name":"If I am sitting down","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Sitting down","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.office_position","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":850,"y":140,"wires":[["6882622d.d8605c"],[]]},{"id":"6882622d.d8605c","type":"api-current-state","z":"7dcf56e8.1fad28","name":"If I am in the office","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Office","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"var.bogdan_location","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":850,"y":200,"wires":[["2898f35.739330c","9ae349a0.d3f3e8"],[]]},{"id":"6cb4f8ca.d30eb8","type":"api-current-state","z":"7dcf56e8.1fad28","name":"If I am sitting down","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Sitting down","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.office_position","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":210,"y":40,"wires":[["8020550b.a20e08"],[]]},{"id":"e9e0e622.0d46b8","type":"switch","z":"e352e71e.cc0298","name":"Productivity check","property":"scoreState","propertyType":"msg","rules":[{"t":"eq","v":"up","vt":"str"},{"t":"eq","v":"same","vt":"str"},{"t":"eq","v":"down","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":170,"y":200,"wires":[["35f0b042.97b87","6810eac4.83d424"],[],["a9d16f6.ff0a59"]]},{"id":"d534e249.3b253","type":"api-call-service","z":"e352e71e.cc0298","name":"Red light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"red\", \"transition\":2}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":280,"wires":[["37f30777.054ca8"]]},{"id":"a57b8e6d.88adf","type":"api-call-service","z":"e352e71e.cc0298","name":"Green light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"green\", \"transition\":1}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":630,"y":120,"wires":[["37f30777.054ca8"]]},{"id":"35f0b042.97b87","type":"subflow:c28ba6b7.4557d8","z":"e352e71e.cc0298","name":"Productivity increase","env":[{"name":"name","value":"Productivity","type":"str"},{"name":"message","value":"Productivity increasing","type":"str"},{"name":"domain","value":"input_number","type":"str"},{"name":"entity_id","value":"input_number.productivity_score_work_hours","type":"str"}],"x":420,"y":60,"wires":[[]]},{"id":"af9f6ef5.75e0c","type":"api-call-service","z":"e352e71e.cc0298","name":"Set productivity score","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_number","service":"set_value","entityId":"input_number.productivity_score_work_hours","data":"{\"value\": msg.productivity}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":180,"y":20,"wires":[[]]},{"id":"fa233ee0.b93fa","type":"subflow:c28ba6b7.4557d8","z":"e352e71e.cc0298","name":"Productivity decrease","env":[{"name":"name","value":"Productivity","type":"str"},{"name":"message","value":"Productivity decreasing","type":"str"},{"name":"domain","value":"input_number","type":"str"},{"name":"entity_id","value":"input_number.productivity_score_work_hours","type":"str"}],"x":420,"y":340,"wires":[["b313424a.09e77","1b30c357.8ed97d"]]},{"id":"c469ded7.924e7","type":"api-call-service","z":"e352e71e.cc0298","name":"Reset office light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"white\", \"transition\":5}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1040,"y":180,"wires":[[]]},{"id":"37f30777.054ca8","type":"delay","z":"e352e71e.cc0298","name":"Delay 5 seconds","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":830,"y":200,"wires":[["c469ded7.924e7"]]},{"id":"6810eac4.83d424","type":"api-current-state","z":"e352e71e.cc0298","name":"I am in the office","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Office","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.bogdan_location_dropdown","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":400,"y":160,"wires":[["a57b8e6d.88adf"],[]]},{"id":"a9d16f6.ff0a59","type":"api-current-state","z":"e352e71e.cc0298","name":"I am in the office","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Office","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.bogdan_location_dropdown","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":400,"y":240,"wires":[["d534e249.3b253"],[]]},{"id":"92242e86.2f281","type":"subflow:b6e164fe.1d31e8","z":"e352e71e.cc0298","name":"Notify that productivity decreases","env":[],"x":920,"y":340,"wires":[[]]},{"id":"b313424a.09e77","type":"change","z":"e352e71e.cc0298","name":"Set notification data","rules":[{"t":"set","p":"message","pt":"msg","to":"msg.notification","tot":"jsonata"},{"t":"set","p":"title","pt":"msg","to":"msg.notificationTitle","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":340,"wires":[["92242e86.2f281"]]},{"id":"96b83cf7.cde37","type":"subflow:1366240e.7be4ac","z":"e352e71e.cc0298","name":"","env":[],"x":1670,"y":400,"wires":[[]]},{"id":"ecd10276.2c529","type":"delay","z":"e352e71e.cc0298","name":"","pauseType":"delay","timeout":"60","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1480,"y":380,"wires":[["96b83cf7.cde37"]]},{"id":"b35e8a58.9883b8","type":"subflow:3134fb52.d06d64","z":"e352e71e.cc0298","name":"Focus mode starting notification","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"Focus mode starting in 1 minute","type":"str"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"},{"name":"notify_bogdan_phone","type":"bool","value":"true"}],"x":1250,"y":400,"wires":[["ecd10276.2c529"],[]]},{"id":"1b30c357.8ed97d","type":"api-current-state","z":"e352e71e.cc0298","name":"If I am in the office","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Office","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"var.bogdan_location","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":650,"y":400,"wires":[["3eaf300c.546f7"],[]]},{"id":"3eaf300c.546f7","type":"api-current-state","z":"e352e71e.cc0298","name":"If focus mode is not already started","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"var.focus_mode","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":920,"y":400,"wires":[["b35e8a58.9883b8"],[]]},{"id":"e2c87b2e.88eb18","type":"function","z":"7da5c521.7abcbc","name":"","func":"var message = env.get(\"message\") || msg.message || global.get('GalaxyS9Message');\nvar title = env.get(\"title\") || msg.title || global.get('GalaxyS9Title');\n\nmsg.data = {\n    message,\n    title\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":240,"y":120,"wires":[["fd382a89.afe538","2d42d466.37d12c"]]},{"id":"fd382a89.afe538","type":"debug","z":"7da5c521.7abcbc","name":"Notification data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":450,"y":180,"wires":[]},{"id":"2d42d466.37d12c","type":"api-call-service","z":"7da5c521.7abcbc","name":"iPhone notification","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"notify","service":"mobile_app_elenas_iphone","entityId":"","data":"msg.data","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":470,"y":60,"wires":[[]]},{"id":"6237b584.6ecbcc","type":"switch","z":"fc1eaeb9.f5e16","name":"Check option","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Off","vt":"str"},{"t":"eq","v":"30 minutes","vt":"str"},{"t":"eq","v":"1 hour","vt":"str"},{"t":"eq","v":"1.5 hours","vt":"str"},{"t":"eq","v":"2 hours","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":330,"y":140,"wires":[["90ec74dc.200a88"],["b7bff755.aaf1b8"],["4d84cf54.d36ba"],["9e83fe8.9d0d9"],["8cae5728.64e478"]]},{"id":"56790d4b.67c054","type":"delay","z":"fc1eaeb9.f5e16","name":"Wait 30 minutes","pauseType":"delay","timeout":"30","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":760,"y":80,"wires":[["719a26fa.c1a788"]]},{"id":"b56517b7.4c2758","type":"delay","z":"fc1eaeb9.f5e16","name":"Wait 1 hour","pauseType":"delay","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":750,"y":140,"wires":[["719a26fa.c1a788"]]},{"id":"4a008689.7aa818","type":"delay","z":"fc1eaeb9.f5e16","name":"Wait 1.5 hours","pauseType":"delay","timeout":"90","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":760,"y":200,"wires":[["719a26fa.c1a788"]]},{"id":"b7bff755.aaf1b8","type":"api-call-service","z":"fc1eaeb9.f5e16","name":"Turn on heating","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.heating","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":540,"y":80,"wires":[["56790d4b.67c054"]]},{"id":"4d84cf54.d36ba","type":"api-call-service","z":"fc1eaeb9.f5e16","name":"Turn on heating","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.heating","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":540,"y":140,"wires":[["b56517b7.4c2758"]]},{"id":"9e83fe8.9d0d9","type":"api-call-service","z":"fc1eaeb9.f5e16","name":"Turn on heating","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.heating","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":540,"y":200,"wires":[["4a008689.7aa818"]]},{"id":"585fca47.f81924","type":"delay","z":"fc1eaeb9.f5e16","name":"Wait 2 hours","pauseType":"delay","timeout":"2","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":750,"y":260,"wires":[["719a26fa.c1a788"]]},{"id":"8cae5728.64e478","type":"api-call-service","z":"fc1eaeb9.f5e16","name":"Turn on heating","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.heating","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":540,"y":260,"wires":[["585fca47.f81924"]]},{"id":"719a26fa.c1a788","type":"api-call-service","z":"fc1eaeb9.f5e16","name":"Turn off heating","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.heating","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1020,"y":160,"wires":[[]]},{"id":"90ec74dc.200a88","type":"api-call-service","z":"fc1eaeb9.f5e16","name":"Turn off heating","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.heating","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":540,"y":20,"wires":[[]]},{"id":"b829bc2.c56d44","type":"change","z":"fc1eaeb9.f5e16","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":210,"y":340,"wires":[["585fca47.f81924","4a008689.7aa818","b56517b7.4c2758","56790d4b.67c054"]]},{"id":"a9b189bf.636638","type":"delay","z":"fc1eaeb9.f5e16","name":"Wait 5 seconds","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":180,"y":60,"wires":[["6237b584.6ecbcc"]]},{"id":"d4c8169d.b09418","type":"function","z":"defed711.e14778","name":"Prepare Todoist Request","func":"msg.headers = {};\nmsg.method = \"POST\";\nmsg.url = \"https://api.todoist.com/sync/v8/sync\";\nvar taskId = env.get(\"taskId\");\nmsg.payload = \"token=\"+msg.token+\"&commands=%5B%7B%22type%22%3A%20%22item_uncomplete%22%2C%20%22uuid%22%3A%20%22\" +\n'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  }) + \"%22%2C%20%22args%22%3A%20%7B%22id%22%3A%20\" + taskId + \"%7D%7D%5D\"\nmsg.headers[\"content-type\"] = \"application/x-www-form-urlencoded\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":80,"wires":[["38f5cd3.4570132"]]},{"id":"38f5cd3.4570132","type":"http request","z":"defed711.e14778","name":"Make POST request towards Todoist","method":"use","ret":"txt","paytoqs":"body","url":"https://api.todoist.com/sync/v8/sync","tls":"","persist":false,"proxy":"","authType":"","x":790,"y":80,"wires":[[]]},{"id":"c0a966fb.32c8a8","type":"credentials","z":"defed711.e14778","name":"Set Todoist token","props":[{"value":"token","type":"msg"}],"x":200,"y":80,"wires":[[]]},{"id":"f977c6ad.e8f168","type":"api-call-service","z":"7f445a94.cd19d4","name":"Navigate to camera","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"browser_mod","service":"navigate","entityId":"","data":"{\"navigation_path\": \"/lovelace-personal/camera\",\"deviceID\":\"office-touchscreen\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":890,"y":40,"wires":[[]]},{"id":"1ed2b7e.c9ee648","type":"api-call-service","z":"7f445a94.cd19d4","name":"Navigate to personal dashboard","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"browser_mod","service":"navigate","entityId":"","data":"{\"navigation_path\": \"/lovelace-office/dashboard\",\"deviceID\":\"office-touchscreen\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":930,"y":100,"wires":[[]]},{"id":"a3fb7fd9.e552e","type":"switch","z":"7f445a94.cd19d4","name":"Check index","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":690,"y":80,"wires":[["f977c6ad.e8f168"],["1ed2b7e.c9ee648"],["3cc38bba.726e34"]]},{"id":"3484275b.d398a8","type":"counter","z":"7f445a94.cd19d4","name":"Increment index","init":"0","step":"1","lower":"0","upper":"2","mode":"increment","outputs":"1","x":440,"y":80,"wires":[["a3fb7fd9.e552e"]]},{"id":"3cc38bba.726e34","type":"change","z":"7f445a94.cd19d4","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":160,"wires":[["3484275b.d398a8"]]},{"id":"93149fa2.69dea","type":"api-call-service","z":"7f445a94.cd19d4","name":"Turn on screen","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_touchscreen","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":200,"y":80,"wires":[["3484275b.d398a8"]]},{"id":"163722e2.36952d","type":"api-call-service","z":"7f445a94.cd19d4","name":"Reload","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"browser_mod","service":"window_reload","entityId":"","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1100,"y":40,"wires":[[]]},{"id":"665214be.0087bc","type":"api-call-service","z":"7f445a94.cd19d4","name":"Turn on PI screen power","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_on","entityId":"switch.office_switch_3 ","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":230,"y":140,"wires":[[]]},{"id":"f280e244.e6b94","type":"api-call-service","z":"7f445a94.cd19d4","name":"Set my location to the office","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.bogdan_location","data":"{\"value\": \"Office\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":400,"y":220,"wires":[[]]},{"id":"3c6da1f2.24622e","type":"api-current-state","z":"7f445a94.cd19d4","name":"If I am home","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"person.bogdan_bujdea","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":170,"y":220,"wires":[["f280e244.e6b94"],[]]},{"id":"43531d4b.01f664","type":"api-call-service","z":"6c1e9884.3e70a8","name":"Set focus mode state","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.focus_mode","data":"{\"value\": msg.focus_mode}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1160,"y":80,"wires":[[]]},{"id":"30e23537.6b936a","type":"function","z":"6c1e9884.3e70a8","name":"Prepare Freedom schedules Request","func":"msg.headers = {};\nmsg.method = \"GET\";\nmsg.mode = \"cors\";\nmsg.credentials = \"include\";\nmsg.url = \"https://freedom.to/schedules/\";\nmsg.headers = {\n    \"accept\": \"application/json, */*; q=0.01\",\n    \"accept-language\": \"en-US,en;q=0.9,ro;q=0.8,it;q=0.7,mt;q=0.6,de;q=0.5\",\n    \"content-type\": \"application/json\",\n    \"if-none-match\": \"W/\\\"69fccce06f9c04422d5ff28537fbc0a0\\\"\",\n    \"sec-fetch-dest\": \"empty\",\n    \"sec-fetch-mode\": \"cors\",\n    \"sec-fetch-site\": \"same-origin\",\n    \"x-requested-with\": \"XMLHttpRequest\",\n    \"Cookie\": \"_ga=GA1.2.2010196714.1610050021; PHPSESSID=kp1jre3o7fjkh1cv43tgpjk79d; _gid=GA1.2.2115140793.1610995863; app_referrer=https://freedom.to/blog/8-website-blockers-for-studying-productivity-focus/; _gaexp=GAX1.2.LE_TIgYjSkCFZ-Txyt0qiw.18710.x666; intercom-id-f6jrsmcb=58104f42-77fb-40b4-b77b-47cdc6dd045c; utm_lt_source=pausepage; utm_source=pausepage; remember_token=6ef7cfeb1bab0b9654ceda509d0a543e190dae09; wisepops=%7B%22csd%22%3A1%2C%22popups%22%3A%7B%22174926%22%3A%7B%22dc%22%3A3%2C%22d%22%3A%222021-01-19T17%3A06%3A48.840Z%22%7D%2C%22184000%22%3A%7B%22dc%22%3A1%2C%22d%22%3A%222021-01-19T17%3A05%3A23.519Z%22%7D%2C%22189443%22%3A%7B%22dc%22%3A1%2C%22d%22%3A%222021-01-07T20%3A07%3A05.398Z%22%7D%7D%2C%22sub%22%3A0%2C%22ucrn%22%3A31%2C%22cid%22%3A%2236934%22%2C%22v%22%3A4%7D; _vagrant_session=eZ9tZak3Wb1zRF8HYiPZaC9ytb8uCFkzUqmJ1RhExxpSLiOBd0O3hVnYGPUHv8j1QqvP2VUT0rRII1yMozGQY%2FHAYrBIzNFSqculbLzLcK5dbYgCrLy0DrDTwdhMIp2C20Vq9lTZ%2Baxb4juZQ%2FY%3D--PsDruRVMlwslIx%2BC--KQYSC3s5BrundmaJr%2FQgGg%3D%3D; _dc_gtm_UA-58052768-1=1; _gat_UA-58052768-1=1; wisepops_visits=%5B%222021-01-19T17%3A12%3A44.991Z%22%2C%222021-01-19T17%3A09%3A14.552Z%22%2C%222021-01-19T17%3A04%3A48.451Z%22%2C%222021-01-07T20%3A07%3A02.391Z%22%5D; wisepops_session=%7B%22arrivalOnSite%22%3A%222021-01-19T17%3A12%3A44.991Z%22%2C%22mtime%22%3A%222021-01-19T17%3A12%3A44.993Z%22%2C%22pageviews%22%3A1%2C%22popups%22%3A%7B%22174926%22%3A4%2C%22184000%22%3A7%7D%2C%22bars%22%3A%7B%7D%2C%22countdowns%22%3A%7B%7D%2C%22src%22%3A%22https%3A%2F%2Fwww.google.com%2F%22%2C%22utm%22%3A%7B%7D%7D; intercom-session-f6jrsmcb=WW9hZytsajMyTGxFdTNnU2F1VjVBWWRRT21uS1oyUVV0VkkzbU1URzU1R255cHhibkxGelM4ZDBpbkxjazZzMy0tNzR4aHMzTFd5WkdmaStOTWhSRE45Zz09--3c0379b202dec1b26d9bd496f2afbf329538484c\"\n  };\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":80,"wires":[["83cdaff7.75642"]]},{"id":"83cdaff7.75642","type":"http request","z":"6c1e9884.3e70a8","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":630,"y":80,"wires":[["41a096f.677a268"]]},{"id":"41a096f.677a268","type":"function","z":"6c1e9884.3e70a8","name":"Find last started focus mode","func":"\nmsg.focus_mode = 'off';\nvar body = JSON.parse(msg.payload);\nif(body.schedule && body.schedule.length > 0){\n    if(body.schedule[0].active && body.schedule[0].time_left > 0){\n        msg.focus_mode = 'on';\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":880,"y":80,"wires":[["43531d4b.01f664"]]},{"id":"214803f9.c7d2cc","type":"credentials","z":"6c1e9884.3e70a8","name":"Set cookie","props":[{"value":"cookie","type":"msg"}],"x":110,"y":80,"wires":[["30e23537.6b936a"]]},{"id":"7356cf1d.6ce2d","type":"function","z":"1366240e.7be4ac","name":"Prepare Freedom start schedule Request","func":"msg.method = \"POST\";\nmsg.url = \"https://freedom.to/schedules/\";\nmsg.headers = {\n    \"accept\": \"*/*\",\n    \"accept-language\": \"en-US,en;q=0.9,ro;q=0.8,it;q=0.7,mt;q=0.6,de;q=0.5\",\n    \"cache-control\": \"no-cache\",\n    \"content-type\": \"application/json\",\n    \"pragma\": \"no-cache\",\n    \"sec-fetch-dest\": \"empty\",\n    \"sec-fetch-mode\": \"cors\",\n    \"sec-fetch-site\": \"same-origin\",\n    \"x-requested-with\": \"XMLHttpRequest\",\n    Cookie: msg.cookie\n\n  };\nmsg.payload = {\n\t\"filter_list_ids\": [2269332, 2269318],\n\t\"device_ids\": [1678226, 1674841, 1675113], //work, laptop, phone\n\t\"block_everything\": false,\n\t\"block_apps\": true,\n\t\"duration\": 60*20,\n\t\"start_time\": \"now\"\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":80,"wires":[["55db41bb.efe0d"]]},{"id":"55db41bb.efe0d","type":"http request","z":"1366240e.7be4ac","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":650,"y":80,"wires":[["1f724ea2.627601","665c969d.5ebdb8"]]},{"id":"cc080501.72a068","type":"api-call-service","z":"1366240e.7be4ac","name":"Set focus mode state","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.focus_mode","data":"{\"value\": \"on\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1120,"y":80,"wires":[[]]},{"id":"665c969d.5ebdb8","type":"switch","z":"1366240e.7be4ac","name":"If status code is 201","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"201","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":860,"y":80,"wires":[["cc080501.72a068"]]},{"id":"1f724ea2.627601","type":"debug","z":"1366240e.7be4ac","name":"Focus","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":810,"y":140,"wires":[]},{"id":"91c2866f.1fe588","type":"credentials","z":"1366240e.7be4ac","name":"Set Freedom cookie","props":[{"value":"cookie","type":"msg"}],"x":120,"y":80,"wires":[["7356cf1d.6ce2d"]]},{"id":"9946c8cf.e15928","type":"http request","z":"dc813b26.76fc98","name":"","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"f2c4d347.ff9bb","persist":false,"proxy":"","authType":"","x":430,"y":160,"wires":[["5c452e3.e8d49d","feac5093.cb356"]]},{"id":"9ac7f4c6.687b18","type":"function","z":"dc813b26.76fc98","name":"Prepare RPI4 Request","func":"msg.url = \"https://192.168.1.133:5003/facerecognition\";\nmsg.headers = {};\nmsg.method = \"GET\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":200,"y":160,"wires":[["9946c8cf.e15928"]]},{"id":"5c452e3.e8d49d","type":"switch","z":"dc813b26.76fc98","name":"Check if it's me","property":"payload.isMe","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":640,"y":160,"wires":[[],[]]},{"id":"feac5093.cb356","type":"debug","z":"dc813b26.76fc98","name":"Face API","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":640,"y":300,"wires":[]},{"id":"f5a3d992.45c1d8","type":"api-call-service","z":"49c5443a.0ad96c","name":"Flash lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"toggle","entityId":"","data":"{\"entity_id\": msg.entity_id}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":610,"y":60,"wires":[[]]},{"id":"4525fea0.6668c","type":"debug","z":"49c5443a.0ad96c","name":"lights","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":180,"y":160,"wires":[]},{"id":"4bb1ebf8.806d74","type":"api-call-service","z":"49c5443a.0ad96c","name":"Set color","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"color_name\":msg.color_name, \t\"transition\":0, \t\"entity_id\": msg.entity_id}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":300,"y":60,"wires":[[]]},{"id":"ba567a8b.07f9f8","type":"api-call-service","z":"49c5443a.0ad96c","name":"Set color","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\t\t\"color_name\": \"white\",\t\t\"transition\": 0,\t\t\"entity_id\": msg.entity_id\t}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":560,"y":120,"wires":[[]]},{"id":"3da311b8.7a447e","type":"function","z":"49c5443a.0ad96c","name":"Set color name","func":"msg.color_name = env.get('color_name');\nmsg.entity_id = env.get('entity_id');\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":120,"wires":[["4bb1ebf8.806d74"]]},{"id":"74dac1b5.52f84","type":"server-events","z":"40eb88f7.f2b0c8","name":"Alexa event","server":"8501408e.93b69","event_type":"alexa_actionable_notification","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"x":110,"y":120,"wires":[["aa554b7a.5d3f58"]]},{"id":"638c4b29.73b664","type":"api-call-service","z":"40eb88f7.f2b0c8","name":"Turn off all the lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"all","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":980,"y":60,"wires":[[]]},{"id":"aa554b7a.5d3f58","type":"switch","z":"40eb88f7.f2b0c8","name":"Switch event type","property":"payload.event.event_id","propertyType":"msg","rules":[{"t":"eq","v":"family_leaving_home","vt":"str"},{"t":"eq","v":"actionable_notification_office_summary","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":120,"wires":[["2dcfc3c8.ff7eec"],["dcbcf195.d37d2"]]},{"id":"2dcfc3c8.ff7eec","type":"switch","z":"40eb88f7.f2b0c8","name":"Leaving home","property":"payload.event.event_response","propertyType":"msg","rules":[{"t":"eq","v":"ResponseYes","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":700,"y":60,"wires":[["638c4b29.73b664"]]},{"id":"84215db4.30d2f","type":"subflow:3134fb52.d06d64","z":"40eb88f7.f2b0c8","name":"Speak in the office","env":[{"name":"message","value":"\"Congrats! Keep going!\"","type":"str"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":930,"y":1400,"wires":[[],[]]},{"id":"d7ce6815.70d918","type":"subflow:3134fb52.d06d64","z":"40eb88f7.f2b0c8","name":"Play Elena's song","env":[{"name":"message","value":"perfect fara tine","type":"str"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"sound","value":"SPOTIFY","type":"str"}],"x":570,"y":1480,"wires":[[],[]]},{"id":"16987e4c.ba1fa2","type":"subflow:3134fb52.d06d64","z":"40eb88f7.f2b0c8","name":"Play Fart","env":[{"name":"message","value":"fart by sebastian castro","type":"str"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"sound","value":"SPOTIFY","type":"str"}],"x":820,"y":1820,"wires":[[],[]]},{"id":"98ee295e.c427e8","type":"inject","z":"40eb88f7.f2b0c8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":370,"y":1480,"wires":[["d7ce6815.70d918"]]},{"id":"abb32b5a.3a6538","type":"inject","z":"40eb88f7.f2b0c8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":1580,"wires":[["65dd2593.8f6c5c"]]},{"id":"65dd2593.8f6c5c","type":"api-call-service","z":"40eb88f7.f2b0c8","name":"Summary of the day","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"script","service":"activate_alexa_actionable_notification","entityId":"","data":"{\"text\":\"Good morning Bogdan, do you want a summary of the day?\",\"event_id\":\"actionable_notification_office_summary\",\"alexa_device\":\"media_player.office_echo_dot\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":340,"y":1580,"wires":[[]]},{"id":"dcbcf195.d37d2","type":"switch","z":"40eb88f7.f2b0c8","name":"Summary of the day","property":"payload.event.event_response","propertyType":"msg","rules":[{"t":"eq","v":"ResponseYes","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":720,"y":180,"wires":[["7b4c1a07.fc3314"]]},{"id":"bde03367.3a281","type":"subflow:3134fb52.d06d64","z":"40eb88f7.f2b0c8","name":"Summary of the day","env":[{"name":"volumeLevel","value":"6","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":1200,"y":180,"wires":[[],[]]},{"id":"7b4c1a07.fc3314","type":"function","z":"40eb88f7.f2b0c8","name":"Retrieve summary","func":"const globalHomeAssistant = global.get('homeassistant');\nvar completedTasks = parseInt(globalHomeAssistant.homeAssistant.states[\"var.completed_tasks_today\"].state);\nvar remainingTasks = parseInt(globalHomeAssistant.homeAssistant.states[\"var.important_unfinished_today\"].state);\nvar co2Level = parseInt(globalHomeAssistant.homeAssistant.states[\"sensor.netatmo_indoor_co2\"].state);\nvar officeTemperature = parseInt(globalHomeAssistant.homeAssistant.states[\"sensor.office_temperature\"].state);\nvar productivityScore = parseInt(globalHomeAssistant.homeAssistant.states[\"sensor.productivity_score_work_hours\"].state);\nvar standingUpToday = parseInt(globalHomeAssistant.homeAssistant.states[\"sensor.standing_up_time_today\"].state);\n\n\n\nmsg.message = \"<s>You completed \" + completedTasks + \" tasks so far, and you have \" + remainingTasks + \" remaining tasks until the end of the day</s>\";\nvar emotion = \"\";\nif(productivityScore < 60){\n    emotion = \"disappointed\";\n}\nelse{\n        emotion = \"excited\";\n}\nemotion = \"excited\";\nmsg.message += \"<amazon:emotion name=\\\"\"+ emotion + \"\\\" intensity=\\\"high\\\"><s>Your productivity score is \" + productivityScore\n                + \", and so far you've been standing up \" + standingUpToday + \"% of the time</s></amazon:emotion>\";\n                \nmsg.message += \"<s>The office temperature is \" + officeTemperature + \" degrees Celsius</s>\";\n\nmsg.message += \"<amazon:emotion name=\\\"excited\\\" intensity=\\\"low\\\"><s>Have a nice day<break time=\\\"1s\\\"/> </s></amazon:emotion>\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":970,"y":180,"wires":[["bde03367.3a281"]]},{"id":"51522244.bc97ec","type":"subflow:3134fb52.d06d64","z":"40eb88f7.f2b0c8","name":"Summary of the day","env":[{"name":"message","value":"<amazon:domain name=\"news\">         Latest news: The conversational and news styles are now available for the Matthew or Joanna voices!     </amazon:domain>","type":"str"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":980,"y":1520,"wires":[[],[]]},{"id":"29469b1e.d8a0e4","type":"inject","z":"40eb88f7.f2b0c8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":740,"y":1520,"wires":[["51522244.bc97ec"]]},{"id":"52207751.7f55d8","type":"inject","z":"40eb88f7.f2b0c8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":940,"y":260,"wires":[["7b4c1a07.fc3314"]]},{"id":"e39dc584.ae5948","type":"server-state-changed","z":"40eb88f7.f2b0c8","name":"idle time","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.asuswork_system_idle_time","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":120,"y":280,"wires":[[]]},{"id":"f09fd10f70a5315a","type":"server-state-changed","z":"40eb88f7.f2b0c8","name":"Less than 100 watts for 1 minute","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.fridge_current_power","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"150","halt_if_type":"num","halt_if_compare":"lte","outputs":2,"output_only_on_state_change":true,"for":"15","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":200,"y":440,"wires":[["8dd430cb4f453e66"],["b927d24264e2f83f"]]},{"id":"0b01467ca6d9935b","type":"api-call-service","z":"40eb88f7.f2b0c8","name":"Switch AC off","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"toggle","entityId":"switch.office_ac_power_ir","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":810,"y":460,"wires":[[]]},{"id":"8dd430cb4f453e66","type":"debug","z":"40eb88f7.f2b0c8","name":"AC1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":440,"y":540,"wires":[]},{"id":"b927d24264e2f83f","type":"debug","z":"40eb88f7.f2b0c8","name":"AC2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":430,"y":600,"wires":[]},{"id":"2db56d30bf6d842e","type":"api-current-state","z":"40eb88f7.f2b0c8","name":"Higher than 5 watts","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"5","halt_if_type":"num","halt_if_compare":"gte","override_topic":false,"entity_id":"sensor.fridge_current_power","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":490,"y":440,"wires":[["0b01467ca6d9935b"],[]]},{"id":"133831a2.dd6ece","type":"inject","z":"9bed5193.e06f9","name":"At 10AM","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 22 * * 1,2,3,4,5,0","once":false,"onceDelay":0.1,"topic":"Alarm","payload":"","payloadType":"date","x":100,"y":2460,"wires":[["85de3981.0a8308","6cc827ba.4615f8"]]},{"id":"56ae1a5f.df22c4","type":"subflow:3134fb52.d06d64","z":"9bed5193.e06f9","name":"When did you eat?","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"When did you eat?","type":"str"},{"name":"volumeLevel","value":"4","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"}],"x":550,"y":2480,"wires":[[],[]]},{"id":"85de3981.0a8308","type":"subflow:b6e164fe.1d31e8","z":"9bed5193.e06f9","name":"Send Mobile Notification","env":[{"name":"message","value":"When did you eat?","type":"str"},{"name":"title","value":"Log IF","type":"str"}],"x":370,"y":2420,"wires":[[]]},{"id":"45d688ed.553ae8","type":"server-events","z":"9bed5193.e06f9","name":"Office tag scanned","server":"8501408e.93b69","event_type":"tag_scanned","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":113,"y":2317,"wires":[["97d42cee.9c06b"]]},{"id":"7870113b.5d19e","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on the laptop","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.msi_laptop, switch.laptop_power_switch","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":733,"y":2277,"wires":[[]]},{"id":"97d42cee.9c06b","type":"switch","z":"9bed5193.e06f9","name":"Check which tag was scanned","property":"payload.event.tag_id","propertyType":"msg","rules":[{"t":"eq","v":"b476095d-bf87-400c-bbd5-ae18871e5ec0","vt":"str"},{"t":"eq","v":"5889c6fc-aba9-49a4-b133-8ebf3148c1a6","vt":"str"},{"t":"eq","v":"a937d2a9-aa51-47d1-a7e9-44fdfd062764","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":393,"y":2317,"wires":[["7870113b.5d19e","d844b017.49f74"],["4d3332df.74a89c"],["362234aa.7dbf5c"]]},{"id":"4d3332df.74a89c","type":"api-call-service","z":"9bed5193.e06f9","name":"Toggle light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"toggle","entityId":"light.office_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":713,"y":2337,"wires":[[]]},{"id":"362234aa.7dbf5c","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on bedroom cleanup","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"script","service":"1584735991442","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":2387,"wires":[[]]},{"id":"d844b017.49f74","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on office switch","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.office_switch_usb","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":743,"y":2217,"wires":[[]]},{"id":"325207f8.bb8468","type":"server-state-changed","z":"9bed5193.e06f9","name":"Sitting down","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_chair","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":90,"y":1571,"wires":[["b45ba66f.fa4ce8"],["d56a7b18.c21db8"]]},{"id":"749371b0.6755d","type":"server-state-changed","z":"9bed5193.e06f9","name":"Office movement","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_motion_sensor","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":100,"y":1871,"wires":[["97c3f757.64df48","bf37d27f.29533"],["e28b01b4.d3633"]]},{"id":"97c3f757.64df48","type":"api-current-state","z":"9bed5193.e06f9","name":"If I am home","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"person.bogdan_bujdea","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":330,"y":1831,"wires":[["14059488.a7355b"],[]]},{"id":"bfeed4f.8afd028","type":"api-current-state","z":"9bed5193.e06f9","name":"If I am home","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"person.bogdan_bujdea","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":685,"y":2020,"wires":[["2cf90c39.b697f4"],["229dc9fe.68c456"]]},{"id":"2cf90c39.b697f4","type":"api-call-service","z":"9bed5193.e06f9","name":"Set my location to home","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.bogdan_location","data":"{\"value\": \"Home\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":905,"y":2000,"wires":[[]]},{"id":"f3d199a9.b90508","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on office switch","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.office_switch_usb","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1040,"y":1771,"wires":[[]]},{"id":"f7583eb.a5a31c","type":"time-range-switch","z":"9bed5193.e06f9","name":"Between 5-11 in the morning","lat":"","lon":"","startTime":"05:00","endTime":"11:00","startOffset":0,"endOffset":0,"x":820,"y":1831,"wires":[["f3d199a9.b90508","e1253ea5.9ee9"],[]]},{"id":"e1253ea5.9ee9","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on the laptop","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.office_switch_usb","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1030,"y":1891,"wires":[[]]},{"id":"bf37d27f.29533","type":"change","z":"9bed5193.e06f9","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":1887,"wires":[["e3570386.8a30d"]]},{"id":"e3570386.8a30d","type":"delay","z":"9bed5193.e06f9","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":515,"y":1920,"wires":[["bfeed4f.8afd028","57f67140.5e0e8","7fa490e.0e3a07"]]},{"id":"d56a7b18.c21db8","type":"change","z":"9bed5193.e06f9","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":265,"y":1607,"wires":[["b45ba66f.fa4ce8"]]},{"id":"b96345ee.d2cd78","type":"subflow:7dcf56e8.1fad28","z":"9bed5193.e06f9","name":"Tell me to get up","env":[],"x":1215,"y":1420,"wires":[["50542900.0f63a8"]]},{"id":"b45ba66f.fa4ce8","type":"delay","z":"9bed5193.e06f9","name":"Delay 10 seconds","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":385,"y":1547,"wires":[["dce49ed2.2af9c"]]},{"id":"32c94fa1.29253","type":"server-state-changed","z":"9bed5193.e06f9","name":"Standing up","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_chair","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":90,"y":1691,"wires":[["7738ca15.02a174"],["80ecac5f.f3344"]]},{"id":"80ecac5f.f3344","type":"change","z":"9bed5193.e06f9","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":250,"y":1731,"wires":[["374f7b0b.9e3404"]]},{"id":"374f7b0b.9e3404","type":"delay","z":"9bed5193.e06f9","name":"Delay 5 minute","pauseType":"delay","timeout":"3","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":480,"y":1731,"wires":[["ccc7b724.4074b8"]]},{"id":"ccc7b724.4074b8","type":"ha-fire-event","z":"9bed5193.e06f9","name":"Standing up event","server":"8501408e.93b69","event":"office-chair","data":"{\"position\":\"standing-up\"}","dataType":"json","x":710,"y":1691,"wires":[[]]},{"id":"d43a30b8.3c473","type":"ha-fire-event","z":"9bed5193.e06f9","name":"Sitting down event","server":"8501408e.93b69","event":"office-chair","data":"{\"position\":\"sitting-down\"}","dataType":"json","x":965,"y":1547,"wires":[[]]},{"id":"8d3b2ce0.3a47b","type":"server-events","z":"9bed5193.e06f9","name":"Office chair","server":"8501408e.93b69","event_type":"office-chair","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":90,"y":1431,"wires":[["64453239.da08bc"]]},{"id":"69a48f06.ae6f7","type":"change","z":"9bed5193.e06f9","name":"Set waiting state","rules":[{"t":"set","p":"waiting_to_get_up","pt":"flow","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":655,"y":1400,"wires":[["8aff92c4.fd7e"]]},{"id":"dce49ed2.2af9c","type":"switch","z":"9bed5193.e06f9","name":"Check if it's not already waiting","property":"waiting_to_get_up","propertyType":"flow","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":685,"y":1547,"wires":[["d43a30b8.3c473"]]},{"id":"e36da6fd.894b18","type":"change","z":"9bed5193.e06f9","name":"Reset waiting state","rules":[{"t":"set","p":"waiting_to_get_up","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":670,"y":1467,"wires":[["6de8ec68.560d04"]]},{"id":"8aff92c4.fd7e","type":"delay","z":"9bed5193.e06f9","name":"Delay 30 minutes","pauseType":"delay","timeout":"30","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1005,"y":1420,"wires":[["b96345ee.d2cd78"]]},{"id":"6de8ec68.560d04","type":"change","z":"9bed5193.e06f9","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":845,"y":1460,"wires":[["8aff92c4.fd7e"]]},{"id":"50542900.0f63a8","type":"change","z":"9bed5193.e06f9","name":"Reset waiting state","rules":[{"t":"set","p":"waiting_to_get_up","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1425,"y":1420,"wires":[[]]},{"id":"7316f5e1.aba05c","type":"inject","z":"9bed5193.e06f9","name":"Reset flow","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":910,"y":1691,"wires":[["ccda95f3.1d3cc8"]]},{"id":"ccda95f3.1d3cc8","type":"change","z":"9bed5193.e06f9","name":"Reset waiting state","rules":[{"t":"set","p":"waiting_to_get_up","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":1691,"wires":[[]]},{"id":"e28b01b4.d3633","type":"api-current-state","z":"9bed5193.e06f9","name":"If chair is occupied","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.office_chair","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":325,"y":1940,"wires":[[],["e3570386.8a30d"]]},{"id":"bf203bd3.928bd8","type":"function","z":"9bed5193.e06f9","name":"Prepare RescueTime Request","func":"var date = new Date();\nvar day = date.getDate();\nvar month = date.getMonth() + 1;\nvar year = date.getFullYear();\n\nmsg.url = \"https://www.rescuetime.com/widget_window/productivity\";\nmsg.headers = {};\nmsg.method = \"GET\";\nmsg.headers[\"Cookie\"] = msg.rescueTimeCookie;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":40,"wires":[["5d321576.6c160c"]]},{"id":"58f6f949.7cf218","type":"inject","z":"9bed5193.e06f9","name":"Every 1 minutes","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"300","crontab":"","once":true,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":130,"y":40,"wires":[[]]},{"id":"5d321576.6c160c","type":"http request","z":"9bed5193.e06f9","name":"Request","method":"use","ret":"txt","paytoqs":"body","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":true,"authType":"","senderr":false,"headers":[],"x":880,"y":40,"wires":[["7fab4ef5.5f952","e8559491.4ac488"]]},{"id":"7fab4ef5.5f952","type":"function","z":"9bed5193.e06f9","name":"Find productivity score","func":"const globalHomeAssistant = global.get('homeassistant');\nvar html = msg.payload;\nvar attributeName = \"efficiency_percent\";\nvar start = html.indexOf(attributeName);\nvar attr = html.substr(start + attributeName.length + 2, 5);\nmsg = {};\nmsg.attr = attr;\nmsg.start = start;\nmsg.productivity = parseInt(attr.replace(/\\\"/g, \"\").trim());\nvar previousScore = parseInt(globalHomeAssistant.homeAssistant.states[\"sensor.productivity_score\"].state);\nmsg.previousScore = previousScore;\nif (msg.previousScore < msg.productivity) {\n    msg.scoreState = \"up\";\n}\nelse if (msg.previousScore > msg.productivity) {\n    var diff = msg.previousScore - msg.productivity;\n    msg.notification = \"Your productivity score went down \";\n    msg.notification += diff;\n    if (diff == 1) {\n        msg.notification += \" point\";\n    }\n    else msg.notification += \" points\";\n    msg.notification += \" to \" + msg.productivity + \" percent\";\n    msg.scoreState = \"down\";\n    msg.notificationTitle = \"Productivity going down: \" + msg.productivity + \"%\";\n}\nelse msg.scoreState = \"same\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1080,"y":40,"wires":[["c9302770.3673f8","e8559491.4ac488","4dcbda6c.5753a4"]]},{"id":"14059488.a7355b","type":"api-call-service","z":"9bed5193.e06f9","name":"Set my location to the office","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.bogdan_location","data":"{\"value\": \"Office\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":560,"y":1831,"wires":[["f7583eb.a5a31c"]]},{"id":"b9dafcbe.0284b","type":"server-state-changed","z":"9bed5193.e06f9","name":"Check step count","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"var.bogdan_steps","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"num","halt_if_compare":"gte","outputs":1,"output_only_on_state_change":true,"x":95,"y":2180,"wires":[["537bb6af.d96758","68a09c0e.016d04"]]},{"id":"537bb6af.d96758","type":"api-current-state","z":"9bed5193.e06f9","name":"If I'm AFK","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"AFK","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.office_position","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":295,"y":2140,"wires":[["bfeed4f.8afd028","6b8e5642.3656f8"],["83098c1f.1933"]]},{"id":"83098c1f.1933","type":"api-current-state","z":"9bed5193.e06f9","name":"No motion detected","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.office_motion_sensor","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":525,"y":2140,"wires":[["bfeed4f.8afd028"],[]]},{"id":"229dc9fe.68c456","type":"api-call-service","z":"9bed5193.e06f9","name":"Set my location to away","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.bogdan_location","data":"{\"value\": \"Away\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":905,"y":2060,"wires":[[]]},{"id":"68a09c0e.016d04","type":"subflow:c28ba6b7.4557d8","z":"9bed5193.e06f9","name":"Log steps","env":[{"name":"name","value":"New step count","type":"str"},{"name":"message","value":"Step count updated","type":"str"},{"name":"domain","value":"var","type":"str"},{"name":"entity_id","value":"var.bogdan_steps","type":"str"}],"x":295,"y":2220,"wires":[[]]},{"id":"6b8e5642.3656f8","type":"subflow:c28ba6b7.4557d8","z":"9bed5193.e06f9","name":"Log Bogdan's location","env":[{"name":"name","value":"Bogdan location","type":"str"},{"name":"message","value":"Bogdan's location updated","type":"str"},{"name":"domain","value":"var","type":"str"},{"name":"entity_id","value":"var.bogdan_location","type":"str"}],"x":375,"y":2060,"wires":[[]]},{"id":"98727f75.46a51","type":"api-current-state","z":"9bed5193.e06f9","name":"If I am standing up","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Standing up","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.office_position","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":490,"y":1671,"wires":[["ccc7b724.4074b8"],[]]},{"id":"7738ca15.02a174","type":"delay","z":"9bed5193.e06f9","name":"Delay 1 minute","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":280,"y":1671,"wires":[["98727f75.46a51"]]},{"id":"11822f37.24c901","type":"switch","z":"9bed5193.e06f9","name":"Chair state","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Sitting down","vt":"str"},{"t":"eq","v":"AFK","vt":"str"},{"t":"eq","v":"Standing up","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":450,"y":1431,"wires":[["69a48f06.ae6f7"],["e36da6fd.894b18"],["e36da6fd.894b18"]]},{"id":"64453239.da08bc","type":"api-current-state","z":"9bed5193.e06f9","name":"If I am sitting down","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.office_position","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":270,"y":1431,"wires":[["11822f37.24c901"]]},{"id":"bd86bcfb.dae3b","type":"inject","z":"9bed5193.e06f9","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":95,"y":1820,"wires":[["97c3f757.64df48"]]},{"id":"57f67140.5e0e8","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn off office lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"turn_off","entityId":"group.office_lights","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":725,"y":1900,"wires":[[]]},{"id":"8ae1b146.e5176","type":"server-state-changed","z":"9bed5193.e06f9","name":"Bogdan left the office","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"var.bogdan_location","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"Office","halt_if_type":"str","halt_if_compare":"is_not","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":100,"y":2807,"wires":[["5220cddd.f19704"],["b94e31ac.5ef88"]]},{"id":"6cc827ba.4615f8","type":"api-current-state","z":"9bed5193.e06f9","name":"If I am in the office","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Office","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"var.bogdan_location","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":310,"y":2480,"wires":[["56ae1a5f.df22c4"],[]]},{"id":"60f60309.143c6c","type":"api-current-state","z":"9bed5193.e06f9","name":"If I am sitting down","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Sitting down","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.office_position","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1270,"y":620,"wires":[["96b8cd5c.9bb3e"],[]]},{"id":"6180146e.fee8ac","type":"server-state-changed","z":"9bed5193.e06f9","name":"Standing up today changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.standing_up_time_today","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":135,"y":640,"wires":[["8bc0866b.149038"]]},{"id":"8bc0866b.149038","type":"switch","z":"9bed5193.e06f9","name":"Standing up less than 55% of the time today","property":"payload","propertyType":"msg","rules":[{"t":"lte","v":"55","vt":"str"},{"t":"gt","v":"55","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":485,"y":640,"wires":[["cdf1de80.daf0e"],["a5ba9bbc.512208"]]},{"id":"cdf1de80.daf0e","type":"switch","z":"9bed5193.e06f9","name":"Notify ","property":"stand_up_notification_sent","propertyType":"flow","rules":[{"t":"false"},{"t":"null"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":3,"x":810,"y":620,"wires":[["da161697.77cac8"],["da161697.77cac8"],["da161697.77cac8"]]},{"id":"da161697.77cac8","type":"change","z":"9bed5193.e06f9","name":"Set notification to true","rules":[{"t":"set","p":"stand_up_notification_sent","pt":"flow","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1040,"y":620,"wires":[["60f60309.143c6c"]]},{"id":"a5ba9bbc.512208","type":"change","z":"9bed5193.e06f9","name":"Set notification to false","rules":[{"t":"set","p":"stand_up_notification_sent","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":680,"wires":[[]]},{"id":"96b8cd5c.9bb3e","type":"subflow:3134fb52.d06d64","z":"9bed5193.e06f9","name":"Notify that I'm staying on the chair too long","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"Please get up from your chair!","type":"str"},{"name":"volumeLevel","value":"6","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":1370,"y":500,"wires":[[],[]]},{"id":"5ef6161.9657ae8","type":"inject","z":"9bed5193.e06f9","name":"At midnight","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"Alarm","payload":"","payloadType":"date","x":125,"y":3620,"wires":[["4063c.02b2d9c5"]]},{"id":"4063c.02b2d9c5","type":"api-call-service","z":"9bed5193.e06f9","name":"Update sensors","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.standing_up_day_1, sensor.standing_up_day_2, sensor.standing_up_day_3, sensor.standing_up_day_4, sensor.standing_up_day_5, sensor.standing_up_day_6","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":375,"y":3600,"wires":[[]]},{"id":"3f66014e.ca0e9e","type":"inject","z":"9bed5193.e06f9","name":"Every 1 minutes","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"60","crontab":"","once":true,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":130,"y":220,"wires":[[]]},{"id":"f6945728.5491d8","type":"subflow:6c1e9884.3e70a8","z":"9bed5193.e06f9","name":"Update focus mode","env":[],"x":350,"y":220,"wires":[]},{"id":"61279a16.7c72a4","type":"function","z":"9bed5193.e06f9","name":"Find productivity score","func":"const globalHomeAssistant = global.get('homeassistant');\nmsg.productivity = msg.payload.productivityScore;\nvar previousScore = parseInt(globalHomeAssistant.homeAssistant.states[\"sensor.productivity_score_work_hours\"].state);\nmsg.previousScore = previousScore;\nif(msg.previousScore < msg.productivity){\n    msg.scoreState = \"up\";\n}\nelse if(msg.previousScore > msg.productivity){\n    var diff = msg.previousScore - msg.productivity;\n    msg.notification = \"Your productivity score went down \";\n    msg.notification += diff;\n    if(diff == 1){\n        msg.notification += \" point\";\n    }\n    else msg.notification += \" points\";\n    msg.notification += \" to \" + msg.productivity + \" percent\";\n    if(msg.previousScore - msg.productivity > 1)\n        msg.scoreState = \"down\";\n    msg.notificationTitle = \"Productivity going down: \" + msg.productivity + \"%\";\n}\nelse msg.scoreState = \"same\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1080,"y":140,"wires":[["4dcbda6c.5753a4"]]},{"id":"193ef3b2.902f6c","type":"http request","z":"9bed5193.e06f9","name":"Request","method":"use","ret":"obj","paytoqs":"body","url":"","tls":"","persist":false,"proxy":"","authType":"","x":880,"y":140,"wires":[["61279a16.7c72a4","e8559491.4ac488"]]},{"id":"4dcbda6c.5753a4","type":"subflow:e352e71e.cc0298","z":"9bed5193.e06f9","name":"Handle productivity score change","env":[],"x":1400,"y":140,"wires":[[]]},{"id":"2f922cf7.9ecc54","type":"function","z":"9bed5193.e06f9","name":"Prepare productivity request","func":"msg.url = \"http://192.168.1.133:5000/api/productivity\";\nmsg.headers = {};\nmsg.method = \"GET\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":140,"wires":[["193ef3b2.902f6c"]]},{"id":"a50be190.6bda9","type":"inject","z":"9bed5193.e06f9","name":"Every 1 minutes","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"300","crontab":"","once":true,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":130,"y":140,"wires":[[]]},{"id":"bcbd0ae4.72fad8","type":"time-range-switch","z":"9bed5193.e06f9","name":"Between 8-20","lat":"","lon":"","startTime":"08:00","endTime":"20:00","startOffset":0,"endOffset":0,"x":360,"y":140,"wires":[["2f922cf7.9ecc54"],[]]},{"id":"c9302770.3673f8","type":"api-call-service","z":"9bed5193.e06f9","name":"Set productivity score","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_number","service":"set_value","entityId":"input_number.productivity_score","data":"{\"value\": msg.productivity}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1360,"y":40,"wires":[[]]},{"id":"5220cddd.f19704","type":"delay","z":"9bed5193.e06f9","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":2747,"wires":[["9de0d41a.506458"]]},{"id":"b94e31ac.5ef88","type":"change","z":"9bed5193.e06f9","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":2827,"wires":[["5220cddd.f19704","88e22e5a.eae33","cf8a9e92.c5d25"]]},{"id":"9de0d41a.506458","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn off PI screen power","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_off","entityId":"switch.office_switch_3 ","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":670,"y":2747,"wires":[[]]},{"id":"88e22e5a.eae33","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on PI screen power","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_on","entityId":"switch.office_switch_3 ","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":550,"y":2827,"wires":[["f2d3144f.284d78"]]},{"id":"3a3c8479.e0703c","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn off screensaver","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_off","entityId":"switch.office_pi_screensaver","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":520,"y":2640,"wires":[[]]},{"id":"cf8a9e92.c5d25","type":"api-call-service","z":"9bed5193.e06f9","name":"Refresh HA","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"browser_mod","service":"window_reload","entityId":"","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":510,"y":2887,"wires":[[]]},{"id":"7fa490e.0e3a07","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn off PI screen power","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_off","entityId":"switch.office_switch_3 ","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":750,"y":1960,"wires":[[]]},{"id":"e638be83.aa219","type":"credentials","z":"9bed5193.e06f9","name":"Set cookie","props":[{"value":"rescueTimeCookie","type":"msg"}],"x":370,"y":40,"wires":[["bf203bd3.928bd8"]]},{"id":"e8559491.4ac488","type":"debug","z":"9bed5193.e06f9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1090,"y":200,"wires":[]},{"id":"e5474e23.c4ce8","type":"server-state-changed","z":"9bed5193.e06f9","name":"Office door","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":120,"y":460,"wires":[["849d274b.461408"]]},{"id":"8dab9174.eebaa","type":"debug","z":"9bed5193.e06f9","name":"Face detection","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":880,"y":540,"wires":[]},{"id":"5d29e06c.2cecf","type":"subflow:dc813b26.76fc98","z":"9bed5193.e06f9","name":"Check if it's me in the office","env":[],"x":620,"y":460,"wires":[["8dab9174.eebaa","67963b40.4e4814","59d82776.4cbd08"],[]]},{"id":"7cd18f59.2a5a9","type":"api-call-service","z":"9bed5193.e06f9","name":"Summary of the day","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"script","service":"activate_alexa_actionable_notification","entityId":"","data":"{\"text\":\"Good morning Bogdan, do you want a summary of the day?\",\"event_id\":\"actionable_notification_office_summary\",\"alexa_device\":\"media_player.office_echo_dot\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":900,"y":420,"wires":[[]]},{"id":"849d274b.461408","type":"time-range-switch","z":"9bed5193.e06f9","name":"Between 5-12","lat":"","lon":"","startTime":"05:00","endTime":"15:00","startOffset":0,"endOffset":0,"x":320,"y":460,"wires":[["5d29e06c.2cecf"],[]]},{"id":"67963b40.4e4814","type":"api-call-service","z":"9bed5193.e06f9","name":"Wake Laptop","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"wake_on_lan","service":"send_magic_packet","entityId":"","data":"{\"mac\": \"30-9C-23-91-FF-D1\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":870,"y":340,"wires":[[]]},{"id":"59d82776.4cbd08","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"brightness\":155, \"transition\": 1}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":920,"y":280,"wires":[[]]},{"id":"43363cfb.ad48c4","type":"ha-webhook","z":"9bed5193.e06f9","name":"Deployment success","server":"8501408e.93b69","outputs":1,"webhookId":"QRnox0utHykqLnRyXjPrRaIOPVj2mBcs","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"headers","headersLocationType":"msg","x":150,"y":860,"wires":[["7ab957d2.fd2a38"]]},{"id":"505e01a6.76095","type":"ha-webhook","z":"9bed5193.e06f9","name":"Deployment fail","server":"8501408e.93b69","outputs":1,"webhookId":"QRnox0utHykqLnRyXjPrRaIOPVj2mBcs","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"","headersLocationType":"none","x":155,"y":1033,"wires":[["bd76b4ce.082c28"]]},{"id":"7ab957d2.fd2a38","type":"api-call-service","z":"9bed5193.e06f9","name":"Green light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\":\"green\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":370,"y":860,"wires":[["f487ee49.b1512","8bb7735c.443da"]]},{"id":"bf6d6d2b.54eef","type":"api-call-service","z":"9bed5193.e06f9","name":"Reset office light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"white\", \"transition\":5}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1355,"y":853,"wires":[[]]},{"id":"64f96542.f5818c","type":"delay","z":"9bed5193.e06f9","name":"Delay 15 seconds","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1125,"y":853,"wires":[["bf6d6d2b.54eef"]]},{"id":"bd76b4ce.082c28","type":"api-call-service","z":"9bed5193.e06f9","name":"Red light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"red\", \"transition\":0}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":375,"y":1033,"wires":[["61e504b7.f4049c","e73e8e41.a6628"]]},{"id":"c1e19e31.1a65","type":"api-call-service","z":"9bed5193.e06f9","name":"Reset office light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"white\", \"transition\":5}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1155,"y":1033,"wires":[[]]},{"id":"11b4f4db.360bbb","type":"api-call-service","z":"9bed5193.e06f9","name":"Green light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"green\",\"flash\":\"long\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":765,"y":853,"wires":[["64f96542.f5818c"]]},{"id":"f487ee49.b1512","type":"delay","z":"9bed5193.e06f9","name":"Delay 1 second","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":575,"y":853,"wires":[["11b4f4db.360bbb"]]},{"id":"9c52d4f3.2726a8","type":"api-call-service","z":"9bed5193.e06f9","name":"Red light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"red\", \"flash\": \"long\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":755,"y":1033,"wires":[["a61d399d.ea5198"]]},{"id":"a61d399d.ea5198","type":"delay","z":"9bed5193.e06f9","name":"Delay 5 seconds","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":955,"y":1033,"wires":[["c1e19e31.1a65"]]},{"id":"61e504b7.f4049c","type":"delay","z":"9bed5193.e06f9","name":"Delay 1 second","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":575,"y":1033,"wires":[["9c52d4f3.2726a8"]]},{"id":"e73e8e41.a6628","type":"subflow:3134fb52.d06d64","z":"9bed5193.e06f9","name":"Alarm","env":[{"name":"volumeLevel","value":"3","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"sound","value":"amzn_sfx_scifi_alarm_04","type":"str"}],"x":615,"y":1113,"wires":[["c16e148f.aa4c38"],[]]},{"id":"c16e148f.aa4c38","type":"subflow:3134fb52.d06d64","z":"9bed5193.e06f9","name":"Notify build failed","env":[{"name":"broadcast","type":"bool","value":"true"},{"name":"message","value":"<amazon:emotion name=\"disappointed\" intensity=\"high\">The build has failed </amazon:emotion>","type":"str"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":845,"y":1113,"wires":[[],[]]},{"id":"8bb7735c.443da","type":"subflow:3134fb52.d06d64","z":"9bed5193.e06f9","name":"Notify build succeeded","env":[{"name":"broadcast","type":"bool","value":"true"},{"name":"message","value":"<amazon:emotion name=\"excited\" intensity=\"high\">The build has succeeded</amazon:emotion>","type":"str"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":615,"y":933,"wires":[[],[]]},{"id":"c1530ca9.d70f4","type":"inject","z":"9bed5193.e06f9","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":580,"y":320,"wires":[["7cd18f59.2a5a9"]]},{"id":"62dab599.e075dc","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on PI screen power","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.office_switch_3 ","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":370,"y":1780,"wires":[[]]},{"id":"8e53ff39.a71af","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn on PI screen","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"light","service":"turn_on","entityId":"light.office_touchscreen","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":970,"y":2720,"wires":[[]]},{"id":"4e030b70.4c1214","type":"inject","z":"9bed5193.e06f9","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":210,"y":2640,"wires":[["3a3c8479.e0703c"]]},{"id":"f2d3144f.284d78","type":"api-call-service","z":"9bed5193.e06f9","name":"Turn off screensaver","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_off","entityId":"switch.office_pi_screensaver","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":800,"y":2820,"wires":[[]]},{"id":"adcdc9f7.a82398","type":"inject","z":"9bed5193.e06f9","name":"At 1PM","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"59 15 * * 1,2,3,4,5","once":false,"onceDelay":0.1,"topic":"Alarm","payload":"","payloadType":"date","x":100,"y":2520,"wires":[[]]},{"id":"2d6fb0b5.7a71c","type":"inject","z":"9bed5193.e06f9","name":"Every work hour","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"0 10-16 * * 1,2,3,4,5","once":false,"onceDelay":0.1,"topic":"Alarm","payload":"","payloadType":"date","x":290,"y":2580,"wires":[["28bff8b1.767218"]]},{"id":"28bff8b1.767218","type":"api-current-state","z":"9bed5193.e06f9","name":"If I am in the office","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Office","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"var.bogdan_location","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":530,"y":2560,"wires":[["d1dec761.5762b8"],[]]},{"id":"d1dec761.5762b8","type":"subflow:49c5443a.0ad96c","z":"9bed5193.e06f9","name":"Office lights flash","env":[{"name":"entity_id","value":"light.office_lightstrip","type":"str"},{"name":"color_name","value":"blue","type":"str"}],"x":770,"y":2560,"wires":[[]]},{"id":"e62d7df1fc1e2ee0","type":"server-state-changed","z":"d2cb442102b53dce","name":"Front left door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_door_front_left","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":120,"y":40,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"71b0d972cd5c3353","type":"server-state-changed","z":"d2cb442102b53dce","name":"Front right door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_door_front_right","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":120,"y":100,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"6589f93e0826ae45","type":"server-state-changed","z":"d2cb442102b53dce","name":"Rear left door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_door_rear_left","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":120,"y":160,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"1c44dcea8b685fee","type":"server-state-changed","z":"d2cb442102b53dce","name":"Rear right door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_door_rear_right","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":120,"y":220,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"24a06175b03daee2","type":"server-state-changed","z":"d2cb442102b53dce","name":"Tailgate opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_tailgate","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":100,"y":280,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"bc6280919623783e","type":"server-state-changed","z":"d2cb442102b53dce","name":"Front left window opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_window_front_left","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":130,"y":340,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"83bac681c2358ecd","type":"server-state-changed","z":"d2cb442102b53dce","name":"Front right window opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_window_front_right","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":130,"y":400,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"b9890b1efab48689","type":"server-state-changed","z":"d2cb442102b53dce","name":"Rear left window opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_window_rear_left","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":130,"y":460,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"d45c3c30ef756b13","type":"server-state-changed","z":"d2cb442102b53dce","name":"Rear right window opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_xc60_yv1uzh5v4p1357593_window_rear_right","entityidfiltertype":"exact","outputinitially":true,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":130,"y":520,"wires":[["490f62a0dd2ce9b7"],[]]},{"id":"490f62a0dd2ce9b7","type":"api-current-state","z":"d2cb442102b53dce","name":"Volvo alarm is on","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.volvo_xc60_alarm","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":490,"y":260,"wires":[["baa1909d630bb402"],[]]},{"id":"77922bd19e8167fb","type":"subflow:b6e164fe.1d31e8","z":"d2cb442102b53dce","name":"Notify car breach","x":1390,"y":260,"wires":[[]]},{"id":"e811dfe4d2b352fe","type":"switch","z":"d2cb442102b53dce","name":"If should notify","property":"shouldNotify","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1100,"y":260,"wires":[["77922bd19e8167fb"]]},{"id":"baa1909d630bb402","type":"function","z":"d2cb442102b53dce","name":"Set notification","func":"const globalHomeAssistant = global.get('homeassistant');\n\nvar carEntity = globalHomeAssistant.homeAssistant.states[msg.topic];\n\nmsg.message = carEntity.attributes.friendly_name + \" is opened\";\nmsg.title = \"Volvo alarm triggered\";\nmsg.shouldNotify = false;\nvar alarmBooleanEntity = globalHomeAssistant.homeAssistant.states[msg.topic];\nif(alarmBooleanEntity.state === \"on\" && carEntity.state == \"on\"){\n    msg.shouldNotify = true;\n}\nmsg.notificationUrl = \"/lovelace-personal/mobile-car\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":260,"wires":[["e811dfe4d2b352fe"]]},{"id":"8919b7521d257d7d","type":"server-state-changed","z":"d2cb442102b53dce","name":"Battery level changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.volvo_xc60_battery_charge_level","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":140,"y":1720,"wires":[["76395e229c98a020"]]},{"id":"f1852d997f11b1fd","type":"api-call-service","z":"d2cb442102b53dce","name":"Set km at last charge","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_odometer_at_last_charge","data":"{\"value\": msg.payload}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":960,"y":1680,"wires":[["e30c962b577b8d9a"]]},{"id":"76395e229c98a020","type":"switch","z":"d2cb442102b53dce","name":"Check battery level","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"100","vt":"num"},{"t":"lt","v":"5","vt":"num"},{"t":"lte","v":"60","vt":"num"}],"checkall":"true","repair":false,"outputs":3,"x":370,"y":1720,"wires":[["b4811fcd6141b4b2"],["8db4ed2d25cb7ced"],["607fd79eaafa3c62"]]},{"id":"8db4ed2d25cb7ced","type":"api-call-service","z":"d2cb442102b53dce","name":"Set full discharge time","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_last_battery_discharge","data":"{\"value\": msg.data.new_state.last_changed}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":700,"y":1740,"wires":[[]]},{"id":"c9c0026d793f3f84","type":"server-state-changed","z":"d2cb442102b53dce","name":"Tank fill","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.volvo_xc60_yv1uzh5v4p1357593_fuel_level","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"71","halt_if_type":"num","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":90,"y":1820,"wires":[[],[]]},{"id":"4d76230cd2394d9a","type":"function","z":"d2cb442102b53dce","name":"Set finished trip details","func":"const globalHomeAssistant = global.get('homeassistant');\n\nvar startTripKm = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_start_trip_km\"].state);\nvar geocodedLocation = globalHomeAssistant.homeAssistant.states[\"sensor.volvo_geocoded_location\"].state;\nvar startTripBattery = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_start_trip_battery\"].state);\nvar startTripFuel = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_start_trip_fuel\"].state);\nvar totalBatteryConsumption = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_total_battery_consumption\"].state);\n\nvar endTripKm = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_odometer\"].state);\nvar endTripBattery = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_battery_charge_level\"].state);\nvar endTripFuel = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_fuel_level\"].state);\n\nvar km = endTripKm - startTripKm;\nvar battery = endTripBattery - startTripBattery;\nvar fuel = parseFloat((endTripFuel - startTripFuel).toFixed(2));\nfuel*=-1;\nbattery*=-1;\nif (fuel < 0 || km < 30){\n    fuel = 0;\n}\nif(battery < 0){\n    battery = 0;\n}\n\n// start\nmsg.startTripKm = startTripKm;\nmsg.startTripBattery = startTripBattery;\nmsg.startTripFuel = startTripFuel;\n\n// end\nmsg.endTripKm = endTripKm;\nmsg.endTripBattery = endTripBattery;\nmsg.endTripFuel = endTripFuel;\n\n// end - start\nmsg.km = km;\nmsg.battery = battery;\nmsg.fuel = fuel;\n\n\nmsg.currentFuelLevel = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_fuel_level\"].state);\nmsg.fuelAtLastCharge = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_fuel_at_last_charge\"].state);\nmsg.current_odometer_value = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_odometer\"].state);\nmsg.odometer_at_last_charge = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_odometer_at_last_charge\"].state);\nmsg.last_battery_charge_level = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_last_battery_charge_level\"].state);\nmsg.last_refuel_price_per_liter = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_last_refuel_price_per_liter\"].state);\n\nmsg.fuel_consumed = msg.currentFuelLevel - msg.fuelAtLastCharge;\nmsg.totalDistance = msg.current_odometer_value - msg.odometer_at_last_charge;\nmsg.fuelCost = msg.fuel_consumed * msg.last_refuel_price_per_liter;\nif (msg.fuel_consumed < 0) {\n    msg.fuel_consumed = 0;\n    msg.fuelCost = 0;\n}\nvar kwhUsed = (msg.last_battery_charge_level - endTripBattery) * 18.8 / 100;\nmsg.energyCost = kwhUsed * 1;\nmsg.totalCost = msg.fuelCost + msg.energyCost;\nif (msg.totalDistance > 0) {\n    msg.pricePerKmSinceLastCharge = msg.totalCost / msg.totalDistance;\n}\nelse {\n    msg.pricePerKmSinceLastCharge = 0;\n}\n\nvar last_refuel_price_per_liter = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_last_refuel_price_per_liter\"].state);\nvar fuelCost = fuel * last_refuel_price_per_liter;\nvar kwhUsedInLastTrip = battery * 18.8 / 100;\nvar energyCost = kwhUsedInLastTrip * 1;\nmsg.costForLastTrip = fuelCost + energyCost;\nmsg.totalBatteryConsumption += kwhUsedInLastTrip;\n\n\nmsg.title = msg.km + \"km trip finished!\"\nmsg.message = \"Battery: \" + msg.battery + \"%, fuel: \" + msg.fuel + \"L, total cost: \" + msg.costForLastTrip + \"RON\" + \", energy cost: \" + energyCost + \" RON\";\nmsg.notificationUrl = \"/lovelace-personal/mobile-car\";\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":960,"wires":[["ffc2550bfc51c841","4353a38174d59f72","1b2b17e2f93a225c","0ba5ee048e516461","f3b95fb3c5b430ef","b56ef04d9754e252","9f243285571b1c1e","738d3252d73f3a91","d99412927d8fe96c","31afff54eb06b307"]]},{"id":"ffc2550bfc51c841","type":"api-call-service","z":"d2cb442102b53dce","name":"Set km after trip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_last_trip_km","data":"{\"value\": msg.km}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":600,"y":740,"wires":[[]]},{"id":"1b2b17e2f93a225c","type":"api-call-service","z":"d2cb442102b53dce","name":"Set battery after trip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_last_trip_battery","data":"{\"value\": msg.battery}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":610,"y":860,"wires":[[]]},{"id":"4353a38174d59f72","type":"api-call-service","z":"d2cb442102b53dce","name":"Set fuel after trip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_last_trip_fuel","data":"{\"value\": msg.fuel}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":600,"y":800,"wires":[[]]},{"id":"30172fe3c0b432b8","type":"api-call-service","z":"d2cb442102b53dce","name":"Set odometer start value","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_start_trip_km","data":"{\"value\": msg.currentOdometer}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":630,"y":1320,"wires":[[]]},{"id":"5c48918270516617","type":"api-call-service","z":"d2cb442102b53dce","name":"Set battery start value","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_start_trip_battery","data":"{\"value\": msg.currentBattery}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":620,"y":1400,"wires":[[]]},{"id":"8b282b77933472aa","type":"api-call-service","z":"d2cb442102b53dce","name":"Set start trip fuel value","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_start_trip_fuel","data":"{\"value\": msg.currentFuel}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":620,"y":1480,"wires":[[]]},{"id":"db3d9398d2acc50f","type":"link in","z":"d2cb442102b53dce","name":"Finish trip","links":["fd2cff91c184540b"],"x":80,"y":960,"wires":[["4d76230cd2394d9a"]],"l":true},{"id":"fd2cff91c184540b","type":"link out","z":"d2cb442102b53dce","name":"Finshed a trip","mode":"link","links":["db3d9398d2acc50f"],"x":2300,"y":1340,"wires":[],"icon":"font-awesome/fa-flag-checkered","l":true},{"id":"72ea9ce4726072c1","type":"link in","z":"d2cb442102b53dce","name":"Start new trip","links":["cd324c555a042a7b","edec506eeda08966"],"x":90,"y":1460,"wires":[["3b34c8222bff5a60"]],"l":true},{"id":"cd324c555a042a7b","type":"link out","z":"d2cb442102b53dce","name":"Starting a new trip","mode":"link","links":["72ea9ce4726072c1"],"x":1750,"y":1040,"wires":[],"icon":"font-awesome/fa-car","l":true},{"id":"b56ef04d9754e252","type":"api-call-service","z":"d2cb442102b53dce","name":"Set odometer stop value","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_stop_trip_km","data":"{\"value\": msg.endTripKm}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":630,"y":1260,"wires":[[]]},{"id":"f3b95fb3c5b430ef","type":"api-call-service","z":"d2cb442102b53dce","name":"Set battery stop value","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_stop_trip_battery","data":"{\"value\": msg.endTripBattery}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":620,"y":1140,"wires":[[]]},{"id":"9f243285571b1c1e","type":"api-call-service","z":"d2cb442102b53dce","name":"Set fuel stop value","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_stop_trip_fuel","data":"{\"value\": msg.endTripFuel}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":610,"y":1200,"wires":[[]]},{"id":"607fd79eaafa3c62","type":"api-call-service","z":"d2cb442102b53dce","name":"Turn on charger","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.car_charger","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":700,"y":1800,"wires":[[]]},{"id":"e30c962b577b8d9a","type":"api-call-service","z":"d2cb442102b53dce","name":"Set full charge time","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_last_battery_charge","data":"{\"value\": msg.data.new_state.last_changed}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1230,"y":1680,"wires":[[]]},{"id":"b4811fcd6141b4b2","type":"api-current-state","z":"d2cb442102b53dce","name":"Get odometer reading","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.volvo_xc60_yv1uzh5v4p1357593_odometer","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":700,"y":1680,"wires":[["f1852d997f11b1fd","5c8da9c383d02532"]]},{"id":"5c8da9c383d02532","type":"api-current-state","z":"d2cb442102b53dce","name":"Get fuel level","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.volvo_xc60_yv1uzh5v4p1357593_fuel_level","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":950,"y":1740,"wires":[["3eeb0369c8b9110e"]]},{"id":"3eeb0369c8b9110e","type":"api-call-service","z":"d2cb442102b53dce","name":"Set fuel value at last charge","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"var","service":"set","entityId":"var.volvo_fuel_at_last_charge","data":"{\"value\": msg.payload}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1220,"y":1740,"wires":[[]]},{"id":"276dda294ec97e8d","type":"server-state-changed","z":"d2cb442102b53dce","name":"Fuel level changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.volvo_xc60_yv1uzh5v4p1357593_fuel_level","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":110,"y":1920,"wires":[["b23c137e463aa768"]]},{"id":"f77b21a3f3bf317c","type":"switch","z":"d2cb442102b53dce","name":"fuelConsumptionUntilNow is valid","property":"fuelConsumptionUntilNow","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":920,"y":2040,"wires":[["e9e2bc0f6d9c498f"]]},{"id":"ef4e6c643dcb38b1","type":"function","z":"d2cb442102b53dce","name":"Calculate fuel consumption","func":"const globalHomeAssistant = global.get('homeassistant');\n\nvar currentFuelLevel = parseFloat(msg.payload);\n\nvar totalRefuelLiters = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_fuel_total_refill\"].state);\n\nvar fuelConsumptionUntilNow = totalRefuelLiters - currentFuelLevel;\nmsg.currentTankFuelConsumptionUntilNow = 71 - currentFuelLevel;\nmsg.currentFuelLevel = msg.payload;\nmsg.totalRefill = totalRefuelLiters;\nmsg.fuelConsumptionUntilNow = fuelConsumptionUntilNow;\nvar totalConsumptionVar = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_fuel_total_consumption\"].state);\n\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":2040,"wires":[["f77b21a3f3bf317c"]]},{"id":"e9e2bc0f6d9c498f","type":"api-call-service","z":"d2cb442102b53dce","name":"Set fuel consumption until now","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"var","service":"set","entityId":"var.volvo_fuel_total_consumption","data":"{\"value\": msg.fuelConsumptionUntilNow}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1230,"y":2040,"wires":[[]]},{"id":"76a1bfd88d884659","type":"server-events","z":"d2cb442102b53dce","name":"Catch mobile app notifications","server":"8501408e.93b69","event_type":"mobile_app_notification_action","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"x":180,"y":2160,"wires":[["d5876679e7ca9648"]]},{"id":"d5876679e7ca9648","type":"switch","z":"d2cb442102b53dce","name":"Check action","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"LOCK_CAR","vt":"str"},{"t":"eq","v":"CAR_REFUEL","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":2160,"wires":[["aeebbb8b98aad769"],[]]},{"id":"aeebbb8b98aad769","type":"api-call-service","z":"d2cb442102b53dce","name":"Lock car","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"lock","service":"lock","entityId":"lock.volvo_xc60_yv1uzh5v4p1357593_lock_status","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":760,"y":2140,"wires":[[]]},{"id":"2eac1056dd56cccb","type":"api-current-state","z":"d2cb442102b53dce","name":"Get battery charge","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.volvo_xc60_battery_charge_level","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":650,"y":1560,"wires":[["faea6ae695a25bcd"]]},{"id":"faea6ae695a25bcd","type":"api-call-service","z":"d2cb442102b53dce","name":"Set battery last charge level","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_last_battery_charge_level","data":"{\"value\": msg.payload}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":900,"y":1580,"wires":[[]]},{"id":"80d38457cce64cb8","type":"function","z":"d2cb442102b53dce","name":"Set cost per km since last charge","func":"const globalHomeAssistant = global.get('homeassistant');\n\nmsg.currentFuelLevel = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_fuel_level\"].state);\nmsg.fuelAtLastCharge = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_fuel_at_last_charge\"].state);\nmsg.current_odometer_value = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_odometer\"].state);\nmsg.odometer_at_last_charge = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_odometer_at_last_charge\"].state);\nmsg.last_battery_charge_level = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_last_battery_charge_level\"].state);\nmsg.last_refuel_price_per_liter = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_last_refuel_price_per_liter\"].state);\nmsg.stop_trip_battery = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_stop_trip_battery\"].state);\n\nmsg.fuel_consumed = msg.currentFuelLevel - msg.fuelAtLastCharge;\nmsg.totalDistance = msg.current_odometer_value - msg.odometer_at_last_charge;\nmsg.fuelCost = msg.fuel_consumed * msg.last_refuel_price_per_liter;\nif (msg.fuel_consumed < 0){\n    msg.fuel_consumed = 0;\n    msg.fuelCost = 0;\n}\nvar kwhUsed = (msg.last_battery_charge_level - msg.stop_trip_battery) *18.8/100;\nmsg.energyCost = kwhUsed * 1;\nmsg.totalCost = msg.fuelCost + msg.energyCost;\nif(msg.totalDistance > 0){\n    msg.pricePerKmSinceLastCharge = msg.totalCost / msg.totalDistance;\n}\nelse{\n    msg.pricePerKmSinceLastCharge = 0;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":1240,"wires":[[]]},{"id":"e671627bf67410db","type":"inject","z":"d2cb442102b53dce","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":100,"y":1060,"wires":[["4d76230cd2394d9a","3b34c8222bff5a60"]]},{"id":"0ba5ee048e516461","type":"api-call-service","z":"d2cb442102b53dce","name":"Set price per km since last charge","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_price_per_km_since_last_charge","data":"{\"value\": msg.pricePerKmSinceLastCharge}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":660,"y":920,"wires":[[]]},{"id":"fd4d022348816c1e","type":"debug","z":"d2cb442102b53dce","name":"Start trip details","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":380,"y":1520,"wires":[]},{"id":"3b34c8222bff5a60","type":"function","z":"d2cb442102b53dce","name":"Set start trip details","func":"const globalHomeAssistant = global.get('homeassistant');\n\nvar currentOdometer = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_odometer\"].state);\nvar currentBattery = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_battery_charge_level\"].state);\nvar currentFuel = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_fuel_level\"].state);\n\nmsg.currentOdometer = parseFloat((currentOdometer).toFixed(2));\nmsg.currentBattery = parseFloat((currentBattery).toFixed(2));\nmsg.currentFuel = parseFloat((currentFuel).toFixed(2));\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":1340,"wires":[["30172fe3c0b432b8","5c48918270516617","8b282b77933472aa","68886a896955941e"]]},{"id":"7753424e3c04efb3","type":"server-state-changed","z":"d2cb442102b53dce","name":"Car unlocked","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"lock.volvo_xc60_yv1uzh5v4p1357593_lock_status","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"unlocked","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":830,"y":780,"wires":[["353f42c37da0ef07"],[]]},{"id":"49c30dc3011f9783","type":"delay","z":"d2cb442102b53dce","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1240,"y":780,"wires":[["86c888abf13244b2"]]},{"id":"86c888abf13244b2","type":"subflow:b6e164fe.1d31e8","z":"d2cb442102b53dce","name":"Notify car is unlocked","env":[{"name":"message","value":"Would you like to lock it?","type":"str"},{"name":"title","value":"The car is unlocked for more than 2 minutes","type":"str"},{"name":"notificationActions","value":"[{\"action\":\"LOCK_CAR\",\"title\":\"Lock Car\",\"icon\":\"sfsymbols:lock.fill\"}]","type":"json"}],"x":1460,"y":780,"wires":[[]]},{"id":"353f42c37da0ef07","type":"api-current-state","z":"d2cb442102b53dce","name":"If engine is off","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.volvo_yv1uzh5v4p1357593_engine_state","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1040,"y":780,"wires":[["49c30dc3011f9783"],[]]},{"id":"044a2c4c44a9def3","type":"change","z":"d2cb442102b53dce","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1050,"y":900,"wires":[["49c30dc3011f9783"]]},{"id":"b23c137e463aa768","type":"switch","z":"d2cb442102b53dce","name":"Tank was filled","property":"payload","propertyType":"msg","rules":[{"t":"gte","v":"71","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":1920,"wires":[["ecf8b2938d6e8596"],["ef4e6c643dcb38b1"]]},{"id":"ecf8b2938d6e8596","type":"subflow:b6e164fe.1d31e8","z":"d2cb442102b53dce","name":"Notify tank was filled","env":[{"name":"message","value":"Did you just filled your tank?","type":"str"},{"name":"title","value":"Fuel level is 71L","type":"str"},{"name":"notificationActions","value":"[{\"action\":\"CAR_REFUEL\",\"title\":\"Yes\",\"icon\":\"sfsymbols:lock.fill\"}]","type":"json"}],"x":560,"y":1900,"wires":[[]]},{"id":"ec8c547bed529876","type":"delay","z":"d2cb442102b53dce","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1600,"y":1220,"wires":[["9c4559f741c0aafa"]]},{"id":"49d114d959106372","type":"change","z":"d2cb442102b53dce","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1350,"y":1240,"wires":[["ec8c547bed529876"]]},{"id":"112fa6eab75a309d","type":"server-state-changed","z":"d2cb442102b53dce","name":"Engine","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.volvo_yv1uzh5v4p1357593_engine_state","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":1050,"y":1080,"wires":[["044a2c4c44a9def3","71984400929a0273","49d114d959106372","38cab4acd1d248f6"],["2238a9f6b0c5d829","189597cbebc54591"]]},{"id":"71984400929a0273","type":"subflow:b6e164fe.1d31e8","z":"d2cb442102b53dce","name":"Engine on notification","env":[{"name":"message","value":"Volvo engine turned on","type":"str"},{"name":"title","value":"Volvo engine","type":"str"},{"name":"notificationActions","value":"/lovelace-personal/mobile-car","type":"str"}],"x":1260,"y":960,"wires":[[]]},{"id":"2238a9f6b0c5d829","type":"subflow:b6e164fe.1d31e8","z":"d2cb442102b53dce","name":"Engine off notification","env":[{"name":"message","value":"Volvo engine turned off","type":"str"},{"name":"title","value":"Volvo engine","type":"str"},{"name":"notificationActions","value":"/lovelace-personal/mobile-car","type":"str"}],"x":1260,"y":1360,"wires":[[]]},{"id":"738d3252d73f3a91","type":"subflow:b6e164fe.1d31e8","z":"d2cb442102b53dce","name":"Stop trip notification","x":610,"y":1040,"wires":[[]]},{"id":"9c4559f741c0aafa","type":"function","z":"d2cb442102b53dce","name":"Calculate odometer difference","func":"const globalHomeAssistant = global.get('homeassistant');\n\nvar startTripKm = parseFloat(globalHomeAssistant.homeAssistant.states[\"var.volvo_start_trip_km\"].state);\nvar odometerState = parseFloat(globalHomeAssistant.homeAssistant.states[\"sensor.volvo_xc60_yv1uzh5v4p1357593_odometer\"].state);\n\nmsg.distance = odometerState - startTripKm;\n\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1650,"y":1360,"wires":[["b858bd360fa43a77","9c9512f4e3c0f4e6"]]},{"id":"b858bd360fa43a77","type":"switch","z":"d2cb442102b53dce","name":"Distance is greater than 2 km","property":"distance","propertyType":"msg","rules":[{"t":"gte","v":"2","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2020,"y":1340,"wires":[["fd2cff91c184540b"],[]]},{"id":"9c9512f4e3c0f4e6","type":"debug","z":"d2cb442102b53dce","name":"distance","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1960,"y":1400,"wires":[]},{"id":"38cab4acd1d248f6","type":"api-current-state","z":"d2cb442102b53dce","name":"Is there a trip in progress?","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.volvo_trip_in_progress","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1450,"y":1060,"wires":[[],["cd324c555a042a7b"]]},{"id":"189597cbebc54591","type":"api-current-state","z":"d2cb442102b53dce","name":"Is there a trip in progress?","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.volvo_trip_in_progress","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1450,"y":1120,"wires":[["ec8c547bed529876"],[]]},{"id":"d99412927d8fe96c","type":"api-call-service","z":"d2cb442102b53dce","name":"Stop current trip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.volvo_trip_in_progress","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":600,"y":980,"wires":[[]]},{"id":"0ec7c6032112abf3","type":"function","z":"d2cb442102b53dce","name":"Set finished trip details","func":"const globalHomeAssistant = global.get('homeassistant');\n\nmsg.geocodedLocation = globalHomeAssistant.homeAssistant.states[\"sensor.volvo_geocoded_location\"].state;\nif (msg.geocodedLocation.indexOf('Iași') != -1){\n    msg.isInIasi = true;\n}\nelse{\n    msg.isInIasi = false;\n}\n\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1100,"y":1480,"wires":[["1b01efe8b9d0fa74"]]},{"id":"021674c88dd28e3a","type":"inject","z":"d2cb442102b53dce","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":900,"y":1460,"wires":[["0ec7c6032112abf3"]]},{"id":"1b01efe8b9d0fa74","type":"debug","z":"d2cb442102b53dce","name":"det","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1330,"y":1480,"wires":[]},{"id":"68886a896955941e","type":"api-call-service","z":"d2cb442102b53dce","name":"Start current trip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.volvo_trip_in_progress","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":360,"y":1440,"wires":[["fd4d022348816c1e"]]},{"id":"9dafa77ebbbcf6e7","type":"inject","z":"d2cb442102b53dce","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"36.6","payloadType":"num","x":210,"y":2000,"wires":[["ef4e6c643dcb38b1"]]},{"id":"b7bc301534d2dc5b","type":"server-state-changed","z":"d2cb442102b53dce","name":"Charging status changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.volvo_charging_status","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"Unplugged","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":150,"y":1560,"wires":[["b6e546104681bbd1"],[]]},{"id":"b6e546104681bbd1","type":"switch","z":"d2cb442102b53dce","name":"Check charging status","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Charging","vt":"str"},{"t":"eq","v":"Unplugged","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":400,"y":1560,"wires":[["2eac1056dd56cccb"],[],[]]},{"id":"31afff54eb06b307","type":"api-call-service","z":"d2cb442102b53dce","name":"Set battery total consumption","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_total_battery_consumption","data":"{\"value\": msg.totalBatteryConsumption}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":640,"y":1100,"wires":[[]]},{"id":"ca327ef73d95d17f","type":"api-call-service","z":"d2cb442102b53dce","name":"Set battery stop value","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.volvo_total_battery_consumption","data":"{\"value\": msg.payload}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":380,"y":2400,"wires":[[]]},{"id":"45f8b72147656011","type":"inject","z":"d2cb442102b53dce","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"965.756","payloadType":"num","x":140,"y":2400,"wires":[["ca327ef73d95d17f"]]},{"id":"84f480343db285de","type":"change","z":"b0f7c8eb6f5588da","name":"Set Title and Message","rules":[{"t":"set","p":"message","pt":"msg","to":"Turn off light?","tot":"str"},{"t":"set","p":"title","pt":"msg","to":"Turn off light test","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":100,"wires":[["e0d98655ef6f7e2e"]]},{"id":"e0d98655ef6f7e2e","type":"api-call-service","z":"b0f7c8eb6f5588da","name":"Notify Dan Phone","server":"2e31528c.f3973e","version":5,"debugenabled":false,"service_domain":"","service":"mobile_app_dan_samsung","entityId":[],"data":"{\"message\":\"{{message}}\",\"title\":\"{{title}}\",\"data\":{\"actions\":[{\"action\":\"TURN_OFF_LIGHT\",\"title\":\"Set\"},{\"action\":\"IGNORE_LIGHT\",\"title\":\"Ignore\"}],\"persistent\":true,\"tag\":\"persistent\"}}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":950,"y":100,"wires":[[]]},{"id":"a1fb69c7e8d1d1c2","type":"server-events","z":"b0f7c8eb6f5588da","name":"All Mobile App Notification Actions","server":"2e31528c.f3973e","event_type":"mobile_app_notification_action","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"x":220,"y":180,"wires":[["12db1b01b4d16e72"]]},{"id":"12db1b01b4d16e72","type":"switch","z":"b0f7c8eb6f5588da","name":"","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"TURN_OFF_LIGHT","vt":"str"},{"t":"eq","v":"IGNORE_LIGHT","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":180,"wires":[["180e21ae29bcbd92"],[]]},{"id":"180e21ae29bcbd92","type":"api-call-service","z":"b0f7c8eb6f5588da","name":"Turn off LIght","server":"2e31528c.f3973e","version":5,"debugenabled":false,"service":"turn_off","entityId":["light.office_light"],"data":"","dataType":"jsonata","mustacheAltTags":false,"x":610,"y":180,"wires":[["af18c2cc50625ab6"]]},{"id":"af18c2cc50625ab6","type":"api-current-state","z":"b0f7c8eb6f5588da","name":"Is the light off?","server":"2e31528c.f3973e","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.office_light","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":860,"y":180,"wires":[["28998e22e5ed2563"],["892c9d700928f54f"]]},{"id":"892c9d700928f54f","type":"delay","z":"b0f7c8eb6f5588da","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1020,"y":240,"wires":[["af18c2cc50625ab6"]]},{"id":"28998e22e5ed2563","type":"change","z":"b0f7c8eb6f5588da","name":"Set Title and Message","rules":[{"t":"set","p":"message","pt":"msg","to":"Light is turned off","tot":"str"},{"t":"set","p":"title","pt":"msg","to":"Office light","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1140,"y":180,"wires":[["6e691effe35ad80b"]]},{"id":"6e691effe35ad80b","type":"api-call-service","z":"b0f7c8eb6f5588da","name":"Notify Dan Phone (Priority)","server":"2e31528c.f3973e","version":5,"debugenabled":false,"service_domain":"","service":"mobile_app_dan_samsung","entityId":[],"data":"{\"message\":\"{{message}}\",\"title\":\"{{title}}\",\"data\":{\"channel\":\"Alarm\",\"priority\":\"high\",\"ttl\":0}}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"msg","mustacheAltTags":false,"x":1400,"y":180,"wires":[[]]},{"id":"d4ed5fcb47533ee3","type":"inject","z":"b0f7c8eb6f5588da","name":"","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":470,"y":100,"wires":[["84f480343db285de"]]},{"id":"cd6654c0.d5d808","type":"api-call-service","z":"47422e7d400b50f5","name":"Update total expenses","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.card_expenses","data":"{\"value\": msg.sum }","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":660,"y":480,"wires":[["5a1a07e8.c847a8"]]},{"id":"8060ff08.4188f","type":"function","z":"47422e7d400b50f5","name":"Sum up","func":"const globalHomeAssistant = global.get('homeassistant');\nvar totalExpenses = globalHomeAssistant.homeAssistant.states[\"var.card_expenses\"].state || 0;\nif(isNaN(totalExpenses)){\n    totalExpenses = 0;\n}\nnode.warn(\"total=\" + totalExpenses);\nnode.warn(\"seller=\" + msg.seller);\nvar sum = msg.amount + parseFloat(totalExpenses);\nmsg.sum = sum;\nmsg.message = \"Spent \" + msg.payload + \" RON at \" + msg.seller;\nmsg.title = \"New expense: \" + msg.payload + \" RON\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":480,"wires":[["cd6654c0.d5d808"]]},{"id":"5a1a07e8.c847a8","type":"subflow:c28ba6b7.4557d8","z":"47422e7d400b50f5","name":"Log expenses","env":[{"name":"name","value":"Expenses","type":"str"},{"name":"message","value":"New expense","type":"str"},{"name":"domain","value":"var","type":"str"},{"name":"entity_id","value":"var.card_expenses","type":"str"}],"x":920,"y":480,"wires":[[]]},{"id":"196e671.3c35199","type":"function","z":"47422e7d400b50f5","name":"Prepare Toshl Request","func":"var date = new Date();\nvar day = date.getDate();\nvar month = date.getMonth() + 1;\nvar year = date.getFullYear();\n\nvar groceries = [\"profi\", \"carrefour\", \"marusim iasi srl\", \"brio group\", \"megaimage\", \"artima\", \"kaufland\", \"auchan\"];\nvar takeout = [\"glovo\", \"tazz\", \"beauty piur\", \"vivo iasi\", \"costud trans\"];\nvar restaurants = [\"mesopotamia\", \"subway\", \"kfc\", \"media investment\", \"vo chef srl\", \"rijal srl\"];\nvar restaurantsTag = \"71538799\";\nvar onlineSubscriptions = [\"Pago*Abonament\", \"hbo max\", \"twitter\", \"orange.ro\", \"glovo prime\", \"google play\", \"spotify\", \"amazon\", \"midjourney\", \"dropbox\"];\nvar onlineSubscriptionsTag = \"71599845\";\nvar subscriptionsCategory = \"69678212\";\nvar volvoExpenses = [\"NYX*INTERNATIONALCONN\"];\nvar groceriesTag = \"71538798\";\nvar takeoutTag = \"71616609\";\nvar volvoTag = \"72908579\";\nvar carCategory = \"69657907\";\nvar foodAndDrinksCategory = \"69657587\";\n\nmsg.date = year + \"-\" + month + \"-\" + day;\nmsg.url = \"https://toshl.com/api/entries?immediate_update=true\";\nmsg.headers = {};\nmsg.method = \"POST\";\nmsg.headers[\"Authorization\"] = msg.toshlAuthorization;\nnode.warn(msg.seller);\nmsg.payload = \n{\n\t\"amount\": -1 * msg.amount,\n\t\"date\": msg.date,\n\t\"currency\": {\n\t\t\"code\": \"RON\",\n\t\t\"main_rate\": null,\n\t\t\"fixed\": false,\n\t\t\"ref\": \"RON\",\n\t\t\"rate\": null\n\t},\n\t\"desc\": msg.seller,\n\t\"account\": \"4231659\",\n\t\"reminders\": [],\n\t\"tags\": [\"71600876\"],\n\t\"category\": \"69678563\"\n};\n\nif (groceries.some(v => msg.seller.toLowerCase().includes(v.toLowerCase()))) {\n\tmsg.payload.category = foodAndDrinksCategory;\n\tmsg.payload.tags.push(groceriesTag);\n}\nif (takeout.some(v => msg.seller.toLowerCase().includes(v.toLowerCase()))) {\n\tmsg.payload.category = foodAndDrinksCategory;\n\tmsg.payload.tags.push(takeoutTag);\n}\nif (volvoExpenses.some(v => msg.seller.toLowerCase().includes(v.toLowerCase()))) {\n\tmsg.payload.category = carCategory;\n\tmsg.payload.tags.push(volvoTag);\n}\nif (onlineSubscriptions.some(v => msg.seller.toLowerCase().includes(v.toLowerCase()))) {\n\tmsg.payload.category = subscriptionsCategory;\n\tmsg.payload.tags.push(onlineSubscriptions);\n}\nif (restaurants.some(v => msg.seller.toLowerCase().includes(v.toLowerCase()))) {\n\tmsg.payload.category = foodAndDrinksCategory;\n\tmsg.payload.tags.push(restaurants);\n}\nmsg.message = msg.seller;\nmsg.title = \"Logged new expense\";\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":760,"y":400,"wires":[["4bfdb1e3.cb4f6"]]},{"id":"4bfdb1e3.cb4f6","type":"http request","z":"47422e7d400b50f5","name":"Request","method":"use","ret":"txt","paytoqs":"body","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1000,"y":400,"wires":[["531d1f6dcb5c94a4"]]},{"id":"47841f2.952bee","type":"function","z":"47422e7d400b50f5","name":"Extract amount","func":"if(msg.payload.indexOf(\"999904374223\") != -1){\n    msg.mode = \"expense\";   \n    msg.account = \"4154753\";\n    var startIndex = msg.payload.indexOf(\" RON la \");\n    var endIndex = msg.payload.indexOf(\" din contul 99\");\n    var prefixAdd = 7;\n\n    if (msg.payload.indexOf(\"Alimentare Card Credit\") != -1 || msg.payload.indexOf(\"a fost creditata\") != -1){\n        return msg;\n    }\n\n    if(msg.payload.indexOf(\"a fost debitata in\") != -1){\n        \n        startIndex = msg.payload.indexOf(\"Home'Bank catre \");\n        endIndex = msg.payload.indexOf(\". Sold:\");\n        prefixAdd = 13;\n    }\n    msg.seller = msg.payload.substring(startIndex + prefixAdd, endIndex).trim();\n}\nelse msg.seller = msg.payload;\nconst NUMERIC_REGEXP = /[-+]?(?:[0-9]+,)*[0-9]+(?:\\.[0-9]+)?/gm;\n\nmsg.amount = parseFloat(msg.payload.match(NUMERIC_REGEXP)[0].replace(',', ''));\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":400,"wires":[["8060ff08.4188f","6e27f9ed.8d14c8","68471bbf1bf9de4a"]]},{"id":"63856c89.9f15e4","type":"server-state-changed","z":"47422e7d400b50f5","name":"","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.s22ultra_last_notification","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":200,"y":100,"wires":[["3eb09affeb08c1e4"]]},{"id":"f686aae4.44dc38","type":"switch","z":"47422e7d400b50f5","name":"From ING","property":"data.new_state.attributes.package","propertyType":"msg","rules":[{"t":"eq","v":"ro.ing.mobile.banking.android.activity","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":900,"y":100,"wires":[["7b911e7e.d8d34"]]},{"id":"9c627af1.b5d128","type":"change","z":"47422e7d400b50f5","name":"","rules":[{"t":"set","p":"last_expense","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1320,"y":100,"wires":[["44a26fb833ed520f"]]},{"id":"7b911e7e.d8d34","type":"switch","z":"47422e7d400b50f5","name":"Check last expense","property":"last_expense","propertyType":"flow","rules":[{"t":"neq","v":"payload","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":100,"wires":[["9c627af1.b5d128","289366c96d579c48"]]},{"id":"cffa38b8.abbe68","type":"function","z":"47422e7d400b50f5","name":"Extract amount","func":"if(msg.payload.indexOf(\"999904374223\") != -1){\n    msg.mode = \"expense\";   \n    msg.account = \"3721907\";\n    var startIndex = msg.payload.indexOf(\" RON la \");\n    var endIndex = msg.payload.indexOf(\" din contul 99\");\n    var prefixAdd = 7;\n    if(msg.payload.indexOf(\"a fost debitata in\") != -1){\n        \n        startIndex = msg.payload.indexOf(\"Home'Bank catre \");\n        endIndex = msg.payload.indexOf(\". Sold:\");\n        prefixAdd = 16;\n    }\n    msg.seller = msg.payload.substring(startIndex + prefixAdd, endIndex).trim();\n}\n\nif(msg.payload.indexOf(\"economisit\") != -1 && msg.payload.indexOf(\"Round Up\") != -1){\n    msg.mode = \"roundUp\";\n    msg.transferFrom = \"3721907\";\n    msg.account = \"3721610\";\n}\n\nconst NUMERIC_REGEXP = /[-+]?(?:[0-9]+,)*[0-9]+(?:\\.[0-9]+)?/gm;\n\nmsg.amount = parseFloat(msg.payload.match(NUMERIC_REGEXP)[0].replace(',', ''));\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1540,"y":220,"wires":[[]]},{"id":"6e27f9ed.8d14c8","type":"credentials","z":"47422e7d400b50f5","name":"Set Toshl Authorization","props":[{"value":"toshlAuthorization","type":"msg"}],"x":500,"y":400,"wires":[["196e671.3c35199"]]},{"id":"5e2837ed.a9ce18","type":"delay","z":"47422e7d400b50f5","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":740,"y":100,"wires":[["f686aae4.44dc38"]]},{"id":"3ae49cf.5641364","type":"inject","z":"47422e7d400b50f5","name":"Ai autorizat tranzactia de","props":[{"p":"payload"},{"p":"data.new_state.attributes.package","v":"ro.ing.mobile.banking.android.activity","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Ai autorizat tranzactia de 122 RON la Tazz din contul 999904374223 in 29-03-2021.  Sold: 1,238.87 RON","payloadType":"str","x":150,"y":40,"wires":[["f686aae4.44dc38","289366c96d579c48"]]},{"id":"caca14cc54f64286","type":"inject","z":"47422e7d400b50f5","name":"Suma XX RON a fost debitata","props":[{"p":"payload"},{"p":"data.new_state.attributes.package","v":"ro.ing.mobile.banking.android.activity","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Suma 12.34 RON a fost debitata in 04-01-2023 din contul 999904374223 - Alimentare Card Credit Home'Bank. Sold: 5,523.78","payloadType":"str","x":160,"y":180,"wires":[["f686aae4.44dc38"]]},{"id":"531d1f6dcb5c94a4","type":"subflow:b6e164fe.1d31e8","z":"47422e7d400b50f5","name":"Bogdan mobile phone notification","env":[{"name":"notificationUrl","value":"app://com.thirdframestudios.android.expensoor","type":"str"}],"x":1260,"y":400,"wires":[[]]},{"id":"ad6a5785a081b3f1","type":"link in","z":"47422e7d400b50f5","name":"Expense details","links":["44a26fb833ed520f"],"x":35,"y":400,"wires":[["47841f2.952bee"]]},{"id":"44a26fb833ed520f","type":"link out","z":"47422e7d400b50f5","name":"Expenses","mode":"link","links":["ad6a5785a081b3f1"],"x":1455,"y":100,"wires":[]},{"id":"289366c96d579c48","type":"debug","z":"47422e7d400b50f5","name":"debug 12","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":600,"y":180,"wires":[]},{"id":"68471bbf1bf9de4a","type":"debug","z":"47422e7d400b50f5","name":"debug 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":460,"y":360,"wires":[]},{"id":"3eb09affeb08c1e4","type":"switch","z":"47422e7d400b50f5","name":"Is login message","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"Tocmai ai incercat sa accesezi","vt":"str"},{"t":"cont","v":"RON","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":510,"y":100,"wires":[[],["5e2837ed.a9ce18"]]},{"id":"d21adafc.3139b8","type":"api-call-service","z":"f887527c.ee532","name":"3. Toggle ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.bedroom_light","data":"{\"transition\":\"1\", \"brightness\":255}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":700,"y":440,"wires":[[]]},{"id":"7292545b.d5f8ec","type":"api-call-service","z":"f887527c.ee532","name":"Toggle lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.bedroom_lightstrip","data":"{\"transition\":\"1\", \"brightness\":255}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":380,"wires":[[]]},{"id":"e19e7da3.cd5c1","type":"api-call-service","z":"f887527c.ee532","name":"2. Toggle TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"toggle","entityId":"switch.bedroom_tv","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":670,"y":240,"wires":[[]]},{"id":"1f678b95.c854b4","type":"api-call-service","z":"f887527c.ee532","name":"Long. Open Curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"open_cover","entityId":"cover.bedroom_curtain","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1490,"y":60,"wires":[[]]},{"id":"55a258dd.e44478","type":"subflow:3134fb52.d06d64","z":"f887527c.ee532","name":"Notify opened windows","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"only_on_occupied_rooms","type":"bool","value":"true"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"}],"x":810,"y":800,"wires":[[],[]]},{"id":"811b6409.c16858","type":"function","z":"f887527c.ee532","name":"Get opened windows","func":"const globalHomeAssistant = global.get('homeassistant');\nvar livingRoomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.living_room_window\"].state;\nvar bedroomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.bedroom_window\"].state;\nvar bathroomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.bathroom_window\"].state;\nvar kidsWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.kids_window\"].state;\nvar kitchenWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.kitchen_window\"].state;\nvar windows = \"\";\nvar count = 0;\nif(livingRoomWindow == 'on'){\n     windows += \"living room, \";\n     count++;\n }\nif(bedroomWindow == 'on'){\n windows += \"bedroom, \";   \n count++;\n}\nif(bathroomWindow == 'on'){\n windows += \"bathroom room\";\n count++;\n}\nif(kidsWindow == 'on'){\n windows += \"kids room\";\n count++;\n}\nif(kitchenWindow == 'on'){\n windows += \"kitchen\";\n count++;\n}\nvar message = '';\nif(count === 0){\n    message = \"There are no windows opened\";\n}\nif(count > 0){\n    message = 'There are ' + count + ' windows opened';\n    message += ': ' + windows;\n}\nglobal.set(\"AlexaMessage\", message);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":540,"y":780,"wires":[["55a258dd.e44478"]]},{"id":"b0338bbd.f1c5b8","type":"api-current-state","z":"f887527c.ee532","name":"1. Bedroom lights","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"group.bedroom_lights","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":710,"y":160,"wires":[["f9a048f0.beebf8"]]},{"id":"f9a048f0.beebf8","type":"switch","z":"f887527c.ee532","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1270,"y":640,"wires":[["5196ecae.278204"],["702de197.f7547"]]},{"id":"5196ecae.278204","type":"api-call-service","z":"f887527c.ee532","name":"Turn off group","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"","data":"{\"entity_id\": msg.topic , \"transition\":0}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1440,"y":480,"wires":[[]]},{"id":"1b27a036.691ba","type":"api-call-service","z":"f887527c.ee532","name":"Volume down TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.bedroom_tv_volume_down","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":950,"y":620,"wires":[[]]},{"id":"bed7d02f.2efa7","type":"api-call-service","z":"f887527c.ee532","name":"Volume up TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.bedroom_tv_volume_up","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":940,"y":560,"wires":[[]]},{"id":"c8f99687.36f388","type":"server-events","z":"f887527c.ee532","name":"Deconz Event","server":"8501408e.93b69","event_type":"deconz_event","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":70,"y":1080,"wires":[["950deea0.55f1","65204452.29f97c","a1046f8b.17655","42b3c006.6707d","1fb7f746.8da319","83b2d6f845254954"]]},{"id":"950deea0.55f1","type":"switch","z":"f887527c.ee532","name":"Check which switch fired","property":"payload.event.id","propertyType":"msg","rules":[{"t":"eq","v":"office_switch","vt":"str"},{"t":"eq","v":"living_room_switch","vt":"str"},{"t":"eq","v":"bedroom_door_switch","vt":"str"},{"t":"eq","v":"hallway_door_switch","vt":"str"},{"t":"eq","v":"bedroom_bed_switch","vt":"str"},{"t":"eq","v":"kids_room_switch","vt":"str"},{"t":"eq","v":"kitchen_hue_remote","vt":"str"},{"t":"eq","v":"mi_magic_cube","vt":"str"},{"t":"eq","v":"switch_50","vt":"str"}],"checkall":"true","repair":false,"outputs":9,"x":330,"y":1100,"wires":[["bb131f8.6dd91e"],["330aee83.983612"],["1840c438.ad4b6c"],["2752fc02.521d34"],["38ddc950.d4ccf6"],["c9733bc4.ad2868"],["1a5093c.d84446c"],["713c9d08.0d7b54"],["713c9d08.0d7b54"]]},{"id":"1840c438.ad4b6c","type":"switch","z":"f887527c.ee532","name":"Bedroom door switch","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":380,"y":280,"wires":[["b0338bbd.f1c5b8"],["e19e7da3.cd5c1"],["8566851e.e3f018"],["7292545b.d5f8ec"],["d21adafc.3139b8"],["8f15caa3.f89da8"]]},{"id":"38ddc950.d4ccf6","type":"switch","z":"f887527c.ee532","name":"Bedroom bed switch","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":360,"y":120,"wires":[["5492fdef.a606e4"],["e19e7da3.cd5c1"],["cf54cca1.99847"],[],[],["8f15caa3.f89da8"]]},{"id":"2752fc02.521d34","type":"switch","z":"f887527c.ee532","name":"Front hallway Xiaomi switch","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":260,"y":840,"wires":[["811b6409.c16858"],[],["20684a8e.33e8b6"],[],[],["504358ce.283f38"]]},{"id":"c9733bc4.ad2868","type":"switch","z":"f887527c.ee532","name":"Kids switch","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"false","repair":false,"outputs":6,"x":410,"y":1520,"wires":[["38083d57e032e8aa"],["9f7dcbb5843ca1cd"],["4efb72ef019ef9d0"],["1f2199aff0ba8e50"],[],["ba850fd7c0035d62"]]},{"id":"65204452.29f97c","type":"switch","z":"f887527c.ee532","name":"Philips Hue switch long pressed turn off","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"4003","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":280,"y":1740,"wires":[["33a988a6.d5dcd8"]]},{"id":"33a988a6.d5dcd8","type":"api-call-service","z":"f887527c.ee532","name":"Turn off all lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"all","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":700,"y":1740,"wires":[[]]},{"id":"a1046f8b.17655","type":"function","z":"f887527c.ee532","name":"Prepare message","func":"var button = \"\";\nvar event = msg.payload.event.event;\nif(event % 1000 === 0){\n    msg.shouldContinue = false;\n    return;\n}\nmsg.shouldContinue = true;\nswitch(event){\n    case 1002:\n        button = \"single click\";\n        break;\n    case 1004:\n        button = \"double click\";\n        break;\n    case 1005:\n        button = \"triple click\";\n        break;\n    case 1006:\n        button = \"quadruple click\";\n        break;\n    case 1010:\n        button = \"multiple click\";\n        break;\n    case 1003:\n        button = \"long click\";\n        break;\n    case 1002:\n        button = \"on click\";\n        break;\n    case 2002:\n        button = \"+ click\";\n        break;\n    case 3002:\n        button = \"- click\";\n        break;\n    case 4002:\n        button = \"off click\";\n        break;\n    case 4003:\n        button = \"long click off\";\n        break;\n    case 5005:\n        button = \"double tap\";\n        break;\n}\n\nvar hueRemotes = ['hallway_back_remote', 'hallway_front_remote', \n'bathroom_remote', 'bedroom_remote', 'kitchen_hue_remote'];\nif(hueRemotes.indexOf(msg.payload.event.id) != -1 && event == 1002){\n    button = 'on click';\n}\nswitch(msg.payload.event.id){\n    case \"office_switch\":\n        msg.name = \"Office switch\";\n        msg.message = button;\n        break;\n    case \"kids_room_switch\":\n        msg.name = \"Kids switch\";\n        msg.message = button;\n        break;\n    \n    case \"hallway_door_switch\":\n        msg.name = \"Hallway door switch\";\n        msg.message = button;\n        break;\n    \n    case \"bedroom_bed_switch\":\n        msg.name = \"Bedroom bed switch\";\n        msg.message = button;\n        break;\n    \n    case \"living_room_switch\":\n        msg.name = \"Living room switch\";\n        msg.message = button;\n        break;\n    \n    case \"bedroom_door_switch\":\n        msg.name = \"Bedroom door switch\";\n        msg.message = button;\n        break;\n    case \"hallway_back_remote\":\n        msg.name = \"Hallway back remote\";\n        msg.message = button;\n        break;\n    case \"hallway_front_remote\":\n        msg.name = \"Hallway front remote\";\n        msg.message = button;\n        break;\n    case \"bathroom_remote\":\n        msg.name = \"Bathroom remote\";\n        msg.message = button;\n        break;\n    case \"bedroom_remote\":\n        msg.name = \"Bedroom hue remote\";\n        msg.message = button;\n        break;\n    case \"kitchen_hue_remote\":\n        msg.name = \"Kitchen remote\";\n        msg.message = button;\n        break;\n    case \"mi_magic_cube\":\n        msg.name = \"Magic cube\";\n        msg.message = button;\n        break;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":290,"y":960,"wires":[["eaeae321.e6691"]]},{"id":"eaeae321.e6691","type":"api-call-service","z":"f887527c.ee532","name":"Logbook","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"logbook","service":"log","entityId":"","data":"{\t    \"name\":msg.name,\t    \"domain\":\"switch\",\t    \"message\":msg.message\t}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":560,"y":940,"wires":[[]]},{"id":"17ca07fc.aa3ff8","type":"switch","z":"f887527c.ee532","name":"Philips Hue bedroom remote","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"2002","vt":"str"},{"t":"eq","v":"3002","vt":"str"},{"t":"eq","v":"4002","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":580,"y":560,"wires":[["601872d6.7d28cc"],["bed7d02f.2efa7"],["1b27a036.691ba"],["8910235.b02b2e"]]},{"id":"42b3c006.6707d","type":"switch","z":"f887527c.ee532","name":"Bedroom Philips Hue switch","property":"payload.event.id","propertyType":"msg","rules":[{"t":"eq","v":"bedroom_remote","vt":"str"},{"t":"eq","v":"hallway_front_remote","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":180,"y":700,"wires":[["17ca07fc.aa3ff8"],["a0862170.cab85"]]},{"id":"601872d6.7d28cc","type":"api-call-service","z":"f887527c.ee532","name":"Turn on bedroom light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.bedroom_lights","data":"{ \"brightness\":255, \"transition\": 0, \"color_name\": \"white\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":960,"y":500,"wires":[[]]},{"id":"8910235.b02b2e","type":"api-call-service","z":"f887527c.ee532","name":"Turn off bedroom lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"group.bedroom_lights","data":"{ \"transition\":0}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":960,"y":680,"wires":[[]]},{"id":"5c258852.ba2e28","type":"api-call-service","z":"f887527c.ee532","name":"Sleep mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.bedroom_lightstrip","data":"{\"transition\":\"1\", \"brightness\":55, \"color_name\":\"white\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":970,"y":60,"wires":[[]]},{"id":"5492fdef.a606e4","type":"api-call-service","z":"f887527c.ee532","name":"Turn off bedroom ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.bedroom_light","data":"{ \"transition\":0}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":740,"y":60,"wires":[["5c258852.ba2e28"]]},{"id":"a0862170.cab85","type":"switch","z":"f887527c.ee532","name":"Philips Hue hallway front remote","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"2002","vt":"str"},{"t":"eq","v":"3002","vt":"str"},{"t":"eq","v":"4002","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":570,"y":660,"wires":[["a2adf19f.f87fe"],[],[],[]]},{"id":"702de197.f7547","type":"api-call-service","z":"f887527c.ee532","name":"Turn on light(s)","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":msg.topic, \"brightness\":255, \"transition\": 0, \"color_name\":\"white\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1440,"y":780,"wires":[[]]},{"id":"504358ce.283f38","type":"subflow:d7bbbb62.ece328","z":"f887527c.ee532","name":"Set family status to away","env":[{"name":"status","value":"Away","type":"str"}],"x":530,"y":880,"wires":[]},{"id":"65dabac9.c66954","type":"subflow:45600ca3.e7f3f4","z":"f887527c.ee532","name":"Kids room cleanup","env":[{"name":"room","value":"script.1584736170010","type":"str"}],"x":910,"y":1680,"wires":[[]]},{"id":"20684a8e.33e8b6","type":"subflow:45600ca3.e7f3f4","z":"f887527c.ee532","name":"Apartment cleanup","env":[{"name":"room","value":"script.1584735527658","type":"str"}],"x":530,"y":820,"wires":[[]]},{"id":"8566851e.e3f018","type":"subflow:45600ca3.e7f3f4","z":"f887527c.ee532","name":"Bedroom cleanup","env":[{"name":"room","value":"script.1584735991442","type":"str"}],"x":710,"y":320,"wires":[[]]},{"id":"a55fae13.d7eac","type":"inject","z":"f887527c.ee532","name":"","props":[{"p":"payload.event.gesture","v":"7","vt":"num"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":670,"y":1840,"wires":[["713c9d08.0d7b54"]]},{"id":"78986079.4138","type":"switch","z":"f887527c.ee532","name":"Philips Hue switch long pressed turn on","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"num"},{"t":"eq","v":"1003","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":620,"y":2040,"wires":[["0f6af76b35895ea8"],["be2359c5.966e78"]]},{"id":"1fb7f746.8da319","type":"switch","z":"f887527c.ee532","name":"Back hallway Philips remote","property":"payload.event.id","propertyType":"msg","rules":[{"t":"eq","v":"hallway_back_remote","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":260,"y":2060,"wires":[["78986079.4138"]]},{"id":"be2359c5.966e78","type":"subflow:45600ca3.e7f3f4","z":"f887527c.ee532","name":"Hallway cleanup","env":[{"name":"room","value":"script.1584735527658","type":"str"}],"x":960,"y":2120,"wires":[[]]},{"id":"be3e0a33.c02258","type":"api-call-service","z":"f887527c.ee532","name":"Turn on kitchen lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.kitchen_hue_lightstrip, light.kitchen_light","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":680,"y":2200,"wires":[[]]},{"id":"1a5093c.d84446c","type":"switch","z":"f887527c.ee532","name":"Kitchen Hue remote","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"2002","vt":"str"},{"t":"eq","v":"3002","vt":"str"},{"t":"eq","v":"4002","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":300,"y":2280,"wires":[["be3e0a33.c02258"],[],[],["77e524e0.823c7c"]]},{"id":"77e524e0.823c7c","type":"api-call-service","z":"f887527c.ee532","name":"Turn off kitchen lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.kitchen_hue_lightstrip, light.kitchen_light","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":580,"y":2300,"wires":[[]]},{"id":"a2adf19f.f87fe","type":"api-call-service","z":"f887527c.ee532","name":"Turn on light(s)","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":\"group.hallway_lights\", \"brightness\":255, \"transition\": 0, \"color_name\":\"white\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":980,"y":720,"wires":[[]]},{"id":"713c9d08.0d7b54","type":"switch","z":"f887527c.ee532","name":"Office cube","property":"payload.event.gesture","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"str"},{"t":"eq","v":"7","vt":"str"},{"t":"eq","v":"8","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"false","repair":false,"outputs":4,"x":950,"y":1780,"wires":[["82682a4e.854f28"],["1e7ace9.97c8731"],["1e7ace9.97c8731"],["fabf56b2.9961d8"]],"outputLabels":["Move","Rotate right","Rotate left",""]},{"id":"82682a4e.854f28","type":"api-call-service","z":"f887527c.ee532","name":"Toggle office ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.sonoffofficelight","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1270,"y":1680,"wires":[[]]},{"id":"1e7ace9.97c8731","type":"function","z":"f887527c.ee532","name":"","func":"const globalHomeAssistant = global.get('homeassistant');\nvar light = globalHomeAssistant.homeAssistant.states[\"light.office_lightstrip\"];\nvar isOn = light.state == \"on\";\nmsg.oldBrightness = light.attributes.brightness;\nif(!isOn){\n    msg.action = \"turn_on_light\";\n    return msg;\n}\nmsg.rotation = parseInt(msg.payload.event.event);\nmsg.percentage = parseInt(msg.rotation/1000);\nmsg.newBrightness = msg.oldBrightness + (msg.percentage * 10);\nif(msg.newBrightness <= 0){\n    msg.action = \"turn_off_light\";\n}\nelse{\n    msg.action = \"turn_on_light\";\n}\nif(msg.newBrightness > 255){\n    msg.brightness = 255;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1200,"y":1780,"wires":[["a5a1ca89.211838"]]},{"id":"a5a1ca89.211838","type":"switch","z":"f887527c.ee532","name":"Light action","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"turn_on_light","vt":"str"},{"t":"eq","v":"turn_off_light","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":1390,"y":1780,"wires":[["9412c1c6.4b26c","283986a75a389c89"],["f66d470e.ed1628"]],"outputLabels":["Move","Rotate right"]},{"id":"f66d470e.ed1628","type":"api-call-service","z":"f887527c.ee532","name":"Turn off office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.office_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1620,"y":1840,"wires":[[]]},{"id":"9412c1c6.4b26c","type":"api-call-service","z":"f887527c.ee532","name":"Turn on office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":\"light.office_lightstrip\",\t\"brightness\":msg.newBrightness, \"transition\": 0, \"color_name\":\"white\"}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1620,"y":1720,"wires":[[]]},{"id":"fabf56b2.9961d8","type":"api-call-service","z":"f887527c.ee532","name":"Refresh HA","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"browser_mod","service":"window_reload","entityId":"","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1150,"y":1960,"wires":[["9e07e62d.b1fba8"]]},{"id":"8f15caa3.f89da8","type":"counter","z":"f887527c.ee532","name":"Counter","init":"0","step":"1","lower":"","upper":"","mode":"increment","outputs":"1","x":980,"y":260,"wires":[["104d07dc.f864f8"]]},{"id":"33c7bbdf.12feb4","type":"switch","z":"f887527c.ee532","name":"Open/close","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"open","vt":"str"},{"t":"eq","v":"close","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1310,"y":180,"wires":[["1f678b95.c854b4"],["2f8a4365.3a93cc"]]},{"id":"104d07dc.f864f8","type":"function","z":"f887527c.ee532","name":"","func":"if(msg.count%2 == 0)\nmsg.action = \"open\";\nelse msg.action = \"close\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1200,"y":300,"wires":[["33c7bbdf.12feb4"]]},{"id":"2f8a4365.3a93cc","type":"api-call-service","z":"f887527c.ee532","name":"Long. Close Curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"close_cover","entityId":"cover.bedroom_curtain","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1500,"y":320,"wires":[[]]},{"id":"9e07e62d.b1fba8","type":"api-call-service","z":"f887527c.ee532","name":"Turn off screensaver","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.office_pi_screensaver","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1360,"y":2000,"wires":[["68a705b.3f09ffc"]]},{"id":"68a705b.3f09ffc","type":"api-call-service","z":"f887527c.ee532","name":"Turn on PI screen","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_touchscreen","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1370,"y":2080,"wires":[[]]},{"id":"bb131f8.6dd91e","type":"switch","z":"f887527c.ee532","name":"Office","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":670,"y":1140,"wires":[["2eb1446e.1b857c"],["9159fe81.d241e"],["3df9556691430286"],["cd81fcaf.057b1"],[],["8c1a6ff1.df996"]]},{"id":"9159fe81.d241e","type":"api-call-service","z":"f887527c.ee532","name":"Toggle office ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.sonoffofficelight","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":950,"y":1040,"wires":[[]]},{"id":"cd81fcaf.057b1","type":"api-call-service","z":"f887527c.ee532","name":"Reset office light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":\"light.office_lightstrip\", \"color_name\":\"white\",\"brightness\":255,  \"transition\": 0.5}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":720,"y":1020,"wires":[[]]},{"id":"8ee7ca9.63b3338","type":"api-current-state","z":"f887527c.ee532","name":"Office lightstrip","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"light.office_lightstrip","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1300,"y":980,"wires":[["f9a048f0.beebf8"]]},{"id":"10fa2fac.1aa","type":"inject","z":"f887527c.ee532","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1300,"y":1120,"wires":[["f4d427d7.46a9f8"]]},{"id":"2eb1446e.1b857c","type":"subflow:7f445a94.cd19d4","z":"f887527c.ee532","name":"Switch Office monitor view","env":[],"x":940,"y":980,"wires":[[]]},{"id":"d05bf9a7.61af78","type":"subflow:1366240e.7be4ac","z":"f887527c.ee532","name":"","env":[],"x":1150,"y":1420,"wires":[[]]},{"id":"a6a5515c.96b5","type":"api-current-state","z":"f887527c.ee532","name":"Focus mode is on","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"var.focus_mode","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":850,"y":1260,"wires":[["766b655a.1bae7c"],["d05bf9a7.61af78"]]},{"id":"421e3a6a.7f3544","type":"http request","z":"f887527c.ee532","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1370,"y":1360,"wires":[["6cba38b.e82cbc8","b1cf80f7.b937e"]]},{"id":"6cba38b.e82cbc8","type":"debug","z":"f887527c.ee532","name":"Focus","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1690,"y":1420,"wires":[]},{"id":"198234f0.16668b","type":"http request","z":"f887527c.ee532","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1370,"y":1300,"wires":[["6345dc68.133cd4"]]},{"id":"f4d427d7.46a9f8","type":"function","z":"f887527c.ee532","name":"Prepare Freedom schedules Request","func":"msg.headers = {};\nmsg.method = \"GET\";\nmsg.mode = \"cors\";\nmsg.credentials = \"include\";\nmsg.url = \"https://freedom.to/schedules/\";\nmsg.headers = {\n    \"accept\": \"application/json, */*; q=0.01\",\n    \"accept-language\": \"en-US,en;q=0.9,ro;q=0.8,it;q=0.7,mt;q=0.6,de;q=0.5\",\n    \"content-type\": \"application/json\",\n    \"if-none-match\": \"W/\\\"69fccce06f9c04422d5ff28537fbc0a0\\\"\",\n    \"sec-fetch-dest\": \"empty\",\n    \"sec-fetch-mode\": \"cors\",\n    \"sec-fetch-site\": \"same-origin\",\n    \"x-requested-with\": \"XMLHttpRequest\",\n    \"Cookie\": msg.cookie\n  };\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1330,"y":1240,"wires":[["198234f0.16668b"]]},{"id":"3eae41a8.b199ce","type":"function","z":"f887527c.ee532","name":"Stop focus mode","func":"node.warn(msg);\nvar sessionId = JSON.parse(msg.payload).schedule[0].id;\n\nmsg.method = \"POST\";\n\nmsg.url = \"https://freedom.to/schedules/\"+sessionId+\"/end?force=\"+Date.now();\nnode.warn(msg.url);\nmsg.headers = {\n    \"accept\": \"*/*\",\n    \"accept-language\": \"en-US,en;q=0.9,ro;q=0.8,it;q=0.7,mt;q=0.6,de;q=0.5\",\n    \"cache-control\": \"no-cache\",\n    \"content-type\": \"application/json\",\n    \"pragma\": \"no-cache\",\n    \"sec-fetch-dest\": \"empty\",\n    \"sec-fetch-mode\": \"cors\",\n    \"sec-fetch-site\": \"same-origin\",\n    \"x-requested-with\": \"XMLHttpRequest\",\n    Cookie: msg.cookie\n\n  };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1750,"y":1300,"wires":[["421e3a6a.7f3544"]]},{"id":"b1cf80f7.b937e","type":"subflow:6c1e9884.3e70a8","z":"f887527c.ee532","name":"","env":[],"x":1890,"y":1340,"wires":[]},{"id":"bdeac795.697158","type":"api-current-state","z":"f887527c.ee532","name":"Living room lights","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"group.living_room_lights","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1190,"y":780,"wires":[["f9a048f0.beebf8"]]},{"id":"330aee83.983612","type":"switch","z":"f887527c.ee532","name":"Living room","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":950,"y":880,"wires":[["bdeac795.697158"],["2c9cf2b35bd66d37"],[],[],[],[]]},{"id":"79a367ef.0c6f98","type":"api-call-service","z":"f887527c.ee532","name":"Toggle living TV","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"media_player","service":"toggle","entityId":"media_player.living_tv","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1560,"y":940,"wires":[[]]},{"id":"7bb9a062.a45ee","type":"subflow:45600ca3.e7f3f4","z":"f887527c.ee532","name":"Living room cleanup","env":[{"name":"room","value":"script.1584736860542","type":"str"}],"x":1200,"y":920,"wires":[[]]},{"id":"766b655a.1bae7c","type":"credentials","z":"f887527c.ee532","name":"Set cookie","props":[{"value":"cookie","type":"msg"}],"x":1050,"y":1240,"wires":[["f4d427d7.46a9f8"]]},{"id":"6345dc68.133cd4","type":"credentials","z":"f887527c.ee532","name":"Set cookie","props":[{"value":"cookie","type":"msg"}],"x":1570,"y":1300,"wires":[["3eae41a8.b199ce"]]},{"id":"22d4860.7c2e57a","type":"api-call-service","z":"f887527c.ee532","name":"Toggle office desk usb ports","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"toggle","entityId":"switch.office_desk_usb_ports","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1000,"y":1200,"wires":[[]]},{"id":"cf54cca1.99847","type":"api-call-service","z":"f887527c.ee532","name":"Flash lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.hallway_lights, light.kitchen_light, group.living_room_lights, light.bathroom_ceiling_light","data":"{\"flash\": \"short\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":980,"y":140,"wires":[["366300ba.e6d34"]]},{"id":"366300ba.e6d34","type":"delay","z":"f887527c.ee532","name":"Wait 15 seconds","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1160,"y":140,"wires":[["9949f485.f827f8"]]},{"id":"9949f485.f827f8","type":"api-call-service","z":"f887527c.ee532","name":"Flash lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"group.hallway_lights, light.kitchen_light, group.living_room_lights, light.bathroom_ceiling_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1270,"y":80,"wires":[[]]},{"id":"1e9194c.2d8396b","type":"inject","z":"f887527c.ee532","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":800,"y":120,"wires":[["cf54cca1.99847"]]},{"id":"3eed78aa.4695d8","type":"subflow:dc813b26.76fc98","z":"f887527c.ee532","name":"","env":[],"x":830,"y":1340,"wires":[[],[]]},{"id":"8c1a6ff1.df996","type":"api-current-state","z":"f887527c.ee532","name":"Office lightstrip","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"light.bedroom_light","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1080,"y":1140,"wires":[["f9a048f0.beebf8"]]},{"id":"5ed22335.40c72c","type":"server-state-changed","z":"f887527c.ee532","name":"Fasting switch toggled","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"switch.fasting","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":140,"y":2500,"wires":[["9e2fb64e.52dd88"]]},{"id":"e2288e80.eb08f","type":"api-call-service","z":"f887527c.ee532","name":"Set last meal time","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.last_meal_time","data":"{\"value\": msg.payload}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":660,"y":2500,"wires":[["a67550f3.a7a1a"]]},{"id":"9e2fb64e.52dd88","type":"api-current-state","z":"f887527c.ee532","name":"Get last meal time","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_datetime.last_meal","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":400,"y":2500,"wires":[["e2288e80.eb08f"]]},{"id":"a67550f3.a7a1a","type":"api-call-service","z":"f887527c.ee532","name":"Update sensor","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.intermittent_fasting_time","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":890,"y":2500,"wires":[[]]},{"id":"9f7dcbb5843ca1cd","type":"api-call-service","z":"f887527c.ee532","name":"Open curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"open_cover","entityId":"cover.kids_room_curtain","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":830,"y":1480,"wires":[[]]},{"id":"ba850fd7c0035d62","type":"api-call-service","z":"f887527c.ee532","name":"Toggle curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"toggle","entityId":"cover.kids_room_curtain","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":840,"y":1600,"wires":[[]]},{"id":"4efb72ef019ef9d0","type":"api-call-service","z":"f887527c.ee532","name":"Close curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"close_cover","entityId":"cover.kids_room_curtain","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":830,"y":1520,"wires":[[]]},{"id":"80d5a9b6b3c810e0","type":"server-state-changed","z":"f887527c.ee532","name":"WLED switch toggled","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"switch.living_room_wled","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":160,"y":2600,"wires":[[]]},{"id":"cbf2d61e05648bad","type":"debug","z":"f887527c.ee532","name":"On payload","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":570,"y":2580,"wires":[]},{"id":"bccc7d4abf69d5a8","type":"debug","z":"f887527c.ee532","name":"Off payload","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":610,"y":2680,"wires":[]},{"id":"57c754f498a96688","type":"api-call-service","z":"f887527c.ee532","name":"Toggle living room strips","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"toggle","entityId":"group.living_room_wled","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":650,"y":2620,"wires":[[]]},{"id":"8bb9c1e49887026a","type":"server-state-changed","z":"f887527c.ee532","name":"Ceiling lights switch toggled","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"switch.living_room_ceiling_lights","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"x":140,"y":2780,"wires":[[]]},{"id":"c396aef9b0f57ae2","type":"api-call-service","z":"f887527c.ee532","name":"Toggle living room ceiling lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"toggle","entityId":"group.living_room_ceiling_lights","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":650,"y":2780,"wires":[[]]},{"id":"e5dd3f1f564e28c0","type":"api-current-state","z":"f887527c.ee532","name":"","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"group.living_room_ceiling_lights","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":530,"y":2840,"wires":[["bccc7d4abf69d5a8"]]},{"id":"ea5661cebc27747f","type":"inject","z":"f887527c.ee532","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":130,"y":2980,"wires":[["e5dd3f1f564e28c0","e8ad5cc3c0bd58b8","b328d5ae7443fbe0"]]},{"id":"e8ad5cc3c0bd58b8","type":"api-current-state","z":"f887527c.ee532","name":"","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.living_room_couch_light","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":490,"y":2960,"wires":[[]]},{"id":"b328d5ae7443fbe0","type":"api-current-state","z":"f887527c.ee532","name":"","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.living_room_dining_table","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":470,"y":3060,"wires":[[]]},{"id":"3b27e20392492c39","type":"inject","z":"f887527c.ee532","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":2700,"wires":[["c396aef9b0f57ae2"]]},{"id":"612ebde19265eec7","type":"inject","z":"f887527c.ee532","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":340,"y":2660,"wires":[["e5dd3f1f564e28c0"]]},{"id":"1f2199aff0ba8e50","type":"api-call-service","z":"f887527c.ee532","name":"Toggle light switch","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.sonoff_kids_light","data":"{\"transition\":\"1\"}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":850,"y":1560,"wires":[[]]},{"id":"283986a75a389c89","type":"api-call-service","z":"f887527c.ee532","name":"Turn on office lamps","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":\"group.office_hue_lamps\",\t\"brightness\":msg.newBrightness, \"transition\": 0, \"color_name\":\"white\"}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1620,"y":1660,"wires":[[]]},{"id":"3df9556691430286","type":"api-call-service","z":"f887527c.ee532","name":"Turn on master light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_master","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1380,"y":1080,"wires":[["8ee7ca9.63b3338"]]},{"id":"2c9cf2b35bd66d37","type":"api-call-service","z":"f887527c.ee532","name":"Turn on living room WLEDs","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.living_room_wled","data":"{\"brightness\":100, \"transition\": 0, \"rgb_color\":[231, 159, 231]}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1500,"y":860,"wires":[[]]},{"id":"83b2d6f845254954","type":"debug","z":"f887527c.ee532","name":"Deconz","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":260,"y":1240,"wires":[]},{"id":"a58214de29b0f683","type":"debug","z":"f887527c.ee532","name":"Kids light","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1160,"y":1480,"wires":[]},{"id":"38083d57e032e8aa","type":"api-current-state","z":"f887527c.ee532","name":"Kids ceiling light","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"light.kids_ceiling_light","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":940,"y":1420,"wires":[["f9a048f0.beebf8","a58214de29b0f683"]]},{"id":"0f6af76b35895ea8","type":"api-call-service","z":"f887527c.ee532","name":"Turn on hallway light(s)","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":\"group.hallway_lights\", \"brightness\":255, \"transition\": 0, \"color_name\":\"white\"}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":930,"y":2020,"wires":[[]]},{"id":"2ae7ac89.90aa44","type":"api-current-state","z":"6a88055e.a0ae5c","name":"AC is set on cooling","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"cool","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.living_room_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":980,"y":2120,"wires":[["3654ffe7.e0fa7"],[]]},{"id":"fc7995df.038688","type":"ha-wait-until","z":"6a88055e.a0ae5c","name":"Wait 1 minute to close","server":"8501408e.93b69","outputs":2,"entityId":"binary_sensor.living_room_window","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"minutes","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":720,"y":2120,"wires":[[],["2ae7ac89.90aa44"]]},{"id":"fe8edf8e.8e93","type":"server-state-changed","z":"6a88055e.a0ae5c","name":"Living room window is opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.living_room_window","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":160,"y":2160,"wires":[[],[]]},{"id":"45bce358.26340c","type":"api-current-state","z":"6a88055e.a0ae5c","name":"AC is set on cooling","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"cool","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.living_room_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":440,"y":2200,"wires":[["fc7995df.038688"],[]]},{"id":"9cfd90be.7b6da","type":"api-current-state","z":"6a88055e.a0ae5c","name":"Bedroom AC is not on cool","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"cool","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"climate.bedroom_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1000,"y":1420,"wires":[["d31d27d3.b6d438"],[]]},{"id":"9ee8631e.02d75","type":"ha-wait-until","z":"6a88055e.a0ae5c","name":"Wait 1 minute to close","server":"8501408e.93b69","outputs":2,"entityId":"binary_sensor.bedroom_window","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"minutes","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":700,"y":1420,"wires":[[],["9cfd90be.7b6da"]]},{"id":"8ba87713.ef62b8","type":"server-state-changed","z":"6a88055e.a0ae5c","name":"Bedroom window is opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bedroom_window","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":140,"y":1440,"wires":[[],[]]},{"id":"2385aa59.5ce1a6","type":"api-current-state","z":"6a88055e.a0ae5c","name":"Bedroom cooling is on","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"cool","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.bedroom_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":420,"y":1460,"wires":[["9ee8631e.02d75"],[]]},{"id":"33a51bc6.0c4d84","type":"time-range-switch","z":"6a88055e.a0ae5c","name":"Is it after bedtime?","lat":"47.158455","lon":"27.601442","startTime":"23:30","endTime":"09:00","startOffset":"","endOffset":"","x":510,"y":1560,"wires":[["d18a1d77.4884"],["8d5f67b5.1e83f8"]]},{"id":"6bf4dcf8.eb8d34","type":"server-state-changed","z":"6a88055e.a0ae5c","name":"Living room cooling turned on","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"switch.living_room_cooling","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":160,"y":2240,"wires":[[],[]]},{"id":"3654ffe7.e0fa7","type":"subflow:3134fb52.d06d64","z":"6a88055e.a0ae5c","name":"","env":[{"name":"message","value":"\"The living room window is opened and the AC is on\"","type":"str"},{"name":"target","value":"[\"media_player.hallway_echo_dot\",\"media_player.kitchen_echo_dot\",\"media_player.office_echo_dot\",\"media_player.living_room_echo_dot\"]","type":"json"}],"x":850,"y":2260,"wires":[["fc7995df.038688"],[]]},{"id":"f70712b6.4f29e","type":"inject","z":"6a88055e.a0ae5c","name":"Check for sleep mode","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"3600","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":230,"y":1560,"wires":[["33a51bc6.0c4d84"]]},{"id":"d31d27d3.b6d438","type":"subflow:3134fb52.d06d64","z":"6a88055e.a0ae5c","name":"Notify the AC is on","env":[{"name":"broadcast","type":"bool","value":"true"},{"name":"message","value":"\"The bedroom window is opened and the AC is on\"","type":"str"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"kitchen_echo_dot","type":"bool","value":"false"}],"x":875,"y":1480,"wires":[["9ee8631e.02d75"],[]],"l":false},{"id":"d18a1d77.4884","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn on sleep mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.sleep_mode","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":820,"y":1520,"wires":[[]]},{"id":"8d5f67b5.1e83f8","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn off sleep mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.sleep_mode","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":820,"y":1620,"wires":[[]]},{"id":"6f1a3aed.410f74","type":"server-state-changed","z":"6a88055e.a0ae5c","name":"Temperature is higher than 25 degrees","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.bedroom_temperature","entityidfiltertype":"exact","outputinitially":true,"state_type":"num","haltifstate":"25","halt_if_type":"num","halt_if_compare":"gte","outputs":2,"output_only_on_state_change":true,"x":170,"y":1860,"wires":[["a30bc73e.d742d8"],[]]},{"id":"ef92cf56.6cbbd","type":"api-current-state","z":"6a88055e.a0ae5c","name":"Bedroom AC is off","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"climate.bedroom_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":450,"y":1780,"wires":[["4f5e80a0.af87c"],[]]},{"id":"3154c0f2.f5251","type":"debug","z":"6a88055e.a0ae5c","name":"Turned on bedroom AC due to high temperature","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1675,"y":1009,"wires":[]},{"id":"a30bc73e.d742d8","type":"api-current-state","z":"6a88055e.a0ae5c","name":"Bedroom auto climate is on","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.bedroom_climate","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":500,"y":1960,"wires":[["f4173169.e34d9"],[]],"icon":"node-red/alert.svg"},{"id":"6fa84996.dad698","type":"api-current-state","z":"6a88055e.a0ae5c","name":"Bedroom AC is on","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"climate.bedroom_ac","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1030,"y":2000,"wires":[["72a4017c.9d2f3"],[]]},{"id":"72a4017c.9d2f3","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn off bedroom AC","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"climate","service":"turn_off","entityId":"climate.bedroom_ac","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1080,"y":1900,"wires":[["20d8a70.21eab5a"]]},{"id":"4f5e80a0.af87c","type":"function","z":"6a88055e.a0ae5c","name":"Set AC parameters","func":"const globalHomeAssistant = global.get('homeassistant');\nvar automaticBedroomClimateIsOn = globalHomeAssistant.homeAssistant.states[\"input_boolean.bedroom_climate\"].state;\nif(automaticBedroomClimateIsOn == \"off\"){\n    return msg;\n}   \nvar familyState = globalHomeAssistant.homeAssistant.states[\"group.family\"].state;\nif(familyState == 'home'){\n    msg.speed = 'Quiet';\n}\nelse{\n    msg.speed = 'Turbo';\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":1740,"wires":[["8c83837b.dbf43"]]},{"id":"6b4d302b.0dea2","type":"subflow:3251ae8.f170952","z":"6a88055e.a0ae5c","name":"Turn on bedroom AC quiet mode","env":[{"name":"fan_mode","value":"Quiet","type":"str"},{"name":"swing_mode","value":"Swing in the upmost region","type":"str"}],"x":1210,"y":1700,"wires":[["1ce6896e.ab3897","3154c0f2.f5251"]]},{"id":"8c83837b.dbf43","type":"switch","z":"6a88055e.a0ae5c","name":"Set speed","property":"speed","propertyType":"msg","rules":[{"t":"eq","v":"Quiet","vt":"str"},{"t":"eq","v":"Turbo","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":960,"y":1740,"wires":[["6b4d302b.0dea2"],["21479e85.fe6952"]]},{"id":"21479e85.fe6952","type":"subflow:3251ae8.f170952","z":"6a88055e.a0ae5c","name":"Turn on bedroom AC turbo mode","env":[],"x":1175,"y":1809,"wires":[[]]},{"id":"1ce6896e.ab3897","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Send notification","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"notify","service":"mobile_app_galaxys9","entityId":"","data":"{\"message\":\"Turned bedroom AC on\",\"title\": \"Bedroom temperature too high\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1585,"y":1069,"wires":[[]]},{"id":"f91aa8f4.4f4698","type":"subflow:89424b4c.e0c868","z":"6a88055e.a0ae5c","name":"Restart AC","env":[],"x":860,"y":1900,"wires":[[]]},{"id":"20d8a70.21eab5a","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Send notification","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"notify","service":"mobile_app_s22bogdan","entityId":"","data":"{\"message\":\"Bedroom temperature back to normal\",\"title\": \"Bedroom AC turned off\"}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1295,"y":1369,"wires":[[]]},{"id":"f4173169.e34d9","type":"api-current-state","z":"6a88055e.a0ae5c","name":"If temperature is below 24.5","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"25","halt_if_type":"num","halt_if_compare":"lte","override_topic":false,"entity_id":"sensor.bedroom_temperature","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":780,"y":2000,"wires":[["6fa84996.dad698"],[]]},{"id":"4dbd9dbc.c601e4","type":"subflow:c28ba6b7.4557d8","z":"6a88055e.a0ae5c","name":"","env":[{"name":"name","value":"Heating","type":"str"},{"name":"message","value":"Turned on","type":"str"},{"name":"domain","value":"switch","type":"str"},{"name":"entity_id","value":"switch.heating","type":"str"}],"x":1335,"y":709,"wires":[[]]},{"id":"e653b585.0036e8","type":"subflow:c28ba6b7.4557d8","z":"6a88055e.a0ae5c","name":"Log heating turned off by Node-Red","env":[{"name":"name","value":"Heating","type":"str"},{"name":"message","value":"Thermostats turned off due to opened window","type":"str"},{"name":"domain","value":"sensor","type":"str"},{"name":"entity_id","value":"sensor.heating","type":"str"}],"x":995,"y":949,"wires":[[]]},{"id":"d365a5bd.e33e68","type":"subflow:c28ba6b7.4557d8","z":"6a88055e.a0ae5c","name":"","env":[{"name":"name","value":"Heating","type":"str"},{"name":"message","value":"Thermostats turned off","type":"str"},{"name":"domain","value":"sensor","type":"str"},{"name":"entity_id","value":"sensor.heating","type":"str"}],"x":95,"y":949,"wires":[[]]},{"id":"76244580.5fd61c","type":"change","z":"6a88055e.a0ae5c","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":605,"y":549,"wires":[["b0ee4a43.aa8878","68766dfc.100dc4","417f8b92.a885d4"]]},{"id":"b0ee4a43.aa8878","type":"delay","z":"6a88055e.a0ae5c","name":"Wait 1 hour","pauseType":"delay","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":905,"y":529,"wires":[["aeb5272a.c22628","417f8b92.a885d4"]]},{"id":"eed40cc4.7e873","type":"server-state-changed","z":"6a88055e.a0ae5c","name":"Average temperature changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.hallway_temperature","entityidfiltertype":"exact","outputinitially":true,"state_type":"num","haltifstate":"","halt_if_type":"num","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":135,"y":549,"wires":[[]]},{"id":"223a3437.336b1c","type":"switch","z":"6a88055e.a0ae5c","name":"Check temperature","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"23","vt":"str"},{"t":"btwn","v":"22.5","vt":"num","v2":"23","v2t":"num"},{"t":"lt","v":"22.5","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":385,"y":549,"wires":[[],["76244580.5fd61c"],["8acefd96.64902"]]},{"id":"2b2472ce.a54bce","type":"server-state-changed","z":"6a88055e.a0ae5c","name":"Thermostats are on","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.heating","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":125,"y":829,"wires":[["343a37c4.ea8d58"],["c3e20c38.7b41a"]]},{"id":"90cca018.b0cf1","type":"subflow:c28ba6b7.4557d8","z":"6a88055e.a0ae5c","name":"","env":[{"name":"name","value":"Heating","type":"str"},{"name":"message","value":"Turned on","type":"str"},{"name":"domain","value":"switch","type":"str"},{"name":"entity_id","value":"switch.heating","type":"str"}],"x":675,"y":709,"wires":[[]]},{"id":"40fbdf4a.59f82","type":"subflow:c28ba6b7.4557d8","z":"6a88055e.a0ae5c","name":"Logbook","env":[{"name":"name","value":"Heating","type":"str"},{"name":"message","value":"Turned off","type":"str"},{"name":"domain","value":"switch","type":"str"},{"name":"entity_id","value":"switch.heating","type":"str"}],"x":215,"y":709,"wires":[[]]},{"id":"9cc98dca.e6e09","type":"debug","z":"6a88055e.a0ae5c","name":"Window","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":495,"y":889,"wires":[]},{"id":"343a37c4.ea8d58","type":"function","z":"6a88055e.a0ae5c","name":"Window state","func":"const globalHomeAssistant = global.get('homeassistant');\n\nvar livingRoom = globalHomeAssistant.homeAssistant.states[\"binary_sensor.living_room_window\"].state == \"on\";\nvar bedroomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.bedroom_window\"].state == \"on\";\nvar bathroomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.bathroom_window\"].state == \"on\";\nvar kitchenWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.kitchen_window\"].state == \"on\";\nvar kidsWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.kids_window\"].state == \"on\";\nvar temperature = globalHomeAssistant.homeAssistant.states[\"sensor.hallway_temperature\"].state;\n\nmsg.payload = livingRoom\n  || bedroomWindow\n  || bathroomWindow\n  || kitchenWindow\n  || kidsWindow;\nvar count = 0;\nvar windows = \"\";\nif (msg.payload) {\n    msg.living = livingRoom;\n  if (livingRoom === true) {\n    windows += \"living room, \";\n    count++;\n  }\n  if (bedroomWindow === true) {\n    windows += \"bedroom, \";\n    count++;\n  }\n  if (bathroomWindow === true) {\n    windows += \"bathroom, \";\n    count++;\n  }\n\n  if (kitchenWindow === true) {\n    windows += \"kitchen, \";\n    count++;\n  }\n  if (kidsWindow === true) {\n    windows += \"kids room\";\n    count++;\n  }\n  msg.windows = windows;\n  var message = '';\n  if (count > 1) {\n    message = \"There are \" + count + \" windows opened, \" + windows + \". Please close them in order to resume heating.\";\n  }\n  else{\n    \n    message = \"Please close the \" + windows.replace(\",\", \"\") + \" window in order to resume heating\";\n  }\n  global.set(\"AlexaMessage\", message);\n  msg.alexa = message;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":335,"y":949,"wires":[[]]},{"id":"44a38ba.59b2374","type":"switch","z":"6a88055e.a0ae5c","name":"Window is opened","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":365,"y":1049,"wires":[["9b27ad82.e436f"],["c3e20c38.7b41a"]]},{"id":"b1dc8801.d91298","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn off heating","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.heating","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":695,"y":909,"wires":[["e653b585.0036e8","a4ffda8a.6efab8","b4320c03.7f16e","2ff305d4.b8c92a"]]},{"id":"a4ffda8a.6efab8","type":"subflow:3134fb52.d06d64","z":"6a88055e.a0ae5c","name":"Notify that a window is opened","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"}],"x":985,"y":909,"wires":[[],[]]},{"id":"b4320c03.7f16e","type":"subflow:b6e164fe.1d31e8","z":"6a88055e.a0ae5c","name":"Heating switch is off notification","env":[{"name":"message","value":"Heating switch turned off because windows are opened","type":"str"},{"name":"title","value":"Heating switch","type":"str"}],"x":985,"y":869,"wires":[[]]},{"id":"ebdd3276.8d57a","type":"subflow:b6e164fe.1d31e8","z":"6a88055e.a0ae5c","name":"Notify S9+","env":[{"name":"message","value":"Heating will start in 1 hour","type":"str"},{"name":"title","value":"Heating","type":"str"}],"x":1045,"y":629,"wires":[[]]},{"id":"abe44042.af969","type":"change","z":"6a88055e.a0ae5c","name":"Set wait started","rules":[{"t":"set","p":"heating_wait_started","pt":"flow","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":815,"y":609,"wires":[["b0ee4a43.aa8878","ebdd3276.8d57a"]]},{"id":"8acefd96.64902","type":"switch","z":"6a88055e.a0ae5c","name":"Check if waiting","property":"heating_wait_started","propertyType":"flow","rules":[{"t":"false"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":635,"y":589,"wires":[["abe44042.af969"],["abe44042.af969"]]},{"id":"f19a08d9.a67cb8","type":"inject","z":"6a88055e.a0ae5c","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"heating_wait_started","payloadType":"flow","x":165,"y":629,"wires":[["69fb0d4b.713b14"]]},{"id":"68766dfc.100dc4","type":"debug","z":"6a88055e.a0ae5c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":625,"y":509,"wires":[]},{"id":"417f8b92.a885d4","type":"change","z":"6a88055e.a0ae5c","name":"Set wait started","rules":[{"t":"set","p":"heating_wait_started","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1075,"y":569,"wires":[[]]},{"id":"69fb0d4b.713b14","type":"debug","z":"6a88055e.a0ae5c","name":"wait","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":465,"y":649,"wires":[]},{"id":"356aa06c.a24b8","type":"server-state-changed","z":"6a88055e.a0ae5c","name":"Heating select","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_select.heating_timer","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":130,"y":460,"wires":[["1c5cfdee.4e5a62","c5d1c033.8dd68"]]},{"id":"1c5cfdee.4e5a62","type":"debug","z":"6a88055e.a0ae5c","name":"state","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":330,"y":500,"wires":[]},{"id":"c5d1c033.8dd68","type":"subflow:fc1eaeb9.f5e16","z":"6a88055e.a0ae5c","name":"Turn on heating","env":[],"x":360,"y":420,"wires":[[]]},{"id":"c800fe63.84038","type":"subflow:fc1eaeb9.f5e16","z":"6a88055e.a0ae5c","name":"Turn off heating based on input","env":[],"x":565,"y":769,"wires":[[]]},{"id":"aeb5272a.c22628","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn on heating for 1.5 hours","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"{\"option\": \"1.5 hours\"}","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1155,"y":509,"wires":[[]]},{"id":"e851ca82.852618","type":"switch","z":"6a88055e.a0ae5c","name":"Check option","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":325,"y":769,"wires":[["c800fe63.84038"]]},{"id":"9b27ad82.e436f","type":"delay","z":"6a88055e.a0ae5c","name":"Wait 5 minutes","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":695,"y":1029,"wires":[["e2e48784.ebfe68"]]},{"id":"31ec5a86.d5b346","type":"switch","z":"6a88055e.a0ae5c","name":"Window is opened","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":705,"y":949,"wires":[["b1dc8801.d91298"],[]]},{"id":"c3e20c38.7b41a","type":"change","z":"6a88055e.a0ae5c","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":545,"y":1089,"wires":[["9b27ad82.e436f"]]},{"id":"e2e48784.ebfe68","type":"function","z":"6a88055e.a0ae5c","name":"Window state","func":"const globalHomeAssistant = global.get('homeassistant');\n\nvar livingRoom = globalHomeAssistant.homeAssistant.states[\"binary_sensor.living_room_window\"].state == \"on\";\nvar bedroomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.bedroom_window\"].state == \"on\";\nvar bathroomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.bathroom_window\"].state == \"on\";\nvar kitchenWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.kitchen_window\"].state == \"on\";\nvar kidsWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.kids_window\"].state == \"on\";\nvar temperature = globalHomeAssistant.homeAssistant.states[\"sensor.hallway_temperature\"].state;\n\nmsg.payload = livingRoom\n  || bedroomWindow\n  || bathroomWindow\n  || kitchenWindow\n  || kidsWindow;\nvar count = 0;\nvar windows = \"\";\nif (msg.payload) {\n    msg.living = livingRoom;\n  if (livingRoom === true) {\n    windows += \"living room, \";\n    count++;\n  }\n  if (bedroomWindow === true) {\n    windows += \"bedroom, \";\n    count++;\n  }\n  if (bathroomWindow === true) {\n    windows += \"bathroom, \";\n    count++;\n  }\n\n  if (kitchenWindow === true) {\n    windows += \"kitchen, \";\n    count++;\n  }\n  if (kidsWindow === true) {\n    windows += \"kids room\";\n    count++;\n  }\n  msg.windows = windows;\n  var message = '';\n  if (count > 1) {\n    message = \"There are \" + count + \" windows opened, \" + windows + \". Please close them in order to resume heating.\";\n  }\n  else{\n    \n    message = \"Please close the \" + windows.replace(\",\", \"\") + \" window in order to resume heating.\";\n  }\n  global.set(\"AlexaMessage\", message);\n  msg.alexa = message;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":695,"y":989,"wires":[["31ec5a86.d5b346"]]},{"id":"2ff305d4.b8c92a","type":"delay","z":"6a88055e.a0ae5c","name":"Wait 30 minutes","pauseType":"delay","timeout":"30","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":935,"y":1009,"wires":[["47aa10f3.04c49"]]},{"id":"47aa10f3.04c49","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn on heating","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.heating","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1115,"y":1009,"wires":[[]]},{"id":"8e585e128f875412","type":"inject","z":"6a88055e.a0ae5c","name":"Toggle heating","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"*/30 1-22 * * *","once":true,"onceDelay":"5","topic":"","payloadType":"date","x":180,"y":260,"wires":[[]]},{"id":"7d965b8bb21a92b9","type":"subflow:c28ba6b7.4557d8","z":"6a88055e.a0ae5c","name":"Heating log","env":[{"name":"name","value":"switch.heating","type":"str"},{"name":"message","value":"Toggled heating","type":"str"},{"name":"domain","value":"switch","type":"str"},{"name":"entity_id","value":"switch.heating","type":"str"}],"x":1030,"y":140,"wires":[[]]},{"id":"16137b69063b01bc","type":"api-current-state","z":"6a88055e.a0ae5c","name":"Heating is on","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"switch.heating","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":330,"y":80,"wires":[["6ccf27e0d6fd95e0"],["0092a11bac878872"]]},{"id":"6ccf27e0d6fd95e0","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn off heating","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_off","entityId":"switch.heating","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":800,"y":80,"wires":[["fd80458526a540fe","7d965b8bb21a92b9"]]},{"id":"c94ceb20da1f4de7","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn on heating","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_on","entityId":"switch.heating","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":840,"y":220,"wires":[["85f2c9bf5aa45c38","7d965b8bb21a92b9"]]},{"id":"fd80458526a540fe","type":"delay","z":"6a88055e.a0ae5c","name":"Wait 1 hour","pauseType":"delay","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1050,"y":40,"wires":[["16137b69063b01bc"]]},{"id":"85f2c9bf5aa45c38","type":"delay","z":"6a88055e.a0ae5c","name":"Wait 30 minutes","pauseType":"delay","timeout":"30","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1040,"y":240,"wires":[["16137b69063b01bc"]]},{"id":"0092a11bac878872","type":"api-current-state","z":"6a88055e.a0ae5c","name":"Avg Temperature < 23.5?","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"23.5","halt_if_type":"num","halt_if_compare":"lte","override_topic":false,"entity_id":"sensor.average_temperature","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":570,"y":220,"wires":[["c94ceb20da1f4de7"],[]]},{"id":"77063fdfdd30c58a","type":"inject","z":"6a88055e.a0ae5c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":320,"wires":[["a6a8a3698d5994f3"]]},{"id":"af47c4ca7652569e","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn on heating","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_on","entityId":"switch.heating","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":600,"y":320,"wires":[["2f2d6638090ffde5"]]},{"id":"2f2d6638090ffde5","type":"subflow:c28ba6b7.4557d8","z":"6a88055e.a0ae5c","name":"Heating log","env":[{"name":"name","value":"switch.heating","type":"str"},{"name":"message","value":"Toggled heating","type":"str"},{"name":"domain","value":"switch","type":"str"},{"name":"entity_id","value":"switch.heating","type":"str"}],"x":790,"y":320,"wires":[[]]},{"id":"304398d4c8a58e46","type":"inject","z":"6a88055e.a0ae5c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 05 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":380,"wires":[["b88725d6bda4fc5f"]]},{"id":"b88725d6bda4fc5f","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn off heating","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_off","entityId":"switch.heating","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":380,"y":380,"wires":[[]]},{"id":"4b93cfc50901aac3","type":"delay","z":"6a88055e.a0ae5c","name":"Wait 1 hour","pauseType":"delay","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":650,"y":380,"wires":[[]]},{"id":"8581d5028086beda","type":"server-state-changed","z":"6a88055e.a0ae5c","name":"","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.heating","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"2","forType":"num","forUnits":"hours","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":650,"y":440,"wires":[["7d7a088b7cd47ee8"],[]]},{"id":"7d7a088b7cd47ee8","type":"api-call-service","z":"6a88055e.a0ae5c","name":"Turn off heating","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_off","entityId":"switch.heating","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":940,"y":400,"wires":[["92c1b296f085baa7"]]},{"id":"92c1b296f085baa7","type":"subflow:c28ba6b7.4557d8","z":"6a88055e.a0ae5c","name":"Heating log","env":[{"name":"name","value":"switch.heating","type":"str"},{"name":"message","value":"Toggled heating","type":"str"},{"name":"domain","value":"switch","type":"str"},{"name":"entity_id","value":"switch.heating","type":"str"}],"x":1150,"y":400,"wires":[[]]},{"id":"a6a8a3698d5994f3","type":"api-current-state","z":"6a88055e.a0ae5c","name":"Check vacation mode","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"false","halt_if_type":"bool","halt_if_compare":"is","override_topic":true,"entity_id":"input_boolean.vacation_mode","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":380,"y":320,"wires":[["af47c4ca7652569e"],[]]},{"id":"45b097c0.7b8338","type":"server-state-changed","z":"a8a94d13.5469f","name":"Bedroom lightstrip turned on","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"light.bedroom_lightstrip","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":140,"y":40,"wires":[["20088de2.f83222"],[]]},{"id":"20088de2.f83222","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after sunrise","lat":"47.158455","lon":"27.601442","startTime":"sunrise","endTime":"sunset","startOffset":"","endOffset":"60","x":400,"y":40,"wires":[["97b8313cdfcade8b"],[]]},{"id":"2c853713.ec0988","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn off bedroom lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.bedroom_lightstrip","data":"{\"transition\":1}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":850,"y":40,"wires":[[]]},{"id":"5e4f98e0.d38dd8","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on kitchen lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.kitchen_lights","data":"{\"brightness\":255, \"color_temp\":120, \"transition\":1}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":740,"y":100,"wires":[["9e226fe4.1acf1"]]},{"id":"ec4016e6.55e0b8","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"brightness\": 150}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1140,"y":180,"wires":[[]]},{"id":"7990a597.c554ac","type":"server-state-changed","z":"a8a94d13.5469f","name":"Office movement","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_presence","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":100,"y":220,"wires":[["7cf79a2c.484ca4"],["896d4a1d.c4bcb8"]]},{"id":"836fae2d.fb3fa","type":"server-state-changed","z":"a8a94d13.5469f","name":"Living room movement","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.living_room_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":120,"y":320,"wires":[["ce748e4a.fee84"],[]]},{"id":"4d749f6f.ca5e7","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on living room lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.living_room_lights","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1190,"y":340,"wires":[[]]},{"id":"955decb6.f817e","type":"server-state-changed","z":"a8a94d13.5469f","name":"Bathroom movement","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bathroom_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":110,"y":800,"wires":[["7a669e4.e78ff6","f507d9a5.5beed8"],["438148ce.3f9318"]]},{"id":"5f374b0e.dd7274","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on bathroom lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.bathroom_ceiling_light","data":"{\"brightness\":255, \"color_temp\":120,\"transition\":1}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":870,"y":760,"wires":[["8b96050c.a398d8"]]},{"id":"7219a371.74aa2c","type":"server-state-changed","z":"a8a94d13.5469f","name":"Hallway movement","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.hallway_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":110,"y":440,"wires":[["b4cd0b08.db98d8"],[]]},{"id":"429c82e0.225bcc","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on hallway lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.hallway_lights","data":"{\"brightness\":255,\"transition\":1}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":900,"y":540,"wires":[[]]},{"id":"b4cd0b08.db98d8","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after sunset?","lat":"47.158455","lon":"27.601442","startTime":"sunset","endTime":"sunrise","startOffset":"-60","endOffset":"60","x":390,"y":440,"wires":[["3a78bd02.97f612"],["949a33f8.c32fc"]]},{"id":"7a669e4.e78ff6","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after sunset?","lat":"47.158455","lon":"27.601442","startTime":"sunset","endTime":"sunrise","startOffset":"-60","endOffset":"60","x":470,"y":720,"wires":[["e87fcd517561bfab"],[]]},{"id":"81c08865.d5a5e8","type":"api-call-service","z":"a8a94d13.5469f","name":"Send notification","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"notify","service":"notify","entityId":"","data":"{\"message\":\"Lavinia is awake\", \"title\":\"Motion in the baby crib\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":730,"y":1080,"wires":[[]]},{"id":"fc1ebef4.f41a","type":"server-state-changed","z":"a8a94d13.5469f","name":"Bedroom movement","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bedroom_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":110,"y":1020,"wires":[["2b43e0ae.108df"]]},{"id":"2b43e0ae.108df","type":"api-current-state","z":"a8a94d13.5469f","name":"Notification is enabled","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.notification_for_bedroom_motion","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":380,"y":1020,"wires":[["d5888205.d5e77","81c08865.d5a5e8","b445e5c1.b52258"],[]]},{"id":"d5888205.d5e77","type":"api-call-service","z":"a8a94d13.5469f","name":"Toggle lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"toggle","entityId":"group.hallway_lights, group.kitchen_lights, group.living_room_lights, light.bathroom_ceiling_light, light.office_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":710,"y":960,"wires":[[]]},{"id":"e8e54d34.40d05","type":"api-call-service","z":"a8a94d13.5469f","name":"Toggle lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"toggle","entityId":"group.hallway_lights, group.kitchen_lights, group.living_room_couch_lights, light.bathroom_ceiling_light, light.office_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1210,"y":960,"wires":[[]]},{"id":"ce748e4a.fee84","type":"api-current-state","z":"a8a94d13.5469f","name":"Is the TV off?","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"media_player.philips_tv","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":350,"y":360,"wires":[["74e55973.586d48"],[]]},{"id":"74e55973.586d48","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after sunset?","lat":"47.158455","lon":"27.601442","startTime":"sunset","endTime":"sunrise","startOffset":"-60","endOffset":"60","x":590,"y":320,"wires":[["4d749f6f.ca5e7"],[]]},{"id":"3a78bd02.97f612","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after 21:45?","lat":"47.158455","lon":"27.601442","startTime":"21:45","endTime":"06:00","startOffset":"","endOffset":"","x":680,"y":440,"wires":[["746f0676.711b78"],["429c82e0.225bcc"]]},{"id":"746f0676.711b78","type":"api-call-service","z":"a8a94d13.5469f","name":"Dim hallway lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.hallway_lights","data":"{\"brightness\":55, \"color_temp\":120,\"transition\":2}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":930,"y":400,"wires":[[]]},{"id":"512fd63f.1f64d8","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn off bathroom lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.bathroom_ceiling_light","data":"{\"transition\":1}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":850,"y":840,"wires":[["e670b610.101638"]]},{"id":"438148ce.3f9318","type":"ha-wait-until","z":"a8a94d13.5469f","name":"Wait for motion for 15 minutes","server":"8501408e.93b69","outputs":2,"entityId":"binary_sensor.bathroom_motion_sensor","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"15","timeoutType":"num","timeoutUnits":"minutes","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":470,"y":860,"wires":[[],["512fd63f.1f64d8"]]},{"id":"f80c93d5.4bfc3","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after sunset?","lat":"47.158455","lon":"27.601442","startTime":"sunset","endTime":"sunrise","startOffset":"-60","endOffset":"60","x":350,"y":140,"wires":[["5e4f98e0.d38dd8"],["dfa322c8.7da53"]]},{"id":"dfa322c8.7da53","type":"api-current-state","z":"a8a94d13.5469f","name":"Light too low","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"30","halt_if_type":"num","halt_if_compare":"lte","override_topic":false,"entity_id":"sensor.kitchen_light_level","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":590,"y":160,"wires":[["5e4f98e0.d38dd8"],[]]},{"id":"f507d9a5.5beed8","type":"api-current-state","z":"a8a94d13.5469f","name":"Light too low","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"40","halt_if_type":"num","halt_if_compare":"lte","override_topic":false,"entity_id":"sensor.bathroom_light_level","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":490,"y":780,"wires":[["5f374b0e.dd7274"],[]]},{"id":"b445e5c1.b52258","type":"subflow:3134fb52.d06d64","z":"a8a94d13.5469f","name":"Send Alexa notification","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"There's motion in the bedroom.","type":"str"},{"name":"volumeLevel","value":"4","type":"num"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"}],"x":740,"y":1020,"wires":[[],[]]},{"id":"9074cb29.a23918","type":"server-state-changed","z":"a8a94d13.5469f","name":"Kitchen movement","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"group.kitchen_motion","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":110,"y":140,"wires":[["f80c93d5.4bfc3"],[]]},{"id":"8b96050c.a398d8","type":"api-call-service","z":"a8a94d13.5469f","name":"Logbook","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"logbook","service":"log","entityId":"light.bathroom_ceiling_light","data":"{\"name\":\"light.bathroom_ceiling_light\",\"domain\":\"light\",\"message\":\"Turned on by motion\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1070,"y":780,"wires":[[]]},{"id":"e670b610.101638","type":"api-call-service","z":"a8a94d13.5469f","name":"Logbook","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"logbook","service":"log","entityId":"light.bathroom_ceiling_light","data":"{\"name\":\"Bathroom ceiling light\",\"domain\":\"light\",\"message\":\"Turned off after no motion detected\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1060,"y":860,"wires":[[]]},{"id":"949a33f8.c32fc","type":"api-current-state","z":"a8a94d13.5469f","name":"Light too low","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"10","halt_if_type":"num","halt_if_compare":"lte","override_topic":false,"entity_id":"sensor.hallway_light_level","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":610,"y":520,"wires":[["429c82e0.225bcc"],[]]},{"id":"2f0b043d.8199ac","type":"server-state-changed","z":"a8a94d13.5469f","name":"Bathroom door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bathroom_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":120,"y":920,"wires":[["828275c.8ee1d88"],[]]},{"id":"828275c.8ee1d88","type":"api-current-state","z":"a8a94d13.5469f","name":"Bathroom light is off","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.bathroom_ceiling_light","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":370,"y":920,"wires":[["f507d9a5.5beed8"],[]]},{"id":"318f3949.1c9796","type":"server-state-changed","z":"a8a94d13.5469f","name":"Kids room movement","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.kids_room_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":120,"y":1180,"wires":[["23b391cd.7f9b0e","86b47af1.ddf768"],[]]},{"id":"f46d6d1d.37921","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on kids light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.sonoff_kids_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":850,"y":1120,"wires":[[]]},{"id":"23b391cd.7f9b0e","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after sunset?","lat":"47.158455","lon":"27.601442","startTime":"sunset","endTime":"sunrise","startOffset":"-60","endOffset":"60","x":390,"y":1160,"wires":[["9cb308cd.ecf838"],["b0b07d64.09eae"]]},{"id":"b0b07d64.09eae","type":"api-current-state","z":"a8a94d13.5469f","name":"Light too low","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"10","halt_if_type":"num","halt_if_compare":"lte","override_topic":false,"entity_id":"sensor.hallway_light_level","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":690,"y":1220,"wires":[["f46d6d1d.37921"],[]]},{"id":"8b42faff.df2908","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn off kids light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.sonoff_kids_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":670,"y":1280,"wires":[[]]},{"id":"86b47af1.ddf768","type":"change","z":"a8a94d13.5469f","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":1220,"wires":[[]]},{"id":"ace9df42.91c94","type":"delay","z":"a8a94d13.5469f","name":"Wait 1 minute","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":380,"y":1280,"wires":[["8b42faff.df2908"]]},{"id":"7cf79a2c.484ca4","type":"change","z":"a8a94d13.5469f","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":220,"wires":[["896d4a1d.c4bcb8"]]},{"id":"896d4a1d.c4bcb8","type":"delay","z":"a8a94d13.5469f","name":"20","pauseType":"delay","timeout":"20","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":950,"y":280,"wires":[["9aac42de.d323c","285f51f9190aa87e"]]},{"id":"9aac42de.d323c","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn off office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.office_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1200,"y":220,"wires":[[]]},{"id":"9e226fe4.1acf1","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on kitchen lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.kitchen_hue_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1170,"y":60,"wires":[[]]},{"id":"9cb308cd.ecf838","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after 23?","lat":"47.158455","lon":"27.601442","startTime":"22:30","endTime":"06:00","startOffset":"","endOffset":"","x":610,"y":1140,"wires":[[],["f46d6d1d.37921"]]},{"id":"82c504cf.c6e1e8","type":"api-current-state","z":"a8a94d13.5469f","name":"Is the theater mode off?","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"false","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.living_room_theater_mode","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":810,"y":360,"wires":[[],[]]},{"id":"7b0a4554.e9847c","type":"inject","z":"a8a94d13.5469f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":1100,"wires":[["2b43e0ae.108df"]]},{"id":"9ed2114a31a0d00d","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on office lamps","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.office_hue_lamps","data":"{\"brightness\": 150}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1340,"y":140,"wires":[[]]},{"id":"285f51f9190aa87e","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn off office lamps","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"group.office_hue_lamps","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1180,"y":280,"wires":[[]]},{"id":"94491ecae4c87e6a","type":"api-call-service","z":"a8a94d13.5469f","name":"Turn on hallway lights full brightness","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.hallway_lights","data":"{\"brightness\":255, \"color_temp\":120,\"transition\":1}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":970,"y":620,"wires":[[]]},{"id":"c0c4ac38141230a6","type":"inject","z":"a8a94d13.5469f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":320,"y":540,"wires":[[]]},{"id":"97b8313cdfcade8b","type":"stoptimer3","z":"a8a94d13.5469f","duration":"5","durationType":"num","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":580,"y":40,"wires":[[],[]]},{"id":"e87fcd517561bfab","type":"time-range-switch","z":"a8a94d13.5469f","name":"Is it after 1AM?","lat":"47.158455","lon":"27.601442","startTime":"02:00","endTime":"06:00","startOffset":"","endOffset":"","x":700,"y":680,"wires":[["2acb547ac4257d2c"],["5f374b0e.dd7274"]]},{"id":"2acb547ac4257d2c","type":"api-call-service","z":"a8a94d13.5469f","name":"Dim bathroom lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.bathroom_ceiling_light","data":"{\"brightness\":55, \"color_temp\":120,\"transition\":1}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1060,"y":700,"wires":[[]]},{"id":"4af68b889d3b356f","type":"server-state-changed","z":"a8a94d13.5469f","name":"Wled state changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"light.wled_living_room_1","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":170,"y":1400,"wires":[["648c04e773577a12"]]},{"id":"c39fd1c0777914fb","type":"server-state-changed","z":"a8a94d13.5469f","name":"Wled state changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"light.wled_living_room_2","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":170,"y":1460,"wires":[[]]},{"id":"648c04e773577a12","type":"switch","z":"a8a94d13.5469f","name":"Brightness bigger than 200","property":"data.new_state.attributes.brightness","propertyType":"msg","rules":[{"t":"gte","v":"200","vt":"str"},{"t":"lte","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":1400,"wires":[["3ad45c35bb5b93a8"],[]]},{"id":"3ad45c35bb5b93a8","type":"api-call-service","z":"a8a94d13.5469f","name":"Lower brightness","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.wled_living_room_1, light.wled_living_room_2","data":"{\"brightness\":200}","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":770,"y":1420,"wires":[[]]},{"id":"b7914c5b.31bbe","type":"inject","z":"a0f75c9.32211a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"3600","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":135,"y":444,"wires":[["bd94234a.de22e"]]},{"id":"bd94234a.de22e","type":"graphql","z":"a0f75c9.32211a","name":"Retrieve latest Hashnode articles","graphql":"1f7574fc.bef66b","format":"handlebars","syntax":"mustache","template":"{\n  user(username: \"bogdan\") {\n    publication {\n      posts(page: 0){\n        cuid,\n        title\n      }\n    }\n  }\n}","x":405,"y":444,"wires":[["9a1e51a8.609d5"],[]]},{"id":"9a1e51a8.609d5","type":"api-call-service","z":"a0f75c9.32211a","name":"Set last article","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"var","service":"set","entityId":"","data":"{\t  \"entity_id\": \"var.latest_hashnode_article_id\",\t  \"value\": msg.payload.user.publication.posts[0].cuid,\t  \"icon\": \"mdi:blogger\"\t}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":700,"y":440,"wires":[[]]},{"id":"898705ba.4ec108","type":"server-state-changed","z":"a0f75c9.32211a","name":"Listen to article id changes","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"var.latest_hashnode_article_id","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":130,"y":560,"wires":[["968e628d.b3eee","678b09d7.f23698"]]},{"id":"968e628d.b3eee","type":"subflow:3134fb52.d06d64","z":"a0f75c9.32211a","name":"Congratulate me when I post a new article","env":[{"name":"message","value":"\"Congratulations for posting a new article on Hashnode, you're all set for today!\"","type":"str"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"}],"x":540,"y":520,"wires":[[],[]]},{"id":"db473d55.dd114","type":"function","z":"a0f75c9.32211a","name":"Prepare Todoist Request","func":"msg.headers = {};\nmsg.method = \"POST\";\nmsg.url = \"https://api.todoist.com/sync/v8/sync\";\nvar taskId = \"4271193756\";\nmsg.payload = \"token=\"+msg.token+\"&commands=%5B%7B%22type%22%3A%20%22item_update_date_complete%22%2C%20%22uuid%22%3A%20%22\" +\n'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  }) + \"%22%2C%20%22args%22%3A%20%7B%22id%22%3A%20\" + taskId + \"%7D%7D%5D\"\nmsg.headers[\"content-type\"] = \"application/x-www-form-urlencoded\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":600,"wires":[["2620544b.a6a18c"]]},{"id":"2620544b.a6a18c","type":"http request","z":"a0f75c9.32211a","name":"Make POST request towards Todoist","method":"use","ret":"txt","paytoqs":"body","url":"https://api.todoist.com/sync/v8/sync","tls":"","persist":false,"proxy":"","authType":"","x":1130,"y":600,"wires":[[]]},{"id":"b22caf8d.84b8c","type":"ha-webhook","z":"a0f75c9.32211a","name":"Get Todoist stats","server":"8501408e.93b69","outputs":1,"webhookId":"6NhQ0Et2oSl2ZlGGD1850GBibN3cOnij","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"","headersLocationType":"none","x":86,"y":863,"wires":[["a1cf7f54.f61bf","8db2ff0.c7d38","49831a35.c93464","f5291fe5.80a6c","3eeaa6c9.457a1a","2a695b33.8eb334","3acceaff.882f56"]]},{"id":"a1cf7f54.f61bf","type":"api-call-service","z":"a0f75c9.32211a","name":"Set number of tasks completed today","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.completed_tasks_today","data":"{\"value\":msg.payload.completedToday}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":416,"y":843,"wires":[[]]},{"id":"8db2ff0.c7d38","type":"api-call-service","z":"a0f75c9.32211a","name":"Set today's remaining tasks","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.tasks_for_today","data":"{\"value\":msg.payload.remainingForToday}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":386,"y":903,"wires":[[]]},{"id":"49831a35.c93464","type":"api-call-service","z":"a0f75c9.32211a","name":"Set all tasks","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.all_tasks_count","data":"{\"value\":msg.payload.all}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":336,"y":1023,"wires":[[]]},{"id":"f5291fe5.80a6c","type":"api-call-service","z":"a0f75c9.32211a","name":"Set number of tasks completed for today","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.completed_tasks_for_today","data":"{\"value\":msg.payload.completedForToday}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":426,"y":783,"wires":[[]]},{"id":"2aed0ac8.33c856","type":"ha-webhook","z":"a0f75c9.32211a","name":"Steps webhook","server":"8501408e.93b69","outputs":1,"webhookId":"K7ypKl7ep1cRFq8pcYrLz2vD7N0SGYxs","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"","headersLocationType":"none","x":106,"y":1083,"wires":[["f8a33a17.aabad8","4d2570b43885fef6"]]},{"id":"f8a33a17.aabad8","type":"function","z":"a0f75c9.32211a","name":"Get steps count","func":"var stepsStr = msg.payload.replace(\"com.sec.android.app.shealth,\", \"\");\nvar arr = stepsStr.split(\" \")[0];\n\nvar steps = parseInt(arr);\nmsg.payload = steps;\nmsg.arr = arr;\nmsg.stepsStr = stepsStr;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":346,"y":1083,"wires":[["f9fa2d6b.9144d","4d2570b43885fef6"]]},{"id":"5b4a588b.aff6e8","type":"inject","z":"a0f75c9.32211a","name":"At 12 AM","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 12 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":130,"y":660,"wires":[["c6b6c47d.d29d88"]]},{"id":"f9fa2d6b.9144d","type":"api-call-service","z":"a0f75c9.32211a","name":"Set steps","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.bogdan_steps","data":"{\"value\":msg.payload, \"force_update\": msg.force_update}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":586,"y":1083,"wires":[["1f5aea13.74c0b6"]]},{"id":"7121dcec.4a1f94","type":"api-call-service","z":"a0f75c9.32211a","name":"Create family group","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"microsoft_face","service":"create_group","entityId":"","data":"{\"name\": \"Family\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":315,"y":3824,"wires":[[]]},{"id":"8632f403.cce598","type":"api-call-service","z":"a0f75c9.32211a","name":"Create person","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"microsoft_face","service":"create_person","entityId":"","data":"{\"group\":\"Family\",\"name\":\"Bogdan Bujdea\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":585,"y":3864,"wires":[["7a081094.ed41b"]]},{"id":"76547103.17f01","type":"api-call-service","z":"a0f75c9.32211a","name":"Create face","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"microsoft_face","service":"face_person","entityId":"","data":"{\"group\":\"family\",\"person\":\"{c07b1846-03ed-41aa-8c7f-fdea7bdde1e5}\",\"camera_entity\":\"camera.kitchen_tablet_camera\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":375,"y":3884,"wires":[[]]},{"id":"96f256cd.926568","type":"api-call-service","z":"a0f75c9.32211a","name":"Detect kitchen identity","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"image_processing","service":"scan","entityId":"","data":"{\"entity_id\":\"image_processing.kitchen_identity_camera\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":485,"y":3984,"wires":[["a6c9fa8d.389068"]]},{"id":"a6c9fa8d.389068","type":"api-call-service","z":"a0f75c9.32211a","name":"Detect kitchen face","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"image_processing","service":"scan","entityId":"","data":"{\"entity_id\":\"image_processing.kitchen_face_camera\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":755,"y":3984,"wires":[[]]},{"id":"7a081094.ed41b","type":"api-call-service","z":"a0f75c9.32211a","name":"Create person","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"microsoft_face","service":"create_person","entityId":"","data":"{\"group\":\"Family\",\"name\":\"Elena Bujdea\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":785,"y":3864,"wires":[["d3f4561e.97b098"]]},{"id":"d3f4561e.97b098","type":"api-call-service","z":"a0f75c9.32211a","name":"Create person","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"microsoft_face","service":"create_person","entityId":"","data":"{\"group\":\"Family\",\"name\":\"Razvan Bujdea\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":765,"y":3924,"wires":[[]]},{"id":"bbc8be24.ad9","type":"server-state-changed","z":"a0f75c9.32211a","name":"Kitchen camera","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"image_processing.kitchen_identity_camera","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"unknown","halt_if_type":"str","halt_if_compare":"is_not","outputs":2,"output_only_on_state_change":false,"x":145,"y":4224,"wires":[[],[]]},{"id":"d2eef775.d167f8","type":"server-state-changed","z":"a0f75c9.32211a","name":"Bedroom camera","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"image_processing.bedroom_identity_camera","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":185,"y":4304,"wires":[[]]},{"id":"a1849991.a44428","type":"server-state-changed","z":"a0f75c9.32211a","name":"Kitchen hue motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.kitchen_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":95,"y":3944,"wires":[[],[]]},{"id":"efd09539.85b3e8","type":"server-state-changed","z":"a0f75c9.32211a","name":"Kitchen tradfri motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.kitchen_table_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":105,"y":4004,"wires":[[],[]]},{"id":"e8f4b14d.58413","type":"server-state-changed","z":"a0f75c9.32211a","name":"Bedroom motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bedroom_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":105,"y":4104,"wires":[[]]},{"id":"24945e48.3c5ed2","type":"api-call-service","z":"a0f75c9.32211a","name":"Detect bedroom face","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"image_processing","service":"scan","entityId":"","data":"{\"entity_id\":\"image_processing.bedroom_face_camera\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":965,"y":4064,"wires":[[]]},{"id":"6e4aad44.e5fe34","type":"api-call-service","z":"a0f75c9.32211a","name":"Detect bedroom identity","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"image_processing","service":"scan","entityId":"","data":"{\"entity_id\":\"image_processing.bedroom_identity_camera\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":665,"y":4044,"wires":[["24945e48.3c5ed2"]]},{"id":"aaef03c0.b8bc6","type":"subflow:3134fb52.d06d64","z":"a0f75c9.32211a","name":"Announce who entered the kitchen","env":[{"name":"volumeLevel","value":"4","type":"num"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":1045,"y":4204,"wires":[[],[]]},{"id":"eb80225e.605d2","type":"change","z":"a0f75c9.32211a","name":"Prepare the text","rules":[{"t":"set","p":"message","pt":"msg","to":"'Good morning ' & $split(payload, ' ')[0]","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":765,"y":4164,"wires":[["aaef03c0.b8bc6"]]},{"id":"ef6baa0.2480558","type":"time-range-switch","z":"a0f75c9.32211a","name":"Is it morning?","lat":"","lon":"","startTime":"08:00","endTime":"12:00","startOffset":0,"endOffset":0,"x":445,"y":4224,"wires":[["eb80225e.605d2"],["d177f668.30c028"]]},{"id":"d177f668.30c028","type":"change","z":"a0f75c9.32211a","name":"Prepare the text","rules":[{"t":"set","p":"message","pt":"msg","to":"'Hello ' & $split(payload, ' ')[0]","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":765,"y":4264,"wires":[["aaef03c0.b8bc6"]]},{"id":"89bd3aac.ee7618","type":"change","z":"a0f75c9.32211a","name":"Reset retry count","rules":[{"t":"set","p":"kitchenRetryCount","pt":"flow","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":675,"y":4124,"wires":[[]]},{"id":"4e2b2.9bff7d4e8","type":"change","z":"a0f75c9.32211a","name":"","rules":[{"t":"set","p":"tablet_discharge_notification_sent","pt":"flow","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":885,"y":4304,"wires":[[]]},{"id":"29e62b41.9588d4","type":"stoptimer3","z":"a0f75c9.32211a","duration":"5","durationType":"num","units":"Second","payloadtype":"num","payloadval":"0","name":"Wait 5 seconds","x":355,"y":4044,"wires":[["96f256cd.926568"],[]]},{"id":"87c92f5c.d01b7","type":"inject","z":"a0f75c9.32211a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":485,"y":4144,"wires":[["6e4aad44.e5fe34"]]},{"id":"3eeaa6c9.457a1a","type":"api-call-service","z":"a0f75c9.32211a","name":"Set recurrent tasks for today","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.recurrent_tasks_for_today","data":"{\"value\":msg.payload.recurringTasks}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":386,"y":723,"wires":[["7c9f6f15.a00ca"]]},{"id":"b79b897d.d98768","type":"api-call-service","z":"a0f75c9.32211a","name":"Set initial tasks for today","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.initial_recurrent_tasks","data":"{\"value\":msg.payload.recurringTasks}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1291,"y":719,"wires":[[]]},{"id":"c6b6c47d.d29d88","type":"change","z":"a0f75c9.32211a","name":"Reset initial_recurrent_tasks","rules":[{"t":"set","p":"initial_recurrent_tasks","pt":"flow","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":660,"wires":[[]]},{"id":"7c9f6f15.a00ca","type":"switch","z":"a0f75c9.32211a","name":"If recurrent tasks not set","property":"initial_recurrent_tasks","propertyType":"flow","rules":[{"t":"lt","v":"payload.recurringTasks","vt":"msg"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":696,"y":723,"wires":[["bb236aad.1b21d8"],["bb236aad.1b21d8"]]},{"id":"bb236aad.1b21d8","type":"change","z":"a0f75c9.32211a","name":"Set flow.initial_recurrent_tasks","rules":[{"t":"set","p":"initial_recurrent_tasks","pt":"flow","to":"payload.recurringTasks","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":991,"y":719,"wires":[["b79b897d.d98768"]]},{"id":"2a695b33.8eb334","type":"api-call-service","z":"a0f75c9.32211a","name":"Set today's important unfinished tasks","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"var","service":"set","entityId":"var.important_unfinished_today","data":"{\"value\":msg.payload.importantUnfinishedToday}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":416,"y":963,"wires":[[]]},{"id":"cbaf5caf.0979e","type":"debug","z":"a0f75c9.32211a","name":"todoist","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":610,"y":2180,"wires":[]},{"id":"2eddd817.9e3128","type":"server-state-changed","z":"a0f75c9.32211a","name":"Last expense changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.last_expense","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":126,"y":1410,"wires":[[]]},{"id":"9874542f.4a93b8","type":"subflow:3134fb52.d06d64","z":"a0f75c9.32211a","name":"Notify focus mode is on","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"Focus mode is on. Now get back to work!","type":"str"},{"name":"volumeLevel","value":"4","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"},{"name":"notify_bogdan_phone","type":"bool","value":"true"}],"x":475,"y":1551,"wires":[["e7155129.d6531"],[]]},{"id":"3a28093c.96fb36","type":"subflow:3134fb52.d06d64","z":"a0f75c9.32211a","name":"Notify focus mode is off","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"Focus mode is off. Take a break!","type":"str"},{"name":"volumeLevel","value":"4","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"},{"name":"notify_bogdan_phone","type":"bool","value":"true"}],"x":455,"y":1631,"wires":[["49e3d5d8.35cfec"],[]]},{"id":"49e3d5d8.35cfec","type":"api-call-service","z":"a0f75c9.32211a","name":"Red light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"purple\", \"transition\":2}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":365,"y":2031,"wires":[["e5c00a0a.ec6038"]]},{"id":"e7155129.d6531","type":"api-call-service","z":"a0f75c9.32211a","name":"Green light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"blue\", \"transition\":2}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":310,"y":1780,"wires":[["e5c00a0a.ec6038"]]},{"id":"7bc3b53.8e1594c","type":"api-call-service","z":"a0f75c9.32211a","name":"Reset office light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"color_name\": \"white\", \"transition\":5}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":300,"y":1860,"wires":[[]]},{"id":"e5c00a0a.ec6038","type":"delay","z":"a0f75c9.32211a","name":"Delay 5 seconds","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":190,"y":1940,"wires":[["7bc3b53.8e1594c"]]},{"id":"ea90ae11.ef4be","type":"server-state-changed","z":"a0f75c9.32211a","name":"Focus mode state changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"var.focus_mode","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":145,"y":1591,"wires":[["9874542f.4a93b8"],["3a28093c.96fb36"]]},{"id":"8e59418c.fd1ba","type":"inject","z":"a0f75c9.32211a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"0 11-15 * * 1,2,3,4,5","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":155,"y":2071,"wires":[[]]},{"id":"4cc579f.e193b88","type":"api-current-state","z":"a0f75c9.32211a","name":"Check how much was I focused today","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"0.0","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.focus_mode_on_today","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":190,"y":2120,"wires":[["cbaf5caf.0979e","c2c57377.3043c"],[]]},{"id":"c2c57377.3043c","type":"subflow:3134fb52.d06d64","z":"a0f75c9.32211a","name":"Notify that you should start focus mode","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"message","value":"You should start focus mode","type":"str"},{"name":"volumeLevel","value":"4","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"},{"name":"notify_bogdan_phone","type":"bool","value":"true"}],"x":745,"y":2109,"wires":[[],[]]},{"id":"fd02ce5b.b8526","type":"api-call-service","z":"a0f75c9.32211a","name":"Update steps query entities","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.average_steps_for_the_past_week, sensor.average_steps_for_the_current_week, sensor.extra_steps_for_each_day, sensor.predicted_steps_for_current_week","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":980,"y":1080,"wires":[[]]},{"id":"349d9743.e03088","type":"inject","z":"a0f75c9.32211a","name":"At 12 AM each day","props":[{"p":"payload"},{"p":"force_update","v":"true","vt":"bool"}],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":366,"y":1143,"wires":[["f9fa2d6b.9144d"]]},{"id":"1f5aea13.74c0b6","type":"delay","z":"a0f75c9.32211a","name":"","pauseType":"delay","timeout":"60","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":760,"y":1080,"wires":[["fd02ce5b.b8526"]]},{"id":"678b09d7.f23698","type":"credentials","z":"a0f75c9.32211a","name":"Set Todoist token","props":[{"value":"todoistToken","type":"msg"}],"x":470,"y":600,"wires":[["db473d55.dd114"]]},{"id":"5b2ce630.699328","type":"function","z":"a0f75c9.32211a","name":"Prepare Pluralsight Request","func":"msg.headers = {};\nmsg.method = \"GET\";\nmsg.url = \"https://app.pluralsight.com/learner-goals/api/v1/goals?tzOffset=-120\";\nmsg.headers.cookie = msg.pluralsightCookie;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":180,"wires":[["29e1d133.16fd5e"]]},{"id":"651e1346.70d94c","type":"credentials","z":"a0f75c9.32211a","name":"Set Pluralsight cookie","props":[{"value":"pluralsightCookie","type":"msg"}],"x":380,"y":180,"wires":[["5b2ce630.699328"]]},{"id":"e13a8421.5f92a8","type":"inject","z":"a0f75c9.32211a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"3600","crontab":"","once":true,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":150,"y":180,"wires":[["651e1346.70d94c"]]},{"id":"29e1d133.16fd5e","type":"http request","z":"a0f75c9.32211a","name":"","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":900,"y":180,"wires":[[]]},{"id":"32a224a4.013cbc","type":"api-call-service","z":"a0f75c9.32211a","name":"Set Pluralsight goal","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_number","service":"set_value","entityId":"input_number.pluralsight_goal_percent","data":"{\"value\":msg.payload.goalPercentComplete}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1110,"y":180,"wires":[[]]},{"id":"3acceaff.882f56","type":"debug","z":"a0f75c9.32211a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":720,"y":860,"wires":[]},{"id":"9e379e9c.242e4","type":"inject","z":"a0f75c9.32211a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"59 23 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":240,"wires":[["651e1346.70d94c"]]},{"id":"4d2570b43885fef6","type":"debug","z":"a0f75c9.32211a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":630,"y":1140,"wires":[]},{"id":"14d62d6a.26d7b3","type":"http request","z":"7e610978.1ec528","name":"","method":"use","ret":"txt","paytoqs":"body","url":"https://api.todoist.com/sync/v8/sync","tls":"","persist":false,"proxy":"","authType":"","x":690,"y":60,"wires":[[]]},{"id":"5d3486d1.ec4908","type":"function","z":"7e610978.1ec528","name":"Prepare Todoist Request","func":"msg.headers = {}\nmsg.method = \"POST\"\nmsg.url = \"https://api.todoist.com/sync/v8/sync\" \nmsg.payload = \"token=\"+msg.token+\"&commands=%5B%7B%22type%22%3A%20%22item_update_date_complete%22%2C%20%22uuid%22%3A%20%22\" + 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  }) + \"%22%2C%20%22args%22%3A%20%7B%22id%22%3A%204125024774%7D%7D%5D\"\nmsg.headers[\"content-type\"] = \"application/x-www-form-urlencoded\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":60,"wires":[["14d62d6a.26d7b3"]]},{"id":"58b2e023.482c1","type":"ha-webhook","z":"7e610978.1ec528","name":"Tweet done","server":"8501408e.93b69","outputs":1,"webhookId":"hzXzXOlSlc5Jdm0CP3V7eveQCggQYCxe","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"","headersLocationType":"none","x":100,"y":60,"wires":[[]]},{"id":"d2317357.49668","type":"function","z":"7e610978.1ec528","name":"Prepare Todoist Request","func":"msg.headers = {};\nmsg.method = \"POST\";\nmsg.url = \"https://api.todoist.com/sync/v8/sync\";\nvar taskId = \"4277101342\";\nmsg.payload = \"token=\"+msg.token+\"&commands=%5B%7B%22type%22%3A%20%22item_update_date_complete%22%2C%20%22uuid%22%3A%20%22\" +\n'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  }) + \"%22%2C%20%22args%22%3A%20%7B%22id%22%3A%20\" + taskId + \"%7D%7D%5D\"\nmsg.headers[\"content-type\"] = \"application/x-www-form-urlencoded\"\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":930,"y":120,"wires":[["d8a05cc3.240db","1df48c35.174024"]]},{"id":"d8a05cc3.240db","type":"http request","z":"7e610978.1ec528","name":"Make POST request towards Todoist","method":"use","ret":"txt","paytoqs":"body","url":"https://api.todoist.com/sync/v8/sync","tls":"","persist":false,"proxy":"","authType":"","x":1250,"y":80,"wires":[[]]},{"id":"a1640758.48f768","type":"server-state-changed","z":"7e610978.1ec528","name":"Check step count","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"var.bogdan_steps","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"6000","halt_if_type":"num","halt_if_compare":"gte","outputs":2,"output_only_on_state_change":true,"x":110,"y":180,"wires":[["1fe41555.bda01b"],["27768147.38484e"]]},{"id":"14ee8adb.40ec75","type":"change","z":"7e610978.1ec528","name":"Remember task was completed","rules":[{"t":"set","p":"stepsTaskCompleted","pt":"flow","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":670,"y":200,"wires":[[]]},{"id":"1fe41555.bda01b","type":"switch","z":"7e610978.1ec528","name":"If task was not already completed","property":"stepsTaskCompleted","propertyType":"flow","rules":[{"t":"false"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":120,"wires":[["14ee8adb.40ec75","e581146d.bfa758"],["14ee8adb.40ec75","e581146d.bfa758"]]},{"id":"11df3436.997d3c","type":"change","z":"7e610978.1ec528","name":"Mark task as not completed","rules":[{"t":"set","p":"stepsTaskCompleted","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":260,"wires":[[]]},{"id":"733f32fa.94e9cc","type":"inject","z":"7e610978.1ec528","name":"Check every hour","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"0 13-23 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":110,"y":320,"wires":[["27768147.38484e"]]},{"id":"1df48c35.174024","type":"subflow:b6e164fe.1d31e8","z":"7e610978.1ec528","name":"Send 6k steps notification","env":[{"name":"message","value":"You did 6000 steps today","type":"str"},{"name":"title","value":"Congrats!","type":"str"}],"x":1210,"y":180,"wires":[[]]},{"id":"27768147.38484e","type":"function","z":"7e610978.1ec528","name":"Check if I should be notified","func":"const globalHomeAssistant = global.get('homeassistant');\nvar stepsCount = parseInt(globalHomeAssistant.homeAssistant.states[\"var.bogdan_steps\"].state);\nvar hour = new Date().getHours();\nif(stepsCount >= 6000){\n  msg.done = true;\n  \n  global.set(\"GalaxyS9Message\", \"You've done it! \" + stepsCount + \" steps and counting!\");\n  global.set(\"GalaxyS9Title\", \"Steps info\");\n  msg.showNotification = true;\n  return msg;\n}\nvar message = \"\";\nmsg.title = \"Steps info\";\nvar showNotification = false;\nif(hour == 13 && stepsCount < 2000){\n    msg.message = \"By now you should have at least 2000\";\n    showNotification = true;\n}\nif(hour == 18 && stepsCount < 4000){\n    msg.message = \"By now you should have at least 4000\";\n    showNotification = true;\n}\nif(hour == 20 && stepsCount < 6000){\n    msg.message = \"Hurry up and do your steps!\";\n    showNotification = true;\n}\nglobal.set('StepsCount', stepsCount);\nif(showNotification === false)\n  return msg;\n\nmsg.showNotification = true;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":320,"wires":[[]]},{"id":"ff0e8b8b.1a28d8","type":"inject","z":"7e610978.1ec528","name":"Check every hour","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"01 12 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":370,"y":260,"wires":[["11df3436.997d3c"]]},{"id":"be630093.3dae","type":"inject","z":"7e610978.1ec528","name":"At midnight","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":740,"wires":[[]]},{"id":"43dbfb95.18f024","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete \"Plan your day\" task","env":[{"name":"taskId","value":"4483313631","type":"str"}],"x":420,"y":560,"wires":[[]]},{"id":"cab08127.bd9c9","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete Skedpal task","env":[{"name":"taskId","value":"4483325761","type":"str"}],"x":390,"y":600,"wires":[[]]},{"id":"6cc8f038.dff22","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete \"3 wins for the day\" task","env":[{"name":"taskId","value":"4483326005","type":"str"}],"x":430,"y":640,"wires":[[]]},{"id":"27b24904.6d2426","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete daily walk","env":[{"name":"taskId","value":"4486274576","type":"str"}],"x":380,"y":680,"wires":[[]]},{"id":"525ff5c9.c4f09c","type":"inject","z":"7e610978.1ec528","name":"Specific week days","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 00 * * 1,3,5,0","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":880,"y":700,"wires":[["9d280466.80b5c8"]]},{"id":"9d280466.80b5c8","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete desk cleaning task","env":[{"name":"taskId","value":"4343842665","type":"str"}],"x":1170,"y":700,"wires":[[]]},{"id":"128cce69.9f5472","type":"ha-webhook","z":"7e610978.1ec528","name":"Todoist task completed","server":"8501408e.93b69","outputs":1,"webhookId":"77m8WLu6dByP76zdJhugbijILSmeXn70","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"","headersLocationType":"none","x":100,"y":1140,"wires":[["d41b4ccd.3573e"]]},{"id":"3870f17e.f78b1e","type":"switch","z":"7e610978.1ec528","name":"Check if Alexa should talk","property":"continue","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":510,"y":1140,"wires":[["8aef2340.9b232"]]},{"id":"8aef2340.9b232","type":"api-current-state","z":"7e610978.1ec528","name":"If I am in the office","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Office","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"var.bogdan_location","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":730,"y":1140,"wires":[["ee621761.3e4d28"],[]]},{"id":"d41b4ccd.3573e","type":"function","z":"7e610978.1ec528","name":"Check the label","func":"if(msg.payload.event_name !== \"item:completed\"){\n    return msg;\n}\nvar event = msg.payload.event_data;\nvar message = null;\nif(event.labels.indexOf(2155038512) != -1 || event.labels.indexOf(2152220567) != -1){\n    global.set('AlexaMessage', \"Congratulations! You managed to complete the task \" + event.content);\n    msg.continue = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":300,"y":1140,"wires":[["3870f17e.f78b1e"]]},{"id":"ee621761.3e4d28","type":"subflow:3134fb52.d06d64","z":"7e610978.1ec528","name":"Speak in the office","env":[{"name":"message","value":"<audio src=\"soundbank://soundlibrary/sports/crowds/crowds_09\"/>","type":"str"},{"name":"volumeLevel","value":"2","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":990,"y":1120,"wires":[["86ee9c09.71fe3"],[]]},{"id":"64973ebe.7858e","type":"subflow:c28ba6b7.4557d8","z":"7e610978.1ec528","name":"Log","env":[{"name":"name","value":"Todoist","type":"str"},{"name":"message","value":"Completed important task","type":"str"},{"name":"entity_id","value":"person.bogdan_bujdea","type":"str"}],"x":1450,"y":1120,"wires":[[]]},{"id":"7babeb34.2e1274","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete morning exercises task","env":[{"name":"taskId","value":"4486274575","type":"str"}],"x":420,"y":720,"wires":[[]]},{"id":"1c88aa6c.e816c6","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete Meditation task","env":[{"name":"taskId","value":"4486274453","type":"str"}],"x":400,"y":760,"wires":[[]]},{"id":"8af4784e.ea6578","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete \"take the pills task\"","env":[{"name":"taskId","value":"4470451666","type":"str"}],"x":410,"y":800,"wires":[[]]},{"id":"6c4b5068.9034e","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete \"6000 steps\" task","env":[{"name":"taskId","value":"4277101342","type":"str"}],"x":410,"y":840,"wires":[[]]},{"id":"c716d790.69d128","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete \"Log day in Maxcode/Genesis\" task","env":[{"name":"taskId","value":"4338085862","type":"str"}],"x":460,"y":880,"wires":[[]]},{"id":"91fdb34b.a980c","type":"subflow:defed711.e14778","z":"7e610978.1ec528","name":"Uncomplete \"Expenses update task","env":[{"name":"taskId","value":"4492788626","type":"str"}],"x":420,"y":920,"wires":[[]]},{"id":"e581146d.bfa758","type":"credentials","z":"7e610978.1ec528","name":"Set Todoist token","props":[{"value":"token","type":"msg"}],"x":670,"y":120,"wires":[["d2317357.49668"]]},{"id":"88bcc244.4d522","type":"inject","z":"7e610978.1ec528","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":750,"y":1060,"wires":[["ee621761.3e4d28"]]},{"id":"86ee9c09.71fe3","type":"subflow:3134fb52.d06d64","z":"7e610978.1ec528","name":"Speak in the office","env":[{"name":"volumeLevel","value":"2","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":1230,"y":1120,"wires":[["64973ebe.7858e"],[]]},{"id":"54aae211.e664cc","type":"inject","z":"6bb54913.4b8c08","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"30","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":40,"wires":[["e8b2582e.441c48","a58b5a55.6346a8","2073acb5.86ddf4"]]},{"id":"bb8b7e70.22edc","type":"server-state-changed","z":"6bb54913.4b8c08","name":"Office motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":110,"y":120,"wires":[[]]},{"id":"968cb96c.cc1d28","type":"server-state-changed","z":"6bb54913.4b8c08","name":"Bathroom motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bathroom_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":120,"y":180,"wires":[[]]},{"id":"7ef09c23.2254c4","type":"server-state-changed","z":"6bb54913.4b8c08","name":"Hallway motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.hallway_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":120,"y":240,"wires":[[]]},{"id":"55de6f7b.ee9db","type":"server-state-changed","z":"6bb54913.4b8c08","name":"Kitchen hue motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.kitchen_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":130,"y":300,"wires":[[]]},{"id":"9ede416c.42712","type":"server-state-changed","z":"6bb54913.4b8c08","name":"Kitchen tradfri motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.kitchen_table_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":140,"y":360,"wires":[[]]},{"id":"32c337f4.543548","type":"server-state-changed","z":"6bb54913.4b8c08","name":"Living room motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.living_room_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":130,"y":420,"wires":[[]]},{"id":"2cb8bb02.1e7e74","type":"server-state-changed","z":"6bb54913.4b8c08","name":"Bedroom motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bedroom_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":120,"y":480,"wires":[[]]},{"id":"9ca67712.6708b8","type":"api-call-service","z":"6bb54913.4b8c08","name":"Update motion","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.bathroom_motion_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":180,"wires":[["e24be23e.9c7ea","88d99f1b.3b7f4"]]},{"id":"97f5be21.c7179","type":"api-call-service","z":"6bb54913.4b8c08","name":"Hallway motion","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.hallway_motion_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":240,"wires":[["e24be23e.9c7ea","88d99f1b.3b7f4"]]},{"id":"c4eb059f.aca738","type":"api-call-service","z":"6bb54913.4b8c08","name":"Kitchen hue motion","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.kitchen_hue_motion_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":630,"y":300,"wires":[["e24be23e.9c7ea","88d99f1b.3b7f4"]]},{"id":"c456bd2e.cc079","type":"api-call-service","z":"6bb54913.4b8c08","name":"Kitchen tradfri motion","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.kitchen_tradfri_motion_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":640,"y":360,"wires":[["e24be23e.9c7ea","88d99f1b.3b7f4"]]},{"id":"7f3cbeff.82cf8","type":"api-call-service","z":"6bb54913.4b8c08","name":"Living room motion","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.living_room_motion_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":630,"y":420,"wires":[["e24be23e.9c7ea","88d99f1b.3b7f4"]]},{"id":"8098fe78.64a71","type":"api-call-service","z":"6bb54913.4b8c08","name":"Bedroom motion","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.bedroom_motion_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":480,"wires":[["e24be23e.9c7ea","88d99f1b.3b7f4"]]},{"id":"e8b2582e.441c48","type":"api-call-service","z":"6bb54913.4b8c08","name":"Update motion query","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.office_motion_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":660,"y":120,"wires":[["e24be23e.9c7ea","88d99f1b.3b7f4"]]},{"id":"a58b5a55.6346a8","type":"api-call-service","z":"6bb54913.4b8c08","name":"Update UI sensors","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.office_motion_last_detected, sensor.hallway_motion_last_detected, sensor.living_room_motion_last_detected, sensor.bedroom_motion_last_detected, sensor.bathroom_motion_last_detected, sensor.kitchen_hue_motion_last_detected, sensor.kitchen_tradfri_motion_last_detected, sensor.kitchen_motion_last_detected, sensor.kids_room_motion_last_detected","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":890,"y":20,"wires":[[]]},{"id":"3ac0e14a.80b02e","type":"api-current-state","z":"6bb54913.4b8c08","name":"Sensors are on","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"group.all_motion_sensors","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1180,"y":240,"wires":[["1ccfbece.5698b1"],[]]},{"id":"55294420.99771c","type":"subflow:d7bbbb62.ece328","z":"6bb54913.4b8c08","name":"Set family status to Home","env":[{"name":"status","value":"Home","type":"str"}],"x":1810,"y":300,"wires":[]},{"id":"1ccfbece.5698b1","type":"api-current-state","z":"6bb54913.4b8c08","name":"Vacuum state","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"vacuum.xiaomi_vacuum_cleaner","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1320,"y":300,"wires":[["2715a1c6.12216e"]]},{"id":"e24be23e.9c7ea","type":"api-current-state","z":"6bb54913.4b8c08","name":"Someone is home","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"group.family","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":990,"y":280,"wires":[["3ac0e14a.80b02e"],[]]},{"id":"2715a1c6.12216e","type":"switch","z":"6bb54913.4b8c08","name":"Vacuum is not on","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"docker","vt":"str"},{"t":"eq","v":"idle","vt":"str"},{"t":"eq","v":"error","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1530,"y":300,"wires":[["55294420.99771c"],["55294420.99771c"],["55294420.99771c"]]},{"id":"88d99f1b.3b7f4","type":"function","z":"6bb54913.4b8c08","name":"Set rooms","func":"var str = \"/last_detected/\";\nconst globalHomeAssistant = global.get('homeassistant');\nvar rooms = [\n    { name: \"sensor.office_motion_last_detected\", alexa: \"media_player.office_echo_dot\"},\n    { name: \"sensor.hallway_motion_last_detected\", alexa: \"media_player.hallway_echo_dot\"},\n    { name: \"sensor.living_room_motion_last_detected\", alexa: \"media_player.living_room_echo_dot\"},\n    { name: \"sensor.bedroom_motion_last_detected\", alexa: \"media_player.bedroom_echo_dot\"},\n    { name: \"sensor.bathroom_motion_last_detected\", alexa: \"media_player.bathroom_echo_dot\"},\n    { name: \"sensor.kitchen_motion_last_detected\", alexa: \"media_player.kitchen_echo_dot\"}\n];\nrooms.forEach(function(room){\n    room.timestamp = globalHomeAssistant.homeAssistant.states[room.name].attributes.timestamp;\n});\n\nmsg.rooms = rooms;\nvar orderedRooms = rooms.sort(function(room1, room2){\n    return room2.timestamp - room1.timestamp;\n});\nglobal.set('roomMotion1', orderedRooms[0].alexa);\nglobal.set('roomMotion2', orderedRooms[1].alexa);\nglobal.set('roomMotion3', orderedRooms[2].alexa);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":400,"wires":[[]]},{"id":"bdfb52a6.cb482","type":"server-state-changed","z":"6bb54913.4b8c08","name":"Kids room motion","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.kids_room_motion_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":120,"y":540,"wires":[[]]},{"id":"b678aec5.d63b","type":"api-call-service","z":"6bb54913.4b8c08","name":"Bedroom motion","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.bedroom_motion_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":540,"wires":[["e24be23e.9c7ea","88d99f1b.3b7f4"]]},{"id":"2073acb5.86ddf4","type":"api-call-service","z":"6bb54913.4b8c08","name":"Update fasting query","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"update_entity","entityId":"sensor.fasting_query","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":660,"y":60,"wires":[[]]},{"id":"6638e14.121602","type":"server-state-changed","z":"7232e01d.add9e","name":"S9 battery level","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.galaxy_s9_battery_level","entityidfiltertype":"exact","outputinitially":false,"state_type":"num","haltifstate":"","halt_if_type":"num","halt_if_compare":"gte","outputs":1,"output_only_on_state_change":true,"x":140,"y":160,"wires":[["f0a5ba61.d7d308"]]},{"id":"707cebd9.3605b4","type":"server-state-changed","z":"7232e01d.add9e","name":"Fire HD battery level","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.firehd_battery_level","entityidfiltertype":"exact","outputinitially":false,"state_type":"num","haltifstate":"","halt_if_type":"num","halt_if_compare":"gte","outputs":1,"output_only_on_state_change":true,"x":150,"y":260,"wires":[["f0a5ba61.d7d308"]]},{"id":"f0a5ba61.d7d308","type":"subflow:fc03161a.88a1f8","z":"7232e01d.add9e","name":"Low battery notification","env":[{"name":"firehd","value":"","type":"json"}],"x":540,"y":160,"wires":[]},{"id":"dafa4b1b.ee5c18","type":"server-state-changed","z":"7232e01d.add9e","name":"iPhone battery level","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.elenas_iphone_battery_level","entityidfiltertype":"exact","outputinitially":false,"state_type":"num","haltifstate":"","halt_if_type":"num","halt_if_compare":"gte","outputs":1,"output_only_on_state_change":true,"x":150,"y":60,"wires":[["f0a5ba61.d7d308"]]},{"id":"f057d03b.2763","type":"server-state-changed","z":"7232e01d.add9e","name":"Shelly is unavailable","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.shelly_current_consumption","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"unavailable","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":110,"y":680,"wires":[["96113ffc.679d7"],[]]},{"id":"28fa643e.f84dcc","type":"server-state-changed","z":"7232e01d.add9e","name":"Living room TV state changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"media_player.living_tv","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":180,"y":360,"wires":[["b2a404f5.237698"]]},{"id":"e71d37a3.4e88f8","type":"switch","z":"7232e01d.add9e","name":"Check volume","property":"newVolume","propertyType":"msg","rules":[{"t":"istype","v":"number","vt":"number"}],"checkall":"true","repair":false,"outputs":1,"x":720,"y":380,"wires":[["69828397.c611dc"]]},{"id":"69828397.c611dc","type":"api-call-service","z":"7232e01d.add9e","name":"Set volume to max volume","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"media_player","service":"volume_set","entityId":"media_player.living_tv","data":"{\"volume_level\": msg.newVolume}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":960,"y":380,"wires":[[]]},{"id":"b2a404f5.237698","type":"function","z":"7232e01d.add9e","name":"Get current volume","func":"const globalHomeAssistant = global.get('homeassistant');\nvar currentVolume = globalHomeAssistant.homeAssistant.states[\"media_player.living_tv\"].attributes.volume_level;\nvar maxVolume = parseInt(globalHomeAssistant.homeAssistant.states[\"input_number.living_tv_max_volume\"].state);\n\nvar convertedVolume = Math.ceil(currentVolume * 60);\nmsg.convertedVolume = convertedVolume;\nmsg.currentVolume = currentVolume;\n\nmsg.maxVolume = maxVolume;\nif(convertedVolume > maxVolume){\n    msg.newVolume = maxVolume / 60;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":380,"wires":[["e71d37a3.4e88f8"]]},{"id":"ce8d28e4.cd0b08","type":"server-state-changed","z":"7232e01d.add9e","name":"Max TV volume changed","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.living_tv_max_volume","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":170,"y":440,"wires":[["b2a404f5.237698"]]},{"id":"acf3b881.c58328","type":"ha-webhook","z":"7232e01d.add9e","name":"Phone is ringing","server":"8501408e.93b69","outputs":1,"webhookId":"V7YxYLDo0A05rNaPMzX3Yxt8rdkmawFG","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"header","headersLocationType":"msg","x":140,"y":560,"wires":[["a200cde8.51244","8ede8643.1d2058","5ae2a870.421c28"]]},{"id":"3bfbed58.5a9612","type":"subflow:3134fb52.d06d64","z":"7232e01d.add9e","name":"Send Alexa notification","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"target","value":"[\"media_player.hallway_echo_dot\"]","type":"json"},{"name":"livingRoomEchoDot","value":"false","type":"bool"},{"name":"bedroomEchoDot","value":"false","type":"bool"}],"x":1100,"y":500,"wires":[[],[]]},{"id":"11dc533f.647b1d","type":"function","z":"7232e01d.add9e","name":"Get message","func":"if(!isNaN(msg.header.caller) || msg.header.caller.indexOf(\"+\") != -1){\n    global.set('AlexaMessage', \"Hey Bogdan, your phone is ringing\");\n}\nelse{\n    global.set('AlexaMessage', \"Hey Bogdan, \" + msg.header.caller + \" is calling you\");\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":710,"y":500,"wires":[["3bfbed58.5a9612"]]},{"id":"a200cde8.51244","type":"api-current-state","z":"7232e01d.add9e","name":"Bogdan's phone call notifications","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.phone_call_notifications_bogdan","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":430,"y":560,"wires":[["bff80722.bd6118"],[]]},{"id":"bff80722.bd6118","type":"api-current-state","z":"7232e01d.add9e","name":"Bogdan is home","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"person.bogdan_bujdea","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":460,"y":460,"wires":[["11dc533f.647b1d"],[]]},{"id":"29b0e2a7.4b1fde","type":"api-call-service","z":"7232e01d.add9e","name":"Flash some lights","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"light","service":"turn_on","entityId":"group.hallway_lights, group.living_room_lights","data":"{\"brightness\": 255, \"flash\": \"long\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":730,"y":440,"wires":[[]]},{"id":"2ed3b54d.fd920a","type":"subflow:3134fb52.d06d64","z":"7232e01d.add9e","name":"Buzzer","env":[{"name":"broadcast","type":"bool","value":"true"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"sound","value":"buzzers_pistols_01","type":"str"},{"name":"target","value":"[\"media_player.hallway_echo_dot\"]","type":"json"},{"name":"livingRoomEchoDot","value":"false","type":"bool"},{"name":"bedroomEchoDot","value":"false","type":"bool"}],"x":890,"y":440,"wires":[["3bfbed58.5a9612"],[]]},{"id":"6f901047.03f2e","type":"ha-webhook","z":"7232e01d.add9e","name":"Battery changed","server":"8501408e.93b69","outputs":1,"webhookId":"XsijoBjpJSuXntMJ75IzwEmtuq8paCt3","payloadLocation":"","payloadLocationType":"msg","headersLocation":"headers","headersLocationType":"msg","x":420,"y":300,"wires":[["b3d293ab.432f5"]]},{"id":"b3d293ab.432f5","type":"function","z":"7232e01d.add9e","name":"Transform battery level","func":"msg.payload = msg.headers.battery_level;\nmsg.data = {entity_id: 'sensor.galaxy_s9_battery_level'};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":240,"wires":[["f0a5ba61.d7d308"]]},{"id":"4d97ead4.fd1404","type":"http request","z":"7232e01d.add9e","name":"Fire HD status","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://192.168.1.39:2323/?cmd=deviceInfo&password=q1w2e3r4r4&type=json","tls":"","persist":false,"proxy":"","authType":"","x":700,"y":40,"wires":[["149330ec.07b19f"]]},{"id":"d5c8be54.1fae","type":"inject","z":"7232e01d.add9e","name":"Get Fire HD battery level","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"300","crontab":"","once":true,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":470,"y":100,"wires":[[]]},{"id":"149330ec.07b19f","type":"function","z":"7232e01d.add9e","name":"Transform battery level","func":"msg.payload = msg.payload.batteryLevel;\nmsg.data = {entity_id: 'sensor.firehd_battery_level'};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":160,"wires":[["f0a5ba61.d7d308"]]},{"id":"96113ffc.679d7","type":"subflow:b6e164fe.1d31e8","z":"7232e01d.add9e","name":"","env":[{"name":"message","value":"Shelly is unavailable, restart it now","type":"str"},{"name":"title","value":"Shelly unavailable","type":"str"}],"x":380,"y":680,"wires":[[]]},{"id":"b8e4ad68.042c7","type":"server-state-changed","z":"7232e01d.add9e","name":"Kitchen motion detected","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"group.kitchen_motion","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":140,"y":1020,"wires":[["bd7a2656.23c288","ad5f492c.adf388"],["1f419460.aba72c"]]},{"id":"bd7a2656.23c288","type":"http request","z":"7232e01d.add9e","name":"Unlock tablet","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.1.39:2323/?cmd=screenOn&password=q1w2e3r4r4","tls":"","persist":false,"proxy":"","authType":"","x":450,"y":1000,"wires":[[]]},{"id":"d8e32473.3228e8","type":"http request","z":"7232e01d.add9e","name":"Lock tablet","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.1.39:2323/?cmd=screenOff&password=q1w2e3r4r4","tls":"","persist":false,"proxy":"","authType":"","x":670,"y":1060,"wires":[[]]},{"id":"b7151740.570b48","type":"server-state-changed","z":"7232e01d.add9e","name":"Internal Garage Home Assistant Disconnected","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.garage_home_assistant_internal_ip","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":190,"y":780,"wires":[["28ceda79.f1c0b6"],[]]},{"id":"b9fb3466.a3ada8","type":"server-state-changed","z":"7232e01d.add9e","name":"Public Garage Home Assistant Disconnected","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.garage_home_assistant_public_access","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":190,"y":880,"wires":[["a0d08678.4e35a8"],[]]},{"id":"1bd52e65.19f552","type":"subflow:b6e164fe.1d31e8","z":"7232e01d.add9e","name":"Notify Bogdan","env":[{"name":"message","value":"Local garage HA might be down","type":"str"},{"name":"title","value":"Local garage HA disconnected","type":"str"}],"x":760,"y":780,"wires":[[]]},{"id":"3e881dde.b570a2","type":"subflow:b6e164fe.1d31e8","z":"7232e01d.add9e","name":"Notify Bogdan","env":[{"name":"message","value":"Public garage HA might be down","type":"str"},{"name":"title","value":"Public garage HA disconnected","type":"str"}],"x":780,"y":880,"wires":[[]]},{"id":"28ceda79.f1c0b6","type":"ha-wait-until","z":"7232e01d.add9e","name":"Wait 1 minute","server":"8501408e.93b69","outputs":2,"entityId":"binary_sensor.garage_home_assistant_internal_ip","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"5","timeoutType":"num","timeoutUnits":"minutes","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":540,"y":780,"wires":[[],["1bd52e65.19f552"]]},{"id":"a0d08678.4e35a8","type":"ha-wait-until","z":"7232e01d.add9e","name":"Wait 1 minute","server":"8501408e.93b69","outputs":2,"entityId":"","entityIdFilterType":"exact","property":"binary_sensor.garage_home_assistant_public_access","comparator":"is","value":"on","valueType":"str","timeout":"5","timeoutType":"num","timeoutUnits":"minutes","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":520,"y":880,"wires":[[],["3e881dde.b570a2"]]},{"id":"90a4725.286349","type":"server-state-changed","z":"7232e01d.add9e","name":"Family is away","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_select.bujdea_family","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"Away","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":170,"y":1220,"wires":[["88ab9846.efcfe8","98914da8.bb22a"],["88ab9846.efcfe8","dc805eaa.a2823"]]},{"id":"7bb1d0e4.6e4df","type":"api-call-service","z":"7232e01d.add9e","name":"Turn off all the lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"turn_off","entityId":"group.all_lights","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":640,"y":1200,"wires":[[]]},{"id":"494339ae.81c448","type":"server-state-changed","z":"7232e01d.add9e","name":"Family not home","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"group.family","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"not_home","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":190,"y":1360,"wires":[["2a7700be.9d4b2"],["81371dc3.eb2f8"]]},{"id":"75e44d5c.4494c4","type":"subflow:d7bbbb62.ece328","z":"7232e01d.add9e","name":"Set family to away","env":[{"name":"status","value":"Away","type":"str"}],"x":730,"y":1340,"wires":[]},{"id":"2a7700be.9d4b2","type":"api-current-state","z":"7232e01d.add9e","name":"Input is not home","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Away","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"input_select.bujdea_family","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":470,"y":1340,"wires":[["75e44d5c.4494c4"],[]]},{"id":"88ab9846.efcfe8","type":"subflow:c1aa7598.d50e08","z":"7232e01d.add9e","name":"","env":[],"x":570,"y":1260,"wires":[]},{"id":"81371dc3.eb2f8","type":"subflow:d7bbbb62.ece328","z":"7232e01d.add9e","name":"Set family to home","env":[{"name":"status","value":"Home","type":"str"}],"x":610,"y":1420,"wires":[]},{"id":"1f419460.aba72c","type":"delay","z":"7232e01d.add9e","name":"Wait 10 minutes","pauseType":"delay","timeout":"10","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":1060,"wires":[["d8e32473.3228e8"]]},{"id":"ad5f492c.adf388","type":"change","z":"7232e01d.add9e","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":430,"y":1120,"wires":[["1f419460.aba72c"]]},{"id":"98914da8.bb22a","type":"delay","z":"7232e01d.add9e","name":"Wait 5 minutes","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":420,"y":1200,"wires":[["7bb1d0e4.6e4df"]]},{"id":"dc805eaa.a2823","type":"change","z":"7232e01d.add9e","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":1280,"wires":[["98914da8.bb22a"]]},{"id":"f68a5997.0d3098","type":"server-state-changed","z":"7232e01d.add9e","name":"Living TV auto shutdown turned on","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.living_tv_auto_shutdown","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":180,"y":1480,"wires":[[],[]]},{"id":"1239889.7a49b77","type":"delay","z":"7232e01d.add9e","name":"TV turning off in 1 minute","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":670,"y":1520,"wires":[[]]},{"id":"cc8529af.24d6d8","type":"change","z":"7232e01d.add9e","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":1480,"wires":[["1239889.7a49b77","4be1558f.8278cc"]]},{"id":"c5bd54c8.d960e8","type":"api-call-service","z":"7232e01d.add9e","name":"Turn off living room TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"media_player","service":"turn_off","entityId":"media_player.living_tv","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":600,"y":1740,"wires":[["6a57e7ad.780438"]]},{"id":"a415aa71.b073a8","type":"server-state-changed","z":"7232e01d.add9e","name":"Living TV turned on","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"media_player.living_tv","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":110,"y":1740,"wires":[["886d0fe8.2da5f"],[]]},{"id":"1cadf619.c874ea","type":"debug","z":"7232e01d.add9e","name":"Timer result","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1310,"y":1600,"wires":[]},{"id":"ebe6161d.c2a5e8","type":"subflow:3134fb52.d06d64","z":"7232e01d.add9e","name":"Notify that the TV is turning off","env":[{"name":"broadcast","type":"bool","value":"true"},{"name":"message","value":"The TV is turning off in 1 minute","type":"str"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":590,"y":1600,"wires":[[],[]]},{"id":"886d0fe8.2da5f","type":"api-current-state","z":"7232e01d.add9e","name":"Auto shutdown is true","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.living_tv_auto_shutdown","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":340,"y":1740,"wires":[["c5bd54c8.d960e8"],[]]},{"id":"4be1558f.8278cc","type":"delay","z":"7232e01d.add9e","name":"Wait 1 hour","pauseType":"delay","timeout":"60","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":810,"y":1440,"wires":[["c6c10454.336ad8"]]},{"id":"c6c10454.336ad8","type":"api-call-service","z":"7232e01d.add9e","name":"Turn off auto shutdown","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.living_tv_auto_shutdown","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1080,"y":1440,"wires":[[]]},{"id":"32d8f915.369536","type":"inject","z":"7232e01d.add9e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":920,"y":1540,"wires":[["7b996969.a238f8"]]},{"id":"18fa2938.bee157","type":"subflow:3134fb52.d06d64","z":"7232e01d.add9e","name":"Notify that the TV is turning off","env":[{"name":"broadcast","type":"bool","value":"true"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":1230,"y":2180,"wires":[[],[]]},{"id":"3761e5df.12328a","type":"delay","z":"7232e01d.add9e","name":"Wait 5 seconds","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":420,"y":2020,"wires":[["bc0120d9.dba18"]]},{"id":"957e83e.6b5028","type":"change","z":"7232e01d.add9e","name":"Set minutes","rules":[{"t":"set","p":"minutes_until_shutdown","pt":"flow","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1230,"y":1680,"wires":[[]]},{"id":"e853d771.9d8778","type":"server-state-changed","z":"7232e01d.add9e","name":"Living TV Auto Shutdown Timer","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_select.living_tv_auto_shutdown_timer","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"On","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":130,"y":2020,"wires":[["29575cfc.e61264"],["3761e5df.12328a"]]},{"id":"29575cfc.e61264","type":"change","z":"7232e01d.add9e","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":2200,"wires":[["6969263.628efd8","3761e5df.12328a","f479ea66.d5bf48"]]},{"id":"bc0120d9.dba18","type":"function","z":"7232e01d.add9e","name":"","func":"const globalHomeAssistant = global.get('homeassistant');\nvar selectOption = globalHomeAssistant.homeAssistant.states[\"input_select.living_tv_auto_shutdown_timer\"].state;\nmsg.select = selectOption;\nmsg.minutes = 0;\nswitch(selectOption){\n    case \"1 msg.minutes\":\n        msg.minutes = 1;\n        break;\n    case \"2 minutes\":\n        msg.minutes = 2;\n        break;\n    case \"5 minutes\":\n        msg.minutes = 5;\n        break;\n    case \"15 minutes\":\n        msg.minutes = 15;\n        break;\n    case \"30 minutes\":\n        msg.minutes = 30;\n        break;\n    case \"1 hour\":\n        msg.minutes = 60;\n        break;\n    case \"1 minutes\":\n        msg.minutes = 1;\n        break;\n    case \"1.5 hours\":\n        msg.minutes = 90;\n        break;\n    case \"2 hours\":\n        msg.minutes = 120;\n        break;\n    case \"3 hours\":\n        msg.minutes = 180;\n        break;\n    case \"4 hours\":\n        msg.minutes = 240;\n        break;\n}\nmsg.message = \"The TV is turning off in \" + msg.minutes + \" minutes\";\nmsg.delay = msg.minutes * 60 * 1000;\nmsg.timeout = 10;\nvar now = new Date ();\nvar shutdown_date = new Date ( now );\nshutdown_date.setMinutes ( now.getMinutes() + msg.minutes );\nmsg.shutdown_date = shutdown_date;\nflow.set('tv_shutdown_date', shutdown_date);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":600,"y":2020,"wires":[["f5d82c1d.9b57a"]]},{"id":"f5d82c1d.9b57a","type":"switch","z":"7232e01d.add9e","name":"Auto Shutdown is on","property":"minutes","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":840,"y":2020,"wires":[["6969263.628efd8","5b499465.fc365c","f479ea66.d5bf48","18fa2938.bee157"]]},{"id":"6969263.628efd8","type":"delay","z":"7232e01d.add9e","name":"Delay","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":970,"y":1900,"wires":[["ee6d7955.546668","d9566283.45dda"]]},{"id":"f0c2b476.df4ce8","type":"api-call-service","z":"7232e01d.add9e","name":"Turn off living room TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"media_player","service":"turn_off","entityId":"media_player.living_tv","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1460,"y":1840,"wires":[["8c757b0c.e26ff8","85f54888.ddb5f8"]]},{"id":"5b499465.fc365c","type":"debug","z":"7232e01d.add9e","name":"Auto shutdown is on","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1180,"y":2100,"wires":[]},{"id":"ee6d7955.546668","type":"api-call-service","z":"7232e01d.add9e","name":"Turn on auto shutdown","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.living_tv_auto_shutdown","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1200,"y":1860,"wires":[["f0c2b476.df4ce8"]]},{"id":"f479ea66.d5bf48","type":"delay","z":"7232e01d.add9e","name":"Wait 1 minute","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1200,"y":1980,"wires":[["96d55a21.8aaa88"]]},{"id":"96d55a21.8aaa88","type":"function","z":"7232e01d.add9e","name":"Decrease minutes","func":"var today = new Date();\nvar dif = (flow.get(\"tv_shutdown_date\") - today); \nvar minutes = Math.round((dif/1000)/60); \nmsg.minutes = minutes;\nif(msg.minutes == 30 || msg.minutes == 20 || msg.minutes == 10 || msg.minutes == 5 || msg.minutes == 1){\n    msg.message = \"The TV will turn off in \" + minutes + \" minutes\";\n}\nelse{\n    msg.message = null;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1430,"y":2000,"wires":[["f479ea66.d5bf48","dbf143a3.9ec53"]]},{"id":"d9566283.45dda","type":"subflow:3134fb52.d06d64","z":"7232e01d.add9e","name":"Notify that the TV is turning off","env":[{"name":"broadcast","type":"bool","value":"true"},{"name":"message","value":"Bye bye","type":"str"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":1210,"y":1800,"wires":[[],[]]},{"id":"dbf143a3.9ec53","type":"debug","z":"7232e01d.add9e","name":"Decreased minutes","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":2040,"wires":[]},{"id":"8c757b0c.e26ff8","type":"change","z":"7232e01d.add9e","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1650,"y":1880,"wires":[["f479ea66.d5bf48"]]},{"id":"85f54888.ddb5f8","type":"change","z":"7232e01d.add9e","name":"Reset tv_shutdown_date","rules":[{"t":"set","p":"tv_shutdown_date","pt":"flow","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1760,"y":1800,"wires":[[]]},{"id":"7b996969.a238f8","type":"api-current-state","z":"7232e01d.add9e","name":"Auto shutdown is true","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.living_tv_auto_shutdown","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1100,"y":1600,"wires":[["1cadf619.c874ea"],["1cadf619.c874ea"]]},{"id":"926eaf46.8662c","type":"api-call-service","z":"7232e01d.add9e","name":"Turn off living room TV power","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.living_room_plug_1","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1080,"y":1740,"wires":[[]]},{"id":"6a57e7ad.780438","type":"delay","z":"7232e01d.add9e","name":"Wait 2 seconds","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":820,"y":1740,"wires":[["926eaf46.8662c"]]},{"id":"8ede8643.1d2058","type":"switch","z":"7232e01d.add9e","name":"If it's allowed contact","property":"header.caller","propertyType":"msg","rules":[{"t":"cont","v":"Bistro","vt":"str"},{"t":"cont","v":"Tatiana","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":680,"y":620,"wires":[["b407aa56.ee51c8","16a9eb8b.162d04"],[]]},{"id":"b407aa56.ee51c8","type":"api-call-service","z":"7232e01d.add9e","name":"Open the gate","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"toggle","entityId":"switch.colina_gate","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":890,"y":620,"wires":[["caad0980.2541f8"]]},{"id":"caad0980.2541f8","type":"subflow:c28ba6b7.4557d8","z":"7232e01d.add9e","name":"Logbook","env":[{"name":"name","value":"Open the gate for FitFoodWay","type":"str"},{"name":"message","value":"Open the gate for FitFoodWay","type":"str"},{"name":"domain","value":"script","type":"str"},{"name":"entity_id","value":"open_gate","type":"str"}],"x":1090,"y":620,"wires":[[]]},{"id":"5ae2a870.421c28","type":"debug","z":"7232e01d.add9e","name":"Call info","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"header.caller","statusType":"msg","x":690,"y":560,"wires":[]},{"id":"16a9eb8b.162d04","type":"subflow:49c5443a.0ad96c","z":"7232e01d.add9e","name":"","env":[{"name":"entity_id","value":"light.bedroom_light, ","type":"str"},{"name":"color_name","value":"red","type":"str"}],"x":890,"y":700,"wires":[[]]},{"id":"bb17820c.e636a","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Turn off whisper mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.alexa_global_whisper","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1060,"y":280,"wires":[[]]},{"id":"10ff5ea.65e88a1","type":"inject","z":"53c8d8b3.d233f8","name":"At 23","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 23 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":60,"wires":[["5d23f5d5.75727c"]]},{"id":"5d23f5d5.75727c","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Turn on sleep mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"input_boolean.sleep_mode","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":60,"wires":[[]]},{"id":"a1efff0c.df0a1","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Turn on whisper mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"input_boolean.alexa_global_whisper","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1060,"y":180,"wires":[[]]},{"id":"d0dacaff.ff4f88","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Turn off sleep mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"input_boolean.sleep_mode","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":620,"y":120,"wires":[[]]},{"id":"1df2ae20.449792","type":"server-state-changed","z":"53c8d8b3.d233f8","name":"Sleep mode on","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.sleep_mode","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"true","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":700,"y":240,"wires":[["a1efff0c.df0a1"],["bb17820c.e636a"]]},{"id":"68074749.692268","type":"bigtimer","z":"53c8d8b3.d233f8","outtopic":"","outpayload1":"","outpayload2":"","name":"Close curtain at sunrise, open at 8AM","comment":"","lat":"47.158455","lon":"27.601442","starttime":"495","endtime":"5003","startoff":"0","endoff":0,"startoff2":"","endoff2":"","offs":0,"outtext1":"on","outtext2":"off","timeout":1440,"sun":true,"mon":true,"tue":true,"wed":true,"thu":true,"fri":true,"sat":true,"jan":true,"feb":true,"mar":true,"apr":true,"may":true,"jun":true,"jul":true,"aug":true,"sep":true,"oct":true,"nov":true,"dec":true,"day1":0,"month1":0,"day2":0,"month2":0,"day3":0,"month3":0,"day4":0,"month4":0,"day5":0,"month5":0,"day6":"","month6":"","day7":"","month7":"","day8":"","month8":"","day9":"","month9":"","day10":"","month10":"","day11":"","month11":"","day12":"","month12":"","d1":0,"w1":0,"d2":0,"w2":0,"d3":0,"w3":0,"d4":0,"w4":0,"d5":0,"w5":0,"d6":"","w6":"","xday1":"","xmonth1":"","xday2":"","xmonth2":"","xday3":"","xmonth3":"","xday4":"","xmonth4":"","xday5":"","xmonth5":"","xday6":"","xmonth6":"","xday7":"","xmonth7":"","xday8":"","xmonth8":"","xday9":"","xmonth9":"","xday10":"","xmonth10":"","xday11":"","xmonth11":"","xday12":"","xmonth12":"","xd1":"","xw1":"","xd2":"","xw2":"","xd3":"","xw3":"","xd4":"","xw4":"","xd5":"","xw5":"","xd6":"","xw6":"","suspend":false,"random":false,"randon1":false,"randoff1":false,"randon2":false,"randoff2":false,"repeat":true,"atstart":false,"odd":false,"even":false,"x":210,"y":520,"wires":[[],[],["b2ae04fc.7805f8"]]},{"id":"b2ae04fc.7805f8","type":"switch","z":"53c8d8b3.d233f8","name":"Switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":450,"y":540,"wires":[[],["24c11f3d.5a9a4","44df02598e2120e7"]]},{"id":"24c11f3d.5a9a4","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Close bedroom curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"close_cover","entityId":"cover.bedroom_curtain","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":720,"y":580,"wires":[[]]},{"id":"10e724ff.d736ab","type":"server-state-changed","z":"53c8d8b3.d233f8","name":"All motion sensors off","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"group.all_motion_sensors","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":140,"y":760,"wires":[["7598437a.b95fcc"],["117d450b.d502fb","2c30170.c7ef4ea"]]},{"id":"7cf4d926.b69218","type":"api-current-state","z":"53c8d8b3.d233f8","name":"Someone is home","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"group.family","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":410,"y":640,"wires":[["62397d39.368d24"],[]]},{"id":"31b1d0f4.f6b0b","type":"subflow:c28ba6b7.4557d8","z":"53c8d8b3.d233f8","name":"Log family is sleepng","env":[{"name":"name","value":"Bujdea family","type":"str"},{"name":"message","value":"Sleeping","type":"str"},{"name":"domain","value":"input_select","type":"str"},{"name":"entity_id","value":"input_select.bujdea_family","type":"str"}],"x":980,"y":780,"wires":[[]]},{"id":"69264a5b.9f4c74","type":"subflow:d7bbbb62.ece328","z":"53c8d8b3.d233f8","name":"Set status to sleeping","env":[{"name":"status","value":"Sleeping","type":"str"}],"x":1000,"y":680,"wires":[]},{"id":"d10b4d2a.6ca98","type":"delay","z":"53c8d8b3.d233f8","name":"Wait 10 minutes","pauseType":"delay","timeout":"10","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":780,"y":680,"wires":[["69264a5b.9f4c74","31b1d0f4.f6b0b"]]},{"id":"117d450b.d502fb","type":"change","z":"53c8d8b3.d233f8","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":720,"y":780,"wires":[["d10b4d2a.6ca98"]]},{"id":"2c30170.c7ef4ea","type":"subflow:d7bbbb62.ece328","z":"53c8d8b3.d233f8","name":"Set status to home","env":[{"name":"status","value":"Home","type":"str"}],"x":490,"y":800,"wires":[]},{"id":"62397d39.368d24","type":"api-current-state","z":"53c8d8b3.d233f8","name":"TV is off","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"media_player.living_tv","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":580,"y":640,"wires":[["d10b4d2a.6ca98"],[]]},{"id":"7598437a.b95fcc","type":"api-current-state","z":"53c8d8b3.d233f8","name":"Family is not sleeping","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Sleeping","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"input_select.bujdea_family","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":180,"y":640,"wires":[["7cf4d926.b69218"],[]]},{"id":"dd3b1642.f313b8","type":"api-current-state","z":"53c8d8b3.d233f8","name":"Family is not sleeping","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"Sleeping","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"input_select.bujdea_family","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":460,"y":440,"wires":[[],[]]},{"id":"62eda8f6.a2c398","type":"inject","z":"53c8d8b3.d233f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":1340,"wires":[[]]},{"id":"193fbfd3.513ce","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Reset apartment","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"utility_meter","service":"calibrate","entityId":" sensor.um_apartment_power_hourly, sensor.um_apartment_power_daily, sensor.um_apartment_power_monthly","data":"{\"value\": 1}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":350,"y":1340,"wires":[[]]},{"id":"7cb9caeb.f62194","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Reset rest","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"utility_meter","service":"calibrate","entityId":"sensor.um_daily_steps, sensor.um_daily_todoist_tasks, sensor.um_monthly_todoist_tasks, sensor.um_daily_sitting_down, sensor.um_monthly_sitting_down, sensor.um_daily_standing_up, sensor.um_monthly_standing_up","data":"{\"value\": 0}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":330,"y":1400,"wires":[[]]},{"id":"bcd31314.5aadc","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Reset Officce","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"utility_meter","service":"calibrate","entityId":"sensor.um_office_hourly, sensor.um_office_daily, sensor.um_office_monthly","data":"{\"value\": 0.05}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":340,"y":1280,"wires":[[]]},{"id":"770523d1.c1183c","type":"inject","z":"53c8d8b3.d233f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":1280,"wires":[[]]},{"id":"2704301c.9d556","type":"inject","z":"53c8d8b3.d233f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":1400,"wires":[[]]},{"id":"15cfb2b1.bf58ad","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Reset Rest","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"utility_meter","service":"calibrate","entityId":"sensor.um_fridge_daily_power, sensor.um_fridge_monthly_power, sensor.um_living_room_hourly, sensor.um_living_room_daily, sensor.um_living_room_monthly, sensor.um_power_washer_daily, sensor.um_power_washer_monthly","data":"{\"value\": 0.05}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":330,"y":1200,"wires":[[]]},{"id":"83c06b34.a15f38","type":"inject","z":"53c8d8b3.d233f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":1200,"wires":[[]]},{"id":"11a37a3a.ced316","type":"inject","z":"53c8d8b3.d233f8","name":"At 11","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 11 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":120,"wires":[["d0dacaff.ff4f88"]]},{"id":"e6c281ec.0324d","type":"inject","z":"53c8d8b3.d233f8","name":"At 12AM","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":300,"wires":[["98fded33.7335c"]]},{"id":"2fc17db.4b24382","type":"http request","z":"53c8d8b3.d233f8","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":320,"wires":[["a407f805.e37ac8"]]},{"id":"98fded33.7335c","type":"function","z":"53c8d8b3.d233f8","name":"Prepare history request","func":"msg.headers = {};\nmsg.method = \"POST\";\nmsg.url = \"http://192.168.1.133:5000/api/history/update-standing-up-sensors\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":300,"wires":[["2fc17db.4b24382"]]},{"id":"a407f805.e37ac8","type":"debug","z":"53c8d8b3.d233f8","name":"history","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":750,"y":320,"wires":[]},{"id":"44df02598e2120e7","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Close kids curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"close_cover","entityId":"cover.kids_room_curtain","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":710,"y":520,"wires":[["a07b7f9ea3525cd0"]]},{"id":"a07b7f9ea3525cd0","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Close kids night light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.lidl_plug","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1000,"y":520,"wires":[[]]},{"id":"0f7edd1e0bed8739","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Open kids curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"open_cover","entityId":"cover.kids_room_curtain","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":930,"y":360,"wires":[[]]},{"id":"356abef97eb6669d","type":"api-call-service","z":"53c8d8b3.d233f8","name":"Open bedroom curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"open_cover","entityId":"cover.bedroom_curtain","data":"","dataType":"json","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":960,"y":440,"wires":[[]]},{"id":"ba90af2.426205","type":"server-state-changed","z":"78619586.97010c","name":"Apartment door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.apartment_door_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":140,"y":260,"wires":[["c6748e40.9d325","5e8bbe18.d3495","fd6a9949.208c28"],["c6748e40.9d325"]]},{"id":"d9c897de.ba2988","type":"ha-wait-until","z":"78619586.97010c","name":"Wait 1 minute","server":"8501408e.93b69","outputs":2,"entityId":"binary_sensor.apartment_door_sensor","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"5","timeoutType":"num","timeoutUnits":"minutes","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":560,"y":40,"wires":[[],["3f4e75dd.994bea","a5d06b15.6f42e8"]]},{"id":"5e8bbe18.d3495","type":"api-call-service","z":"78619586.97010c","name":"Turn on hallway light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.front_hallway","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":420,"y":220,"wires":[[]]},{"id":"c6748e40.9d325","type":"api-current-state","z":"78619586.97010c","name":"","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.apartment_door_sensor","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":760,"y":280,"wires":[["994e93ad.c03b8"],["994e93ad.c03b8"]]},{"id":"994e93ad.c03b8","type":"switch","z":"78619586.97010c","name":"Check last change","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"},{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1130,"y":400,"wires":[[],[]]},{"id":"98a3bdfa.f794c","type":"api-call-service","z":"78619586.97010c","name":"Send notification","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"notify","service":"notify","entityId":"","data":"{\"message\":\"The front door is opened\", \"title\":\"Front door opened\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1130,"y":200,"wires":[[]]},{"id":"5487fa8.79c9a04","type":"server-state-changed","z":"78619586.97010c","name":"Fridge door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.fridge_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":130,"y":520,"wires":[["e8e00417.d5b268"],["566ade97.be466"]]},{"id":"22c0d9b1.4e80e6","type":"ha-wait-until","z":"78619586.97010c","name":"Wait 1 minute to close the door","server":"8501408e.93b69","outputs":2,"entityId":"binary_sensor.fridge_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"minutes","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":790,"y":420,"wires":[[],["21dd7257.792fbe"]]},{"id":"e8e00417.d5b268","type":"api-current-state","z":"78619586.97010c","name":"Fridge notification setting","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.fridge_notification","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":430,"y":480,"wires":[["22c0d9b1.4e80e6"],[]]},{"id":"fb1955c.7880ba8","type":"server-state-changed","z":"78619586.97010c","name":"Bathroom door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bathroom_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":160,"y":920,"wires":[["d71ae607.a23bd8"],["d71ae607.a23bd8"]]},{"id":"21dd7257.792fbe","type":"api-current-state","z":"78619586.97010c","name":"Fridge notification setting","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.fridge_notification","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1110,"y":500,"wires":[["6b539bc.a2a0664"],[]]},{"id":"8b4bef5f.b3063","type":"subflow:3134fb52.d06d64","z":"78619586.97010c","name":"Apartment door opened","env":[{"name":"broadcast","type":"bool","value":"true"},{"name":"message","value":"\"The apartment door is opened\"","type":"str"},{"name":"volumeLevel","value":"6","type":"num"}],"x":870,"y":200,"wires":[["98a3bdfa.f794c","b64182e6.9ec1d"],[]]},{"id":"46b0c6aa.81cc08","type":"server-state-changed","z":"78619586.97010c","name":"Bedroom door","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bedroom_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":154,"y":1025,"wires":[[]]},{"id":"dada025a.95be9","type":"server-state-changed","z":"78619586.97010c","name":"Bedroom window","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bedroom_window","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":160,"y":1180,"wires":[["d71ae607.a23bd8"]]},{"id":"d71ae607.a23bd8","type":"function","z":"78619586.97010c","name":"Prepare message","func":"const globalHomeAssistant = global.get('homeassistant');\nvar friendlyName = msg.data.new_state.attributes.friendly_name;\nvar state = msg.payload == \"on\" ? \"opened\" : \"closed\";\nmsg.payload = friendlyName + \" \" + state;\n\nmsg.message = msg.payload;\nmsg.title = msg.payload;\n\nif(friendlyName.toLowerCase().indexOf(\"window\") != -1){\n    var allowWindowNotifications = globalHomeAssistant.homeAssistant.states[\"input_boolean.windows_state_notifications\"].state;\n    if(allowWindowNotifications == \"on\"){\n        return msg;\n    }\n    else{\n        msg.payload = \"\";\n        return msg;\n    }\n}\nmsg.allowDoorsNotifications = globalHomeAssistant.homeAssistant.states[\"input_boolean.doors_state_notifications\"].state;\nmsg.office = globalHomeAssistant.homeAssistant.states[\"input_boolean.office_door_state_notifications\"].state;\nif(friendlyName.toLowerCase().indexOf(\"door\") != -1){\n    var allowDoorsNotifications = globalHomeAssistant.homeAssistant.states[\"input_boolean.doors_state_notifications\"].state;\n    if(allowDoorsNotifications == \"off\"){\n        msg.payload = \"\";\n        return msg;\n    }\n    if(friendlyName.toLowerCase().indexOf(\"bedroom\") != -1){\n        if(globalHomeAssistant.homeAssistant.states[\"input_boolean.bedroom_door_state_notifications\"].state == \"on\"){\n            return msg;\n        }\n        else{\n            msg.payload = \"\";\n        }\n    }\n    if(friendlyName.toLowerCase().indexOf(\"office\") != -1){\n        if(globalHomeAssistant.homeAssistant.states[\"input_boolean.office_door_state_notifications\"].state == \"on\"){\n            return msg;\n        }\n        else{\n            msg.payload = \"\";\n        }\n    }\n    if(friendlyName.toLowerCase().indexOf(\"apartment\") != -1){\n        if(globalHomeAssistant.homeAssistant.states[\"input_boolean.front_door_state_notifications\"].state == \"on\"){\n            return msg;\n        }\n        else{\n            msg.payload = \"\";\n        }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":1120,"wires":[["ed412bbe.042988"]]},{"id":"54aea179.87342","type":"server-state-changed","z":"78619586.97010c","name":"Office door","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":160,"y":1100,"wires":[["d71ae607.a23bd8"]]},{"id":"84c5cf20.0e7a8","type":"server-state-changed","z":"78619586.97010c","name":"Bathroom window","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.bathroom_window","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":170,"y":1260,"wires":[["d71ae607.a23bd8"]]},{"id":"3a8153a1.ce44ec","type":"server-state-changed","z":"78619586.97010c","name":"Living room window","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.living_room_window","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":170,"y":1320,"wires":[["d71ae607.a23bd8"]]},{"id":"83a5ce7c.3e76","type":"server-state-changed","z":"78619586.97010c","name":"Kids window","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.kids_window","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":150,"y":1380,"wires":[["d71ae607.a23bd8"]]},{"id":"9008d1ba.9bdbd","type":"server-state-changed","z":"78619586.97010c","name":"Kitchen window","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.kitchen_window","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":160,"y":1440,"wires":[["d71ae607.a23bd8"]]},{"id":"ed412bbe.042988","type":"switch","z":"78619586.97010c","name":"Message not empty","property":"payload","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":970,"y":1100,"wires":[["3ffc3797.d12a98"]]},{"id":"1bc7ab2e.c72275","type":"server-state-changed","z":"78619586.97010c","name":"Office door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":150,"y":1520,"wires":[["d488e64f.633028"],[]]},{"id":"d488e64f.633028","type":"api-call-service","z":"78619586.97010c","name":"Turn on office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"brightness\":155, \"transition\": 1}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":400,"y":1520,"wires":[[]]},{"id":"d508034e.a6f08","type":"subflow:3134fb52.d06d64","z":"78619586.97010c","name":"Notify that the fridge is opened","env":[{"name":"message","value":"\"The fridge door is opened\"","type":"str"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"}],"x":890,"y":780,"wires":[["22c0d9b1.4e80e6"],[]]},{"id":"6b539bc.a2a0664","type":"subflow:3134fb52.d06d64","z":"78619586.97010c","name":"Play a beep when the fridge is opened","env":[{"name":"message","value":"\"The fridge door is opened\"","type":"str"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"sound","value":"bell_02","type":"str"}],"x":1430,"y":560,"wires":[["24484edd.e417c2"],[]]},{"id":"d9554855.8832a8","type":"api-current-state","z":"78619586.97010c","name":"Fridge notification setting","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.fridge_notification","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1130,"y":680,"wires":[["d508034e.a6f08"],[]]},{"id":"fd6a9949.208c28","type":"api-current-state","z":"78619586.97010c","name":"Apartment door notification settings","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.front_door_state_notifications","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":300,"y":100,"wires":[["d9c897de.ba2988"],[]]},{"id":"b64182e6.9ec1d","type":"api-current-state","z":"78619586.97010c","name":"Apartment door notification settings","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.front_door_state_notifications","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":660,"y":120,"wires":[["d9c897de.ba2988"],[]]},{"id":"3f4e75dd.994bea","type":"api-current-state","z":"78619586.97010c","name":"Apartment door notification settings","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.front_door_state_notifications","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1080,"y":100,"wires":[["8b4bef5f.b3063"],[]]},{"id":"a5d06b15.6f42e8","type":"api-current-state","z":"78619586.97010c","name":"Apartment door notification settings","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.front_door_state_notifications","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":820,"y":40,"wires":[["55789d42.d19414"],[]]},{"id":"7e007edb.672af","type":"debug","z":"78619586.97010c","name":"garage","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":440,"y":1860,"wires":[]},{"id":"572575a2.df798c","type":"api-call-service","z":"78619586.97010c","name":"Set door opened","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.garage_door_opened","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":460,"y":1800,"wires":[["661e6401.858d3c"]]},{"id":"c2ba836b.d6cc","type":"api-call-service","z":"78619586.97010c","name":"Set door closed","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.garage_door_opened","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":440,"y":1900,"wires":[["8a034024.bb38a"]]},{"id":"661e6401.858d3c","type":"subflow:c28ba6b7.4557d8","z":"78619586.97010c","name":"","env":[{"name":"name","value":"Garage door","type":"str"},{"name":"message","value":"Garage door opened","type":"str"},{"name":"domain","value":"input_boolean","type":"str"}],"x":700,"y":1800,"wires":[[]]},{"id":"8a034024.bb38a","type":"subflow:c28ba6b7.4557d8","z":"78619586.97010c","name":"","env":[{"name":"name","value":"Garage door","type":"str"},{"name":"message","value":"Garage door closed","type":"str"},{"name":"domain","value":"input_boolean","type":"str"}],"x":700,"y":1900,"wires":[[]]},{"id":"caf42517.e527d8","type":"ha-webhook","z":"78619586.97010c","name":"Storage room opened","server":"8501408e.93b69","outputs":1,"webhookId":"PiJsuBBkI8Cc03vxW6CSrCb7WspDa5An","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"","headersLocationType":"none","x":140,"y":2020,"wires":[["2bc1b6f9.f73baa"]]},{"id":"764f5e7f.e03e8","type":"ha-webhook","z":"78619586.97010c","name":"Storage room closed","server":"8501408e.93b69","outputs":1,"webhookId":"z8hTRdPMmtIjGKsG26GDazBMxhOV2IQU","payloadLocation":"payload","payloadLocationType":"msg","headersLocation":"","headersLocationType":"none","x":130,"y":2100,"wires":[["7777adca.7a72a4"]]},{"id":"a1f58514.58c178","type":"server-state-changed","z":"78619586.97010c","name":"Garage","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.xiaomi_garage_door_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":110,"y":1820,"wires":[["572575a2.df798c","7e007edb.672af","ae45fb99.6d3508"],["c2ba836b.d6cc","7e007edb.672af"]]},{"id":"ae45fb99.6d3508","type":"ha-wait-until","z":"78619586.97010c","name":"Garage door is opened for more than 1 hour","server":"8501408e.93b69","outputs":2,"entityId":"binary_sensor.garage_door_shelly","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"hours","entityLocation":"","entityLocationType":"none","checkCurrentState":true,"blockInputOverrides":true,"x":450,"y":1700,"wires":[[],["50388ee8.3d37d","7d6b204f.88226"]]},{"id":"50388ee8.3d37d","type":"subflow:b6e164fe.1d31e8","z":"78619586.97010c","name":"Notify garage door is opened","env":[{"name":"message","value":"The garage door is opened for more than 1 hour","type":"str"},{"name":"title","value":"Garage door is opened","type":"str"}],"x":820,"y":1660,"wires":[[]]},{"id":"7d6b204f.88226","type":"subflow:c28ba6b7.4557d8","z":"78619586.97010c","name":"Log message","env":[{"name":"name","value":"Garage door","type":"str"},{"name":"message","value":"The garage door is opened for more than 1 hour","type":"str"},{"name":"domain","value":"sensor","type":"str"},{"name":"entity_id","value":"binary_sensor.garage_door_shelly","type":"str"}],"x":780,"y":1720,"wires":[[]]},{"id":"2bc1b6f9.f73baa","type":"subflow:b6e164fe.1d31e8","z":"78619586.97010c","name":"Storage unit door is opened notification","env":[{"name":"message","value":"The storage unit door is opened","type":"str"},{"name":"title","value":"Storage unit door is opened","type":"str"}],"x":470,"y":2020,"wires":[["76c3e08f.d7edb"]]},{"id":"76c3e08f.d7edb","type":"subflow:c28ba6b7.4557d8","z":"78619586.97010c","name":"Log message","env":[{"name":"name","value":"Storage unit door","type":"str"},{"name":"message","value":"The storage unit door is opened","type":"str"},{"name":"domain","value":"binary_sensor","type":"str"}],"x":740,"y":2020,"wires":[[]]},{"id":"7777adca.7a72a4","type":"subflow:b6e164fe.1d31e8","z":"78619586.97010c","name":"Storage unit door is closed notification","env":[{"name":"message","value":"The storage unit door is closed","type":"str"},{"name":"title","value":"Storage unit door is closed","type":"str"}],"x":470,"y":2100,"wires":[["f011dc9b.1a2c5"]]},{"id":"f011dc9b.1a2c5","type":"subflow:c28ba6b7.4557d8","z":"78619586.97010c","name":"Log message","env":[{"name":"name","value":"Storage unit door","type":"str"},{"name":"message","value":"The storage unit door is closed","type":"str"},{"name":"domain","value":"binary_sensor","type":"str"}],"x":740,"y":2100,"wires":[[]]},{"id":"3ffc3797.d12a98","type":"subflow:b6e164fe.1d31e8","z":"78619586.97010c","name":"Send notification","env":[],"x":1220,"y":1100,"wires":[[]]},{"id":"ebd87890.9b9168","type":"server-state-changed","z":"78619586.97010c","name":"Apartment door opened","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.apartment_door_sensor","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":140,"y":860,"wires":[["d71ae607.a23bd8"],["d71ae607.a23bd8"]]},{"id":"24484edd.e417c2","type":"delay","z":"78619586.97010c","name":"Wait 5 seconds","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1310,"y":620,"wires":[["d9554855.8832a8"]]},{"id":"566ade97.be466","type":"change","z":"78619586.97010c","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":560,"wires":[["24484edd.e417c2"]]},{"id":"d7e9eae8.0dacd8","type":"api-call-service","z":"78619586.97010c","name":"Turn off office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"group.office_lights","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1420,"y":3040,"wires":[[]]},{"id":"55789d42.d19414","type":"subflow:49c5443a.0ad96c","z":"78619586.97010c","name":"Flash lights","env":[{"name":"entity_id","value":"group.hallway_lights","type":"str"},{"name":"color_name","value":"white","type":"str"}],"x":1130,"y":40,"wires":[[]]},{"id":"3dce9b15.b77764","type":"api-call-service","z":"89eaed19.74745","name":"3. Toggle ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.bedroom_light","data":"{\"transition\":\"1\", \"brightness\":255}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":720,"y":440,"wires":[[]]},{"id":"28ae480.c86f8b8","type":"api-call-service","z":"89eaed19.74745","name":"Toggle lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.bedroom_lightstrip","data":"{\"transition\":\"1\", \"brightness\":255}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":700,"y":380,"wires":[[]]},{"id":"9ce37c10.bcc87","type":"api-call-service","z":"89eaed19.74745","name":"2. Toggle TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"toggle","entityId":"switch.bedroom_tv","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":690,"y":240,"wires":[[]]},{"id":"2d0fc503.ab738a","type":"api-call-service","z":"89eaed19.74745","name":"Long. Open Curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"open_cover","entityId":"cover.bedroom_curtain","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1530,"y":60,"wires":[[]]},{"id":"cb31f6f5.eefc38","type":"api-call-service","z":"89eaed19.74745","name":"Toggle ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.sonoff_kids_light","data":"{\"transition\":\"1\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":570,"y":1420,"wires":[[]]},{"id":"ece1de15.d25bb","type":"subflow:3134fb52.d06d64","z":"89eaed19.74745","name":"Notify opened windows","env":[{"name":"shouldWhisper","type":"bool","value":"true"},{"name":"volumeLevel","value":"3","type":"num"},{"name":"only_on_occupied_rooms","type":"bool","value":"true"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"}],"x":830,"y":800,"wires":[[],[]]},{"id":"d198c5ec.c064e8","type":"function","z":"89eaed19.74745","name":"Get opened windows","func":"const globalHomeAssistant = global.get('homeassistant');\nvar livingRoomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.living_room_window\"].state;\nvar bedroomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.bedroom_window\"].state;\nvar bathroomWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.bathroom_window\"].state;\nvar kidsWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.kids_window\"].state;\nvar kitchenWindow = globalHomeAssistant.homeAssistant.states[\"binary_sensor.kitchen_window\"].state;\nvar windows = \"\";\nvar count = 0;\nif(livingRoomWindow == 'on'){\n     windows += \"living room, \";\n     count++;\n }\nif(bedroomWindow == 'on'){\n windows += \"bedroom, \";   \n count++;\n}\nif(bathroomWindow == 'on'){\n windows += \"bathroom room\";\n count++;\n}\nif(kidsWindow == 'on'){\n windows += \"kids room\";\n count++;\n}\nif(kitchenWindow == 'on'){\n windows += \"kitchen\";\n count++;\n}\nvar message = '';\nif(count === 0){\n    message = \"There are no windows opened\";\n}\nif(count > 0){\n    message = 'There are ' + count + ' windows opened';\n    message += ': ' + windows;\n}\nglobal.set(\"AlexaMessage\", message);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":560,"y":780,"wires":[["ece1de15.d25bb"]]},{"id":"ea5c61ae.606d5","type":"api-current-state","z":"89eaed19.74745","name":"1. Bedroom lights","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"group.bedroom_lights","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":710,"y":180,"wires":[["ae2c892c.2234d8"]]},{"id":"ae2c892c.2234d8","type":"switch","z":"89eaed19.74745","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1270,"y":600,"wires":[["644faa41.1a71f4"],["5accd80c.a56148"]]},{"id":"644faa41.1a71f4","type":"api-call-service","z":"89eaed19.74745","name":"Turn off group","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"","data":"{\"entity_id\": msg.topic , \"transition\":0}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1460,"y":480,"wires":[[]]},{"id":"1fc3b3ac.22281c","type":"api-call-service","z":"89eaed19.74745","name":"Volume down TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.bedroom_tv_volume_down","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":970,"y":620,"wires":[[]]},{"id":"90c64dd7.040da","type":"api-call-service","z":"89eaed19.74745","name":"Volume up TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.bedroom_tv_volume_up","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":960,"y":560,"wires":[[]]},{"id":"d2f35abc.1ad368","type":"server-events","z":"89eaed19.74745","name":"Deconz Event","server":"8501408e.93b69","event_type":"dconz_event","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":90,"y":1080,"wires":[["edb6875f.19aba8","70140d6a.b55654","fd057843.f57268","17e24b82.369be4","c1396921.2ee4c8"]]},{"id":"edb6875f.19aba8","type":"switch","z":"89eaed19.74745","name":"Check which switch fired","property":"payload.event.id","propertyType":"msg","rules":[{"t":"eq","v":"office_switch","vt":"str"},{"t":"eq","v":"living_room_switch","vt":"str"},{"t":"eq","v":"bedroom_door_switch","vt":"str"},{"t":"eq","v":"hallway_door_switch","vt":"str"},{"t":"eq","v":"bedroom_bed_switch","vt":"str"},{"t":"eq","v":"kids_room_switch","vt":"str"},{"t":"eq","v":"kitchen_hue_remote","vt":"str"},{"t":"eq","v":"mi_magic_cube","vt":"str"},{"t":"eq","v":"switch_50","vt":"str"}],"checkall":"true","repair":false,"outputs":9,"x":350,"y":1100,"wires":[["5bc6cc14.033524"],["71add01f.cefcc"],["e687dfb3.9db3b"],["5f1e246f.b50f4c"],["8e13d90a.b6f4a8"],["9a18fe96.90bdc"],["87811e7f.62ed8"],["d87adf3d.bdc46"],["d87adf3d.bdc46"]]},{"id":"e687dfb3.9db3b","type":"switch","z":"89eaed19.74745","name":"Bedroom door switch","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":400,"y":280,"wires":[["ea5c61ae.606d5"],["9ce37c10.bcc87"],["b06a3b23.537178"],["28ae480.c86f8b8"],["3dce9b15.b77764"],["df901941.9021e8"]]},{"id":"8e13d90a.b6f4a8","type":"switch","z":"89eaed19.74745","name":"Bedroom bed switch","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":380,"y":120,"wires":[["9ea16cd.c0e619"],["9ce37c10.bcc87"],["dd3dda47.ae59d8"],[],[],["df901941.9021e8"]]},{"id":"5f1e246f.b50f4c","type":"switch","z":"89eaed19.74745","name":"Front hallway Xiaomi switch","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":280,"y":840,"wires":[["d198c5ec.c064e8"],[],["564057e9.724ce8"],[],[],["d58fd1b4.f6642"]]},{"id":"9a18fe96.90bdc","type":"switch","z":"89eaed19.74745","name":"Kids switch","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"false","repair":false,"outputs":6,"x":430,"y":1520,"wires":[["cb31f6f5.eefc38"],[],[],[],[],["77ab91f2.5a142"]]},{"id":"70140d6a.b55654","type":"switch","z":"89eaed19.74745","name":"Philips Hue switch long pressed turn off","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"4003","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":300,"y":1740,"wires":[["ace8208e.1c64b"]]},{"id":"ace8208e.1c64b","type":"api-call-service","z":"89eaed19.74745","name":"Turn off all lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"all","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":720,"y":1740,"wires":[[]]},{"id":"fd057843.f57268","type":"function","z":"89eaed19.74745","name":"Prepare message","func":"var button = \"\";\nvar event = msg.payload.event.event;\nif(event % 1000 === 0){\n    msg.shouldContinue = false;\n    return;\n}\nmsg.shouldContinue = true;\nswitch(event){\n    case 1002:\n        button = \"single click\";\n        break;\n    case 1004:\n        button = \"double click\";\n        break;\n    case 1005:\n        button = \"triple click\";\n        break;\n    case 1006:\n        button = \"quadruple click\";\n        break;\n    case 1010:\n        button = \"multiple click\";\n        break;\n    case 1003:\n        button = \"long click\";\n        break;\n    case 1002:\n        button = \"on click\";\n        break;\n    case 2002:\n        button = \"+ click\";\n        break;\n    case 3002:\n        button = \"- click\";\n        break;\n    case 4002:\n        button = \"off click\";\n        break;\n    case 4003:\n        button = \"long click off\";\n        break;\n}\n\nvar hueRemotes = ['hallway_back_remote', 'hallway_front_remote', \n'bathroom_remote', 'bedroom_remote', 'kitchen_hue_remote'];\nif(hueRemotes.indexOf(msg.payload.event.id) != -1 && event == 1002){\n    button = 'on click';\n}\nswitch(msg.payload.event.id){\n    case \"office_switch\":\n        msg.name = \"Office switch\";\n        msg.message = button;\n        break;\n    case \"kids_room_switch\":\n        msg.name = \"Kids switch\";\n        msg.message = button;\n        break;\n    \n    case \"hallway_door_switch\":\n        msg.name = \"Hallway door switch\";\n        msg.message = button;\n        break;\n    \n    case \"bedroom_bed_switch\":\n        msg.name = \"Bedroom bed switch\";\n        msg.message = button;\n        break;\n    \n    case \"living_room_switch\":\n        msg.name = \"Living room switch\";\n        msg.message = button;\n        break;\n    \n    case \"bedroom_door_switch\":\n        msg.name = \"Bedroom door switch\";\n        msg.message = button;\n        break;\n    case \"hallway_back_remote\":\n        msg.name = \"Hallway back remote\";\n        msg.message = button;\n        break;\n    case \"hallway_front_remote\":\n        msg.name = \"Hallway front remote\";\n        msg.message = button;\n        break;\n    case \"bathroom_remote\":\n        msg.name = \"Bathroom remote\";\n        msg.message = button;\n        break;\n    case \"bedroom_remote\":\n        msg.name = \"Bedroom hue remote\";\n        msg.message = button;\n        break;\n    case \"kitchen_hue_remote\":\n        msg.name = \"Kitchen remote\";\n        msg.message = button;\n        break;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":310,"y":960,"wires":[["e33d0365.bda9c"]]},{"id":"e33d0365.bda9c","type":"api-call-service","z":"89eaed19.74745","name":"Logbook","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"logbook","service":"log","entityId":"","data":"{\t    \"name\":msg.name,\t    \"domain\":\"switch\",\t    \"message\":msg.message\t}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":580,"y":940,"wires":[[]]},{"id":"34781c55.4c5884","type":"switch","z":"89eaed19.74745","name":"Philips Hue bedroom remote","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"2002","vt":"str"},{"t":"eq","v":"3002","vt":"str"},{"t":"eq","v":"4002","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":600,"y":560,"wires":[["9354df62.09de1"],["90c64dd7.040da"],["1fc3b3ac.22281c"],["e11e0ccb.70969"]]},{"id":"17e24b82.369be4","type":"switch","z":"89eaed19.74745","name":"Bedroom Philips Hue switch","property":"payload.event.id","propertyType":"msg","rules":[{"t":"eq","v":"bedroom_remote","vt":"str"},{"t":"eq","v":"hallway_front_remote","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":200,"y":700,"wires":[["34781c55.4c5884"],["5526f7a5.66a758"]]},{"id":"9354df62.09de1","type":"api-call-service","z":"89eaed19.74745","name":"Turn on bedroom light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"group.bedroom_lights","data":"{ \"brightness\":255, \"transition\": 0, \"color_name\": \"white\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":980,"y":500,"wires":[[]]},{"id":"e11e0ccb.70969","type":"api-call-service","z":"89eaed19.74745","name":"Turn off bedroom lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"group.bedroom_lights","data":"{ \"transition\":0}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":980,"y":680,"wires":[[]]},{"id":"8e9145fa.28cd48","type":"api-call-service","z":"89eaed19.74745","name":"Sleep mode","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.bedroom_lightstrip","data":"{\"transition\":\"1\", \"brightness\":55, \"color_name\":\"white\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1050,"y":60,"wires":[[]]},{"id":"9ea16cd.c0e619","type":"api-call-service","z":"89eaed19.74745","name":"Turn off bedroom ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.bedroom_light","data":"{ \"transition\":0}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":760,"y":60,"wires":[["8e9145fa.28cd48"]]},{"id":"5526f7a5.66a758","type":"switch","z":"89eaed19.74745","name":"Philips Hue hallway front remote","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"2002","vt":"str"},{"t":"eq","v":"3002","vt":"str"},{"t":"eq","v":"4002","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":570,"y":680,"wires":[["96ff2982.caad68"],[],[],[]]},{"id":"5accd80c.a56148","type":"api-call-service","z":"89eaed19.74745","name":"Turn on light(s)","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":msg.topic, \"brightness\":255, \"transition\": 0, \"color_name\":\"white\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1460,"y":780,"wires":[[]]},{"id":"d58fd1b4.f6642","type":"subflow:d7bbbb62.ece328","z":"89eaed19.74745","name":"Set family status to away","env":[{"name":"status","value":"Away","type":"str"}],"x":550,"y":880,"wires":[]},{"id":"77ab91f2.5a142","type":"subflow:45600ca3.e7f3f4","z":"89eaed19.74745","name":"Kids room cleanup","env":[{"name":"room","value":"script.1584736170010","type":"str"}],"x":670,"y":1500,"wires":[[]]},{"id":"564057e9.724ce8","type":"subflow:45600ca3.e7f3f4","z":"89eaed19.74745","name":"Apartment cleanup","env":[{"name":"room","value":"script.1584735527658","type":"str"}],"x":550,"y":820,"wires":[[]]},{"id":"b06a3b23.537178","type":"subflow:45600ca3.e7f3f4","z":"89eaed19.74745","name":"Bedroom cleanup","env":[{"name":"room","value":"script.1584735991442","type":"str"}],"x":730,"y":320,"wires":[[]]},{"id":"4a998f5a.1c87c","type":"inject","z":"89eaed19.74745","name":"","props":[{"p":"payload.event.gesture","v":"7","vt":"num"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":690,"y":1840,"wires":[["d87adf3d.bdc46"]]},{"id":"1bd8c1c3.3a38de","type":"switch","z":"89eaed19.74745","name":"Philips Hue switch long pressed turn on","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1003","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":640,"y":2040,"wires":[["3fc107cb.01c3c8"]]},{"id":"c1396921.2ee4c8","type":"switch","z":"89eaed19.74745","name":"Back hallway Philips remote","property":"payload.event.id","propertyType":"msg","rules":[{"t":"eq","v":"hallway_back_remote","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":280,"y":2060,"wires":[["1bd8c1c3.3a38de"]]},{"id":"3fc107cb.01c3c8","type":"subflow:45600ca3.e7f3f4","z":"89eaed19.74745","name":"Hallway cleanup","env":[{"name":"room","value":"script.1584735527658","type":"str"}],"x":880,"y":1980,"wires":[[]]},{"id":"dd3dda47.ae59d8","type":"subflow:3134fb52.d06d64","z":"89eaed19.74745","name":"Notify Lavinia is awake","env":[{"name":"volumeLevel","value":"4","type":"num"},{"name":"office_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"notify_laptop_browser","type":"bool","value":"true"},{"name":"ignore_sleep_mode","type":"bool","value":"true"}],"x":740,"y":120,"wires":[[],[]]},{"id":"65c9af0f.043de","type":"api-call-service","z":"89eaed19.74745","name":"Turn on kitchen lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.kitchen_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":710,"y":2200,"wires":[[]]},{"id":"87811e7f.62ed8","type":"switch","z":"89eaed19.74745","name":"Kitchen Hue remote","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"2002","vt":"str"},{"t":"eq","v":"3002","vt":"str"},{"t":"eq","v":"4002","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":320,"y":2280,"wires":[["65c9af0f.043de"],[],[],["d04eca64.3bc558"]]},{"id":"d04eca64.3bc558","type":"api-call-service","z":"89eaed19.74745","name":"Turn off kitchen lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.kitchen_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":610,"y":2300,"wires":[[]]},{"id":"96ff2982.caad68","type":"api-call-service","z":"89eaed19.74745","name":"Turn on light(s)","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":\"group.hallway_lights\", \"brightness\":255, \"transition\": 0, \"color_name\":\"white\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":960,"y":740,"wires":[[]]},{"id":"d87adf3d.bdc46","type":"switch","z":"89eaed19.74745","name":"Office cube","property":"payload.event.gesture","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"str"},{"t":"eq","v":"7","vt":"str"},{"t":"eq","v":"8","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"false","repair":false,"outputs":4,"x":970,"y":1780,"wires":[["ce03b101.3ebde"],["5cf82095.a5932"],["5cf82095.a5932"],["6da6d99e.419298"]],"outputLabels":["Move","Rotate right","Rotate left",""]},{"id":"ce03b101.3ebde","type":"api-call-service","z":"89eaed19.74745","name":"Toggle office ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.sonoffofficelight","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1270,"y":1820,"wires":[[]]},{"id":"5cf82095.a5932","type":"function","z":"89eaed19.74745","name":"","func":"const globalHomeAssistant = global.get('homeassistant');\nvar light = globalHomeAssistant.homeAssistant.states[\"light.office_lightstrip\"];\nvar isOn = light.state == \"on\";\nmsg.oldBrightness = light.attributes.brightness;\nif(!isOn){\n    msg.action = \"turn_on_light\";\n    return msg;\n}\nmsg.rotation = parseInt(msg.payload.event.event);\nmsg.percentage = parseInt(msg.rotation/1000);\nmsg.newBrightness = msg.oldBrightness + (msg.percentage * 10);\nif(msg.newBrightness <= 0){\n    msg.action = \"turn_off_light\";\n}\nelse{\n    msg.action = \"turn_on_light\";\n}\nif(msg.newBrightness > 255){\n    msg.brightness = 255;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":1900,"wires":[["8911c638.4b2bc8"]]},{"id":"8911c638.4b2bc8","type":"switch","z":"89eaed19.74745","name":"Light action","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"turn_on_light","vt":"str"},{"t":"eq","v":"turn_off_light","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":1350,"y":1880,"wires":[["12812655.af1cba"],["b1f032c8.818d4"]],"outputLabels":["Move","Rotate right"]},{"id":"b1f032c8.818d4","type":"api-call-service","z":"89eaed19.74745","name":"Turn off office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.office_lightstrip","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1560,"y":1920,"wires":[[]]},{"id":"12812655.af1cba","type":"api-call-service","z":"89eaed19.74745","name":"Turn on office lightstrip","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":\"light.office_lightstrip\",\t\"brightness\":msg.newBrightness, \"transition\": 0, \"color_name\":\"white\"}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1560,"y":1840,"wires":[[]]},{"id":"6da6d99e.419298","type":"api-call-service","z":"89eaed19.74745","name":"Refresh HA","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"browser_mod","service":"window_reload","entityId":"","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1170,"y":1960,"wires":[["30554ae7.232b96"]]},{"id":"df901941.9021e8","type":"counter","z":"89eaed19.74745","name":"Counter","init":"0","step":"1","lower":"","upper":"","mode":"increment","outputs":"1","x":1000,"y":260,"wires":[["215d7a1.e6f3786"]]},{"id":"df12380.8183ec8","type":"switch","z":"89eaed19.74745","name":"Open/close","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"open","vt":"str"},{"t":"eq","v":"close","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1330,"y":180,"wires":[["2d0fc503.ab738a"],["41697c9d.d9b5e4"]]},{"id":"215d7a1.e6f3786","type":"function","z":"89eaed19.74745","name":"","func":"if(msg.count%2 == 0)\nmsg.action = \"open\";\nelse msg.action = \"close\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1220,"y":300,"wires":[["df12380.8183ec8"]]},{"id":"41697c9d.d9b5e4","type":"api-call-service","z":"89eaed19.74745","name":"Long. Close Curtain","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"cover","service":"close_cover","entityId":"cover.bedroom_curtain","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1520,"y":320,"wires":[[]]},{"id":"30554ae7.232b96","type":"api-call-service","z":"89eaed19.74745","name":"Turn off screensaver","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"switch","service":"turn_off","entityId":"switch.office_pi_screensaver","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1380,"y":2000,"wires":[["623cd226.9f7cbc"]]},{"id":"623cd226.9f7cbc","type":"api-call-service","z":"89eaed19.74745","name":"Turn on PI screen","server":"8501408e.93b69","version":1,"debugenabled":true,"service_domain":"light","service":"turn_on","entityId":"light.office_touchscreen","data":"","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1390,"y":2080,"wires":[[]]},{"id":"5bc6cc14.033524","type":"switch","z":"89eaed19.74745","name":"Office","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":690,"y":1140,"wires":[["fdf61777.cd2568"],["da6bcdc7.49326"],["42bd4749.fdc098"],["3c76c77c.7a95c8"],[],["10d5b5ab.65698a"]]},{"id":"da6bcdc7.49326","type":"api-call-service","z":"89eaed19.74745","name":"Toggle office ceiling light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"homeassistant","service":"toggle","entityId":"light.sonoffofficelight","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":910,"y":1060,"wires":[[]]},{"id":"3c76c77c.7a95c8","type":"api-call-service","z":"89eaed19.74745","name":"Reset office light","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"{\"entity_id\":\"light.office_lightstrip\", \"color_name\":\"white\",\"brightness\":255,  \"transition\": 0.5}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":900,"y":1180,"wires":[[]]},{"id":"42bd4749.fdc098","type":"api-current-state","z":"89eaed19.74745","name":"Office lightstrip","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"light.office_lightstrip","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":920,"y":1120,"wires":[["ae2c892c.2234d8"]]},{"id":"4aefef5.c5d461","type":"inject","z":"89eaed19.74745","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1320,"y":1120,"wires":[["d1483886.3ce018"]]},{"id":"fdf61777.cd2568","type":"subflow:7f445a94.cd19d4","z":"89eaed19.74745","name":"Switch Office monitor view","env":[],"x":860,"y":980,"wires":[[]]},{"id":"3818df83.487c4","type":"subflow:1366240e.7be4ac","z":"89eaed19.74745","name":"","env":[],"x":1050,"y":1400,"wires":[[]]},{"id":"10d5b5ab.65698a","type":"api-current-state","z":"89eaed19.74745","name":"Focus mode is on","server":"8501408e.93b69","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"var.focus_mode","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":850,"y":1240,"wires":[["a269af43.89ebb"],["3818df83.487c4"]]},{"id":"82a44f55.4fbde","type":"http request","z":"89eaed19.74745","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1390,"y":1360,"wires":[["12a16d02.8f1c53","9a2c126c.47169"]]},{"id":"12a16d02.8f1c53","type":"debug","z":"89eaed19.74745","name":"Focus","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1710,"y":1420,"wires":[]},{"id":"894668b9.eb9a88","type":"http request","z":"89eaed19.74745","name":"","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1390,"y":1300,"wires":[["4d27da23.8f2734"]]},{"id":"d1483886.3ce018","type":"function","z":"89eaed19.74745","name":"Prepare Freedom schedules Request","func":"msg.headers = {};\nmsg.method = \"GET\";\nmsg.mode = \"cors\";\nmsg.credentials = \"include\";\nmsg.url = \"https://freedom.to/schedules/\";\nmsg.headers = {\n    \"accept\": \"application/json, */*; q=0.01\",\n    \"accept-language\": \"en-US,en;q=0.9,ro;q=0.8,it;q=0.7,mt;q=0.6,de;q=0.5\",\n    \"content-type\": \"application/json\",\n    \"if-none-match\": \"W/\\\"69fccce06f9c04422d5ff28537fbc0a0\\\"\",\n    \"sec-fetch-dest\": \"empty\",\n    \"sec-fetch-mode\": \"cors\",\n    \"sec-fetch-site\": \"same-origin\",\n    \"x-requested-with\": \"XMLHttpRequest\",\n    \"Cookie\": msg.cookie\n  };\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":1240,"wires":[["894668b9.eb9a88"]]},{"id":"7e94dc4d.b6aba4","type":"function","z":"89eaed19.74745","name":"Stop focus mode","func":"node.warn(msg);\nvar sessionId = JSON.parse(msg.payload).schedule[0].id;\n\nmsg.method = \"POST\";\n\nmsg.url = \"https://freedom.to/schedules/\"+sessionId+\"/end?force=\"+Date.now();\nnode.warn(msg.url);\nmsg.headers = {\n    \"accept\": \"*/*\",\n    \"accept-language\": \"en-US,en;q=0.9,ro;q=0.8,it;q=0.7,mt;q=0.6,de;q=0.5\",\n    \"cache-control\": \"no-cache\",\n    \"content-type\": \"application/json\",\n    \"pragma\": \"no-cache\",\n    \"sec-fetch-dest\": \"empty\",\n    \"sec-fetch-mode\": \"cors\",\n    \"sec-fetch-site\": \"same-origin\",\n    \"x-requested-with\": \"XMLHttpRequest\",\n    Cookie: msg.cookie\n\n  };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1770,"y":1300,"wires":[["82a44f55.4fbde"]]},{"id":"9a2c126c.47169","type":"subflow:6c1e9884.3e70a8","z":"89eaed19.74745","name":"","env":[],"x":1910,"y":1340,"wires":[]},{"id":"e421a801.4e0708","type":"api-current-state","z":"89eaed19.74745","name":"Living room lights","server":"8501408e.93b69","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"group.living_room_lights","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1210,"y":780,"wires":[["ae2c892c.2234d8"]]},{"id":"71add01f.cefcc","type":"switch","z":"89eaed19.74745","name":"Living room","property":"payload.event.event","propertyType":"msg","rules":[{"t":"eq","v":"1002","vt":"str"},{"t":"eq","v":"1004","vt":"str"},{"t":"eq","v":"1005","vt":"str"},{"t":"eq","v":"1006","vt":"str"},{"t":"eq","v":"1010","vt":"str"},{"t":"eq","v":"1001","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":970,"y":880,"wires":[["e421a801.4e0708"],["fddff8d0.a9b428"],["fe207ce4.a603d"],[],[],[]]},{"id":"fddff8d0.a9b428","type":"api-call-service","z":"89eaed19.74745","name":"Toggle living TV","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"media_player","service":"toggle","entityId":"media_player.living_tv","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1220,"y":860,"wires":[[]]},{"id":"fe207ce4.a603d","type":"subflow:45600ca3.e7f3f4","z":"89eaed19.74745","name":"Living room cleanup","env":[{"name":"room","value":"script.1584736860542","type":"str"}],"x":1220,"y":920,"wires":[[]]},{"id":"a269af43.89ebb","type":"credentials","z":"89eaed19.74745","name":"Set cookie","props":[{"value":"cookie","type":"msg"}],"x":1070,"y":1240,"wires":[["d1483886.3ce018"]]},{"id":"4d27da23.8f2734","type":"credentials","z":"89eaed19.74745","name":"Set cookie","props":[{"value":"cookie","type":"msg"}],"x":1590,"y":1300,"wires":[["7e94dc4d.b6aba4"]]},{"id":"3facf26f.c0fcfe","type":"server-state-changed","z":"fad5e040.09f7a","name":"","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.galaxy_s9_phone_state","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":290,"y":660,"wires":[["a3c5d7dd.3e27f8"]]},{"id":"a3c5d7dd.3e27f8","type":"debug","z":"fad5e040.09f7a","name":"State","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":670,"y":620,"wires":[]},{"id":"92c164d0.74fdc8","type":"server-state-changed","z":"fad5e040.09f7a","name":"","server":"8501408e.93b69","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.office_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":240,"y":240,"wires":[[],[]]},{"id":"8554bf39.a7feb","type":"inject","z":"fad5e040.09f7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":230,"y":400,"wires":[["6186ee1a.f209b"]]},{"id":"a6613ba3.323c88","type":"subflow:3134fb52.d06d64","z":"fad5e040.09f7a","name":"Bill","env":[{"name":"message","value":"<amazon:emotion name=\"excited\" intensity=\"low\"><s>Praise our lord Bill Gates, long live Microsoft!<break time=\"1s\"/> </s></amazon:emotion>","type":"str"},{"name":"volumeLevel","value":"2","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"ignore_sleep_mode","type":"bool","value":"true"}],"x":850,"y":400,"wires":[["4e412886.840008"],[]]},{"id":"395fa54c.1b85da","type":"api-call-service","z":"fad5e040.09f7a","name":"Lights","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.office_lightstrip","data":"{\"brightness\":255}","dataType":"jsonata","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":450,"y":320,"wires":[["6186ee1a.f209b"]]},{"id":"6186ee1a.f209b","type":"subflow:49c5443a.0ad96c","z":"fad5e040.09f7a","name":"Office lights flash","env":[{"name":"entity_id","value":"light.office_lightstrip","type":"str"},{"name":"color_name","value":"red","type":"str"}],"x":690,"y":360,"wires":[[]]},{"id":"abb6f8e2.b99778","type":"subflow:49c5443a.0ad96c","z":"fad5e040.09f7a","name":"Office lights flash","env":[{"name":"entity_id","value":"light.sonoffofficelight","type":"str"}],"x":710,"y":280,"wires":[[]]},{"id":"4e412886.840008","type":"subflow:3134fb52.d06d64","z":"fad5e040.09f7a","name":"Bill","env":[{"name":"message","value":"<amazon:emotion name=\"excited\" intensity=\"low\"><s>Praise our lord Bill Gates, long live Microsoft!<break time=\"1s\"/> </s></amazon:emotion>","type":"str"},{"name":"volumeLevel","value":"2","type":"num"},{"name":"kitchen_echo_dot","type":"bool","value":"false"},{"name":"hallway_echo_dot","type":"bool","value":"false"},{"name":"living_room_echo_dot","type":"bool","value":"false"},{"name":"bedroom_echo_dot","type":"bool","value":"false"},{"name":"bathroom_echo_dot","type":"bool","value":"false"},{"name":"ignore_sleep_mode","type":"bool","value":"true"}],"x":990,"y":380,"wires":[[],[]]},{"id":"d395d0197578664a","type":"inject","z":"f2ad30b932f27004","name":"Every 1 minutes","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"300","crontab":"","once":true,"onceDelay":"5","topic":"","payload":"","payloadType":"date","x":110,"y":220,"wires":[["04c4e542dd448fc9"]]},{"id":"04c4e542dd448fc9","type":"credentials","z":"f2ad30b932f27004","name":"Set cookie","props":[{"value":"rescueTimeCookie","type":"msg"}],"x":330,"y":220,"wires":[["1d626a38cb14223e"]]},{"id":"1d626a38cb14223e","type":"function","z":"f2ad30b932f27004","name":"Prepare RescueTime Request","func":"msg.url = \"https://www.rescuetime.com/widget_window/productivity\";\nmsg.headers = {};\nmsg.method = \"GET\";\nmsg.headers[\"Cookie\"] = msg.rescueTimeCookie;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":220,"wires":[["fb6082cd871038ea"]]},{"id":"fb6082cd871038ea","type":"http request","z":"f2ad30b932f27004","name":"Request","method":"use","ret":"txt","paytoqs":"body","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":true,"authType":"","senderr":false,"headers":[],"x":840,"y":220,"wires":[["78da01f99f50cab0"]]},{"id":"78da01f99f50cab0","type":"function","z":"f2ad30b932f27004","name":"Find productivity score","func":"const globalHomeAssistant = global.get('homeassistant');\nvar html = msg.payload;\nvar attributeName = \"efficiency_percent\";\nvar start = html.indexOf(attributeName);\nvar attr = html.substr(start + attributeName.length + 2, 5);\nmsg = {};\nmsg.start = start;\nmsg.productivity = parseInt(attr.replace(/\\\"/g, \"\").trim());\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":220,"wires":[[]]},{"id":"760c35c3f2e38197","type":"api-call-service","z":"f2ad30b932f27004","name":"Set productivity score","server":"8501408e.93b69","version":1,"debugenabled":false,"service_domain":"input_number","service":"set_value","entityId":"input_number.productivity_score","data":"{\"value\": msg.productivity}","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":1320,"y":220,"wires":[[]]},{"id":"ca1ee58e8537e8e9","type":"change","z":"96dd39fdae667f20","name":"Set Title and Message","rules":[{"t":"set","p":"message","pt":"msg","to":"Turn off light?","tot":"str"},{"t":"set","p":"title","pt":"msg","to":"Turn off light test","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":100,"wires":[["825395d1c0798abc"]]},{"id":"825395d1c0798abc","type":"api-call-service","z":"96dd39fdae667f20","name":"Notify Dan Phone","server":"2e31528c.f3973e","version":5,"debugenabled":false,"service":"mobile_app_dan_samsung","entityId":[],"data":"{\"message\":\"{{message}}\",\"title\":\"{{title}}\",\"data\":{\"actions\":[{\"action\":\"TURN_OFF_LIGHT\",\"title\":\"Set\"},{\"action\":\"IGNORE_LIGHT\",\"title\":\"Ignore\"}],\"persistent\":true,\"tag\":\"persistent\"}}","dataType":"json","mustacheAltTags":false,"x":950,"y":100,"wires":[[]]},{"id":"f8127f4fe83a9869","type":"server-events","z":"96dd39fdae667f20","name":"All Mobile App Notification Actions","server":"2e31528c.f3973e","event_type":"mobile_app_notification_action","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"x":220,"y":180,"wires":[["c454db84e01eb54a"]]},{"id":"c454db84e01eb54a","type":"switch","z":"96dd39fdae667f20","name":"","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"TURN_OFF_LIGHT","vt":"str"},{"t":"eq","v":"IGNORE_LIGHT","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":180,"wires":[["cfa74a72b91007e8"],[]]},{"id":"cfa74a72b91007e8","type":"api-call-service","z":"96dd39fdae667f20","name":"Turn off LIght","server":"2e31528c.f3973e","version":5,"debugenabled":false,"service":"turn_off","entityId":["light.office_light"],"data":"","dataType":"jsonata","mustacheAltTags":false,"x":610,"y":180,"wires":[["66dfbb89cd2e482a"]]},{"id":"66dfbb89cd2e482a","type":"api-current-state","z":"96dd39fdae667f20","name":"Is the light off?","server":"2e31528c.f3973e","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.office_light","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":860,"y":180,"wires":[["00baa760c0814417"],["144285fe99c71b29"]]},{"id":"144285fe99c71b29","type":"delay","z":"96dd39fdae667f20","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1020,"y":240,"wires":[["66dfbb89cd2e482a"]]},{"id":"00baa760c0814417","type":"change","z":"96dd39fdae667f20","name":"Set Title and Message","rules":[{"t":"set","p":"message","pt":"msg","to":"Light is turned off","tot":"str"},{"t":"set","p":"title","pt":"msg","to":"Office light","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1140,"y":180,"wires":[["ea8c051ca30cc83b"]]},{"id":"ea8c051ca30cc83b","type":"api-call-service","z":"96dd39fdae667f20","name":"Notify Dan Phone (Priority)","server":"2e31528c.f3973e","version":5,"debugenabled":false,"service":"mobile_app_dan_samsung","entityId":[],"data":"{\"message\":\"{{message}}\",\"title\":\"{{title}}\",\"data\":{\"channel\":\"Alarm\",\"priority\":\"high\",\"ttl\":0}}","dataType":"json","mustacheAltTags":false,"x":1400,"y":180,"wires":[[]]},{"id":"dfcd16f4a2fa1495","type":"inject","z":"96dd39fdae667f20","name":"","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":470,"y":100,"wires":[["ca1ee58e8537e8e9"]]}]